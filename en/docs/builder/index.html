<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design in Python: A Build Manager</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design in Python</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../tester/">
      A Testing Framework
    </a>
  </li>
  
  <li>
    <a href="../interpreter/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../backup/">
      Versioned File Backups
    </a>
  </li>
  
  <li>
    <a href="../cache/">
      A File Cache
    </a>
  </li>
  
  <li>
    <a href="../persistence/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Storage
    </a>
  </li>
  
  <li>
    <a href="../builder/">
      <strong>A Build Manager</strong>
    </a>
  </li>
  
  <li>
    <a href="../templating/">
      A Static Site Generator
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../server/">
      A Web Server
    </a>
  </li>
  
  <li>
    <a href="../matching/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parser/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../linter/">
      A Style Checker
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../packman/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../dataframe/">
      A Dataframe
    </a>
  </li>
  
  <li>
    <a href="../database/">
      A Database
    </a>
  </li>
  
  <li class="todo">
    <a href="../pipeline/">
      A Pipeline Runner
    </a>
  </li>
  
  <li class="todo">
    <a href="../editor/">
      An Editor
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 8: A Build Manager</h1>


          
            
  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">Build managers track dependencies between files and update files that are stale.</li>
  
  <li markdown="1">Every build rule has a target, some dependencies, and a recipe for updating the target.</li>
  
  <li markdown="1">Build rules form a directed graph which must not contain cycles.</li>
  
  <li markdown="1">Pattern rules describe the dependencies and recipes for sets of similar files.</li>
  
  <li markdown="1">Pattern rules can use automatic variables to specify targets and dependencies in recipes.</li>
  
  </ul>
  

  

  

  

  

  

  

  

  

  

  

  

  

  


            
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#affordance" markdown="1">affordance</a>, <a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variable</a>, <a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a>, <a class="gl-ref" href="../glossary/#build_recipe" markdown="1">build recipe</a>, <a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rule</a>, <a class="gl-ref" href="../glossary/#csv" markdown="1">comma-separated values</a>, <a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled language</a>, <a class="gl-ref" href="../glossary/#dependency" markdown="1">dependency (in build)</a>, <a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a>, <a class="gl-ref" href="../glossary/#dry_run" markdown="1">dry run</a>, <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensibility</a>, <a class="gl-ref" href="../glossary/#json" markdown="1">JavaScript Object Notation</a>, <a class="gl-ref" href="../glossary/#link" markdown="1">link (a program)</a>, <a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rule (in build)</a>, <a class="gl-ref" href="../glossary/#phony_target" markdown="1">phony target</a>, <a class="gl-ref" href="../glossary/#refactor" markdown="1">refactor</a>, <a class="gl-ref" href="../glossary/#regression" markdown="1">regression</a>, <a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale (in build)</a>, <a class="gl-ref" href="../glossary/#build_target" markdown="1">target (in build)</a>, <a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological order</a>, <a class="gl-ref" href="../glossary/#yaml" markdown="1">Yet Another Markup Language</a>
</p>


            <div class="page-toc"></div>
            <p>We wrote programs in <a class="x-ref" href="../interpreter/">Chapter 3</a> as lists of lists
which we then interpreted directly.
Programs in <span class="ix-entry" ix-key="compiled language;language!compiled" markdown="1"><a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled languages</a></span>
like <span class="ix-entry" ix-key="C" markdown="1">C</span> and <span class="ix-entry" ix-key="Java" markdown="1">Java</span>,
on the other hand,
have to be translated into lower-level forms before they can run.
There are usually two stages to the translation:
compiling each source file into some intermediate form,
and then <span class="ix-entry" ix-key="linking (compiled language);compiled language!linking" markdown="1"><a class="gl-ref" href="../glossary/#link" markdown="1">linking</a></span> the compiled modules
to each other and to libraries
to create a runnable program
(<a class="fig-ref" href="../builder/#builder-compiling">Figure 8.1</a>).
If a source file hasn&rsquo;t changed,
we don&rsquo;t need to recompile it before linking.
Skipping unnecessary work in this way can save a lot of time
when we are working with programs that contains thousands or tens of thousands of files.</p>
<figure id="builder-compiling">
  <img src="./builder_compiling.svg" alt="Compiling and linking"/>
  <figcaption markdown="1">Figure 8.1: Compiling source files and linking the resulting modules.</figcaption>
</figure>

<p><span class="ix-entry" ix-key="build manager" markdown="1"><a class="gl-ref" href="../glossary/#build_manager" markdown="1">Build managers</a></span>
were invented to keep track of all of this automatically.
A build manager takes a description of what depends on what,
figures out which files are out of date,
determines an order in which to rebuild things,
and then does whatever is required and only what is required <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Smith2011">Smith2011</a>]</span>.
The first build manager,
<span class="ix-entry" ix-key="Make" markdown="1"><a href="https://www.gnu.org/software/make/">Make</a></span>,
was built to manage C programs,
but build managers are used to update packages,
regenerate websites (<a class="x-ref" href="../templating/">Chapter 9</a>),
re-create documentation from source code,
and run tests.
This chapter creates a simple build manager to illustrate how they work.</p>
<h2 id="builder-structure">Section 8.1: Structure</h2>
<p>The input to a build manager is
a set of <span class="ix-entry" ix-key="build rule;rule!build" markdown="1"><a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rules</a></span>,
each of which has:</p>
<ul>
<li>
<p>a <span class="ix-entry" ix-key="build target;target!build" markdown="1"><a class="gl-ref" href="../glossary/#build_target" markdown="1">target</a></span>,
    which is the file to be updated;</p>
</li>
<li>
<p>some <span class="ix-entry" ix-key="dependency (in build);build!dependency" markdown="1"><a class="gl-ref" href="../glossary/#dependency" markdown="1">dependencies</a></span>,
    which are the things that file depends on;
    and</p>
</li>
<li>
<p>a <span class="ix-entry" ix-key="recipe (in build);build!recipe" markdown="1"><a class="gl-ref" href="../glossary/#build_recipe" markdown="1">recipe</a></span>
    that specifies how to update the target
    if it is out of date compared to its dependencies.</p>
</li>
</ul>
<p>The target of one rule can be a dependency of another rule,
so their relationships form a <span class="ix-entry" ix-key="directed acyclic graph (DAG);DAG" markdown="1"><a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a></span>
(<a class="fig-ref" href="../builder/#builder-dependencies">Figure 8.2</a>).
The graph is directed because &ldquo;A depends on B&rdquo; is a one-way relationship,
while &ldquo;acyclic&rdquo; means it cannot contains loops:
if something depends on itself we can never finish updating it.</p>
<figure id="builder-dependencies">
  <img src="./builder_dependencies.svg" alt="Respecting dependencies"/>
  <figcaption markdown="1">Figure 8.2: How a build manager finds and respects dependencies.</figcaption>
</figure>

<p>We say that a target is <span class="ix-entry" ix-key="stale (in build);build!stale" markdown="1"><a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale</a></span>
if it is older than any of its dependencies.
When this happens,
we use the recipes to bring it up to date.
Our build manager therefore must:</p>
<ol>
<li>
<p>Read a file containing rules.</p>
</li>
<li>
<p>Construct the dependency graph.</p>
</li>
<li>
<p>Figure out which targets are stale.</p>
</li>
<li>
<p>Build those targets,
    making sure to build things <em>before</em> anything that depends on them is built.</p>
</li>
</ol>
<div class="callout">
<h3>Topological order</h3>
<p>A <span class="ix-entry" ix-key="topological order" markdown="1"><a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological ordering</a></span> of a graph
arranges the nodes so that every node comes after everything it depends on.
For example,
if A depends on both B and C,
then (B, C, A) and (C, B, A) are both valid topological orders of the graph.</p>
</div>
<h2 id="builder-rules">Section 8.2: Representing Rules</h2>
<p>We will store our rules in <a class="gl-ref" href="../glossary/#yaml" markdown="1">YAML</a> files like this:</p>
<div class="code-sample lang-yml" title="three_simple_rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  - C
  recipes:
  - &quot;update A from B and C&quot;
- target: B
  depends:
  - C
  recipes:
  - &quot;update B from C&quot;
- target: C
  depends: []
  recipes: []
</code></pre></div>
</div>
<p class="continue">We could equally well have used <a class="gl-ref" href="../glossary/#json" markdown="1">JSON</a>,
but it wouldn&rsquo;t have made sense to use <a class="gl-ref" href="../glossary/#csv" markdown="1">CSV</a>:
rules have a nested structure,
and CSV doesn&rsquo;t represent nesting gracefully.</p>
<p>We would normally implement all of the builder&rsquo;s methods at once,
but we will instead write them them one by one to make the evolving code easier to follow.
Let&rsquo;s start by defining a class that loads a configuration file:</p>
<div class="code-sample lang-py" title="config_loader.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">yaml</span>

<span class="k">class</span> <span class="nc">ConfigLoader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules_file</span> <span class="o">=</span> <span class="n">rules_file</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;Configuration must be array&quot;</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We also need a method to check each rule because YAML is a generic file format
that doesn&rsquo;t know anything about the extra requirements of our rules:</p>
<div class="code-sample lang-py" title="config_loader.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check a single rule.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Rule </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2"> does not have &#39;target&#39;&quot;</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;depends&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">])</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Bad &#39;depends&#39; for rule </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;recipes&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;recipes&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;recipes&quot;</span><span class="p">])</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Bad &#39;recipes&#39; for rule </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
</div>
<p>The next step is to turn the configuration into a graph in memory.
We derive a class from <code>ConfigLoader</code> so that we can recycle the code we&rsquo;ve already written
and call a couple of methods that we are planning to add:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">config_loader</span> <span class="kn">import</span> <span class="n">ConfigLoader</span>
<span class="kn">from</span> <span class="nn">networkx.readwrite</span> <span class="kn">import</span> <span class="n">json_graph</span>

<span class="k">class</span> <span class="nc">GraphCreator</span><span class="p">(</span><span class="n">ConfigLoader</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We use the <a href="https://networkx.org/">networkx</a> module to manage nodes and links
rather than writing our own classes for graphs,
and store the recipe to rebuild a node in that node:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="n">recipes</span><span class="o">=</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;recipes&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
</code></pre></div>
</div>
<p><code>networkx</code> implements some common graph algorithms,
including one to find cycles,
so let&rsquo;s add that next:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">check_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Dependency graph contains cycles </span><span class="si">{</span><span class="n">cycles</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
</div>
<p>Finally,
we write a <code>__str__</code> method so we can see what we&rsquo;ve built:</p>
<div class="code-sample lang-py" title="graph_creator.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">json_graph</span><span class="o">.</span><span class="n">node_link_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">temp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="s2">&quot;links&quot;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
</div>
<p>When we run this with our three simple rules as input we get:</p>
<div class="code-sample lang-sh" title="graph_creator.sh">
<div class="highlight"><pre><span></span><code>python graph_creator.py three_simple_rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="graph_creator.out">
<div class="highlight"><pre><span></span><code>{
  &quot;nodes&quot;: [
    {
      &quot;recipes&quot;: [
        &quot;update A from B and C&quot;
      ],
      &quot;id&quot;: &quot;A&quot;
    },
    {
      &quot;recipes&quot;: [
        &quot;update B from C&quot;
      ],
      &quot;id&quot;: &quot;B&quot;
    },
    {
      &quot;recipes&quot;: [],
      &quot;id&quot;: &quot;C&quot;
    }
  ],
  &quot;links&quot;: [
    {
      &quot;source&quot;: &quot;B&quot;,
      &quot;target&quot;: &quot;A&quot;
    },
    {
      &quot;source&quot;: &quot;C&quot;,
      &quot;target&quot;: &quot;A&quot;
    },
    {
      &quot;source&quot;: &quot;C&quot;,
      &quot;target&quot;: &quot;B&quot;
    }
  ]
}
</code></pre></div>
</div>
<p>Let&rsquo;s write a quick test to make sure the cycle detector works as intended:</p>
<div class="code-sample lang-yml" title="circular_rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  recipes:
  - &quot;update A from B&quot;
- target: B
  depends:
  - A
  recipes:
  - &quot;update B from A&quot;
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="check_cycles.sh">
<div class="highlight"><pre><span></span><code>python graph_creator.py circular_rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="check_cycles.out">
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;/u/sdxpy/builder/graph_creator.py&quot;, line 46, in &lt;module&gt;
    builder.build()
  File &quot;/u/sdxpy/builder/graph_creator.py&quot;, line 12, in build
    self.check_cycles()
  File &quot;/u/sdxpy/builder/graph_creator.py&quot;, line 30, in check_cycles
    assert len(cycles) == 0, f&quot;Dependency graph contains cycles \
    {cycles}&quot;
AssertionError: Dependency graph contains cycles [[&#39;A&#39;, &#39;B&#39;]]
</code></pre></div>
</div>
<h2 id="builder-timestamp">Section 8.3: Stale Files</h2>
<p>The next step is to figure out which files are out of date.
Make does this by comparing the <span class="ix-entry" ix-key="timestamp!in build;build!timestamp" markdown="1">timestamps</span> of the files in question,
but this isn&rsquo;t always reliable:
<span class="ix-entry" ix-key="clock synchronization (in build);build!clock synchronization" markdown="1">computers&rsquo; clocks may be slightly out of sync</span>,
which can produce a wrong answer on a networked filesystem,
and the operating system may only report file update times to the nearest millisecond
(which seemed very short in 1970 but seems very long today).</p>
<p>More modern build systems store a <span class="ix-entry" ix-key="hash code!in build;build!hash code" markdown="1">hash</span> of each file&rsquo;s contents
and compare the current hash to the stored one to see if the file has changed.
We looked at hashing in <a class="x-ref" href="../backup/">Chapter 4</a>,
so we will use the timestamp approach here.
We should also test using a mock filesystem,
but for variety&rsquo;s sake
we will load another configuration file that specifies timestamps for files:</p>
<div class="code-sample lang-yml" title="add_timestamps.yml">
<div class="highlight"><pre><span></span><code>A: 2
B: 5
C: 8
</code></pre></div>
</div>
<p>Since we want to associate those timestamps with files,
we add steps to the constructor and the <code>build</code> method
to read the timestamp file and add information to the graph&rsquo;s nodes:</p>
<div class="code-sample lang-py" title="add_timestamps.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AddTimestamps</span><span class="p">(</span><span class="n">GraphCreator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules_file</span><span class="p">,</span> <span class="n">times_file</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rules_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times_file</span> <span class="o">=</span> <span class="n">times_file</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timestamps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">and then implement <code>add_timestamps</code>:</p>
<div class="code-sample lang-py" title="add_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">add_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">}</span> <span class="o">-</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">times</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Name(s) missing from times: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Before we move on,
let&rsquo;s make sure that adding timestamps works as we want:</p>
<div class="code-sample lang-sh" title="add_timestamps.sh">
<div class="highlight"><pre><span></span><code>python add_timestamps.py three_simple_rules.yml add_timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="add_timestamps.out">
<div class="highlight"><pre><span></span><code>{
  &quot;nodes&quot;: [
    {
      &quot;recipes&quot;: [
        &quot;update A from B and C&quot;
      ],
      &quot;timestamp&quot;: 2,
      &quot;id&quot;: &quot;A&quot;
    },
    {
      &quot;recipes&quot;: [
        &quot;update B from C&quot;
      ],
      &quot;timestamp&quot;: 5,
      &quot;id&quot;: &quot;B&quot;
    },
    {
      &quot;recipes&quot;: [],
      &quot;timestamp&quot;: 8,
      &quot;id&quot;: &quot;C&quot;
    }
  ],
  &quot;links&quot;: [
    {
      &quot;source&quot;: &quot;B&quot;,
      &quot;target&quot;: &quot;A&quot;
    },
    {
      &quot;source&quot;: &quot;C&quot;,
      &quot;target&quot;: &quot;A&quot;
    },
    {
      &quot;source&quot;: &quot;C&quot;,
      &quot;target&quot;: &quot;B&quot;
    }
  ]
}
</code></pre></div>
</div>
<h2 id="builder-update">Section 8.4: Updating Files</h2>
<p>To figure out which recipes to execute and in which order,
we set the pretended current time to the latest time of any file,
then look at each file in topological order.
If a file is older than any of its dependencies,
we update the file <em>and</em> its pretended timestamp
to trigger an update of anything that depends on it.
First,
we add a step to <code>build</code>:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">UpdateTimestamps</span><span class="p">(</span><span class="n">AddTimestamps</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timestamps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Next,
we implement the <code>run</code> method.
We can pretend that updating a file always takes one unit of time,
so we advance our fictional clock by one for each build.
Using <code>networkx.topological_sort</code> to create the topological order,
we get this:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_time</span><span class="si">}</span><span class="s2">: START&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">))):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stale</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
                <span class="n">current_time</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_time</span><span class="si">}</span><span class="s2">: END&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The <code>run</code> method:</p>
<ol>
<li>
<p>Gets a sorted list of nodes.</p>
</li>
<li>
<p>Sets the starting time to be one unit past the largest file time.</p>
</li>
<li>
<p>Checks each file in order.
    If that file is stale,
    we print the steps we would run and then update the file&rsquo;s timestamp.
    We only advance the notional current time when we do an update.</p>
</li>
</ol>
<p>To check if a file is stale,
we see if any of its dependencies currently have timestamps
greater than or equal to the target&rsquo;s timestamp:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">is_stale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<p>Our <code>update</code> method simply prints the actions it would take:</p>
<div class="code-sample lang-py" title="update_timestamps.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;recipes&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>When we run this,
it seems to do the right thing:</p>
<div class="code-sample lang-sh" title="update_timestamps.sh">
<div class="highlight"><pre><span></span><code>python update_timestamps.py three_simple_rules.yml add_timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="update_timestamps.out">
<div class="highlight"><pre><span></span><code>9: START
- A (9):
  - update A from B and C
- B (10):
  - update B from C
11: END
</code></pre></div>
</div>
<h2 id="builder-variables">Section 8.5: Variables</h2>
<p>We don&rsquo;t want to have to write a hundred nearly-identical recipes
if our program has a hundred files
or our website has a hundred blog posts.
Instead,
we want to write generic <span class="ix-entry" ix-key="build!rule;rule (in build)" markdown="1">build rules</span>.
To do this we need:</p>
<ul>
<li>
<p>a way to define a set of files;</p>
</li>
<li>
<p>a way to specify a generic rule;
    and</p>
</li>
<li>
<p>a way to fill in parts of that rule.</p>
</li>
</ul>
<p>We will achieve this by overriding <code>build_graph</code> to replace variables in recipes with values.
Once again,
object-oriented programming lets us change only what we need to,
provided we divided our problem into sensible chunks in the first place.</p>
<div class="callout">
<h3>Extensibility and Experience</h3>
<p><a class="x-ref" href="../interpreter/">Chapter 3</a> said that one way to evaluate a program&rsquo;s design
is to ask how <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensible</a> it is.
In practice,
extensibility usually comes from experience:
we can&rsquo;t know what <a class="gl-ref" href="../glossary/#affordance" markdown="1">affordances</a> to provide
until we&rsquo;ve tried extending our code in different ways a couple of times.
We <a class="gl-ref" href="../glossary/#refactor" markdown="1">refactored</a> the examples in this book several times
as we wrote the explanations
so that early versions left room for later ones.
Don&rsquo;t be surprised or disappointed if you have to do this for your own code;
after you&rsquo;ve extended and refactored something two or three times,
it usually settles down into its final form.</p>
</div>
<p>Make provides
<span class="ix-entry" ix-key="automatic variable (in build);build!automatic variable" markdown="1"><a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variables</a></span>
with cryptic names like <code>$&lt;</code> and <code>$@</code>
to represent the parts of a rule.
Our variables will be more readable:
we will use <code>@TARGET</code> for the target,
<code>@DEPENDENCIES</code> for the dependencies (in order),
and <code>@DEP[1]</code>, <code>@DEP[2]</code>, and so on for specific dependencies
(<a class="fig-ref" href="../builder/#builder-pattern-rules">Figure 8.3</a>).</p>
<figure id="builder-pattern-rules">
  <img src="./builder_pattern_rules.svg" alt="Pattern rules"/>
  <figcaption markdown="1">Figure 8.3: Turning patterns rules into runnable commands.</figcaption>
</figure>

<p>Our variable expander looks like this:</p>
<div class="code-sample lang-py" title="expand_variables.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">expand_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expand_one</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">expand_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="n">recipes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;recipes&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recipes</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">recipe</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@TARGET&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;@DEPENDENCIES&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@DEP[</span><span class="si">{</span><span class="nb">id</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;recipes&quot;</span><span class="p">][</span><span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>After adding this,
we immediately test that it works when there <em>aren&rsquo;t</em> any variables to expand
by running it on the same example we used previously:</p>
<div class="code-sample lang-sh" title="expand_variables_no_vars.sh">
<div class="highlight"><pre><span></span><code>python expand_variables.py three_simple_rules.yml add_timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="expand_variables_no_vars.out">
<div class="highlight"><pre><span></span><code>9: START
- A (9):
  - update A from B and C
- B (10):
  - update B from C
11: END
</code></pre></div>
</div>
<p class="continue">This is perhaps the most important reason to create tests:
they tell us if something we have added or changed
has caused a <a class="gl-ref" href="../glossary/#regression" markdown="1">regression</a>,
i.e., has broken something that used to work.
If so,
the problem will be easier to fix while
the breaking change is still fresh in our minds.</p>
<h2 id="builder-generic">Section 8.6: Generic Rules</h2>
<p>Now we need to add <span class="ix-entry" ix-key="pattern rule (in build);build!pattern rule" markdown="1"><a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rules</a></span>:
Our test rules file is:</p>
<div class="code-sample lang-yml" title="pattern_rules.yml">
<div class="highlight"><pre><span></span><code>- target: left.out
  depends: []
  recipes: []
- target: left.in
  depends: []
  recipes: []
- target: right.out
  depends: []
  recipes: []
- target: right.in
  depends: []
  recipes: []
- target: &quot;%.out&quot;
  depends:
  - &quot;%.in&quot;
  recipes:
  - &quot;update @TARGET from @DEPENDENCIES&quot;
</code></pre></div>
</div>
<p class="continue">and our first attempt at reading it extracts rules before expanding variables:</p>
<div class="code-sample lang-py" title="pattern_attempt.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PatternAttempt</span><span class="p">(</span><span class="n">ExpandVariables</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand_variables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timestamps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_cycles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">extract_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;recipes&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
</div>
<p>However,
it doesn&rsquo;t work:</p>
<div class="code-sample lang-sh" title="pattern_attempt.sh">
<div class="highlight"><pre><span></span><code>python pattern_attempt.py pattern_rules.yml pattern_times.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern_attempt.out">
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;/u/sdxpy/builder/pattern_attempt.py&quot;, line 32, in &lt;module&gt;
    builder.build()
  File &quot;/u/sdxpy/builder/pattern_attempt.py&quot;, line 8, in build
    self.extract_rules()
  File &quot;/u/sdxpy/builder/pattern_attempt.py&quot;, line 19, in extract_rules
    self.rules[target] = self.graph.nodes[target][&quot;recipes&quot;]
KeyError: &#39;recipes&#39;
</code></pre></div>
</div>
<p>After a bit of poking around with a <span class="ix-entry" ix-key="debugger" markdown="1">debugger</span>
we realize that
the failure occurs when we&rsquo;re looking at the rule for <code>%.in</code>.
When we create edges in the graph between a target and its dependencies,
<code>networkx</code> automatically adds a node for the dependency
if one didn&rsquo;t exist yet.
As a result,
when we say that <code>%.out</code> depends on <code>%.in</code>,
we wind up with a node for <code>%.in</code> that doesn&rsquo;t have any recipes.</p>
<p>We can fix our problem by changing the <code>build_graph</code> method
so that it saves pattern rules in a dictionary
and then builds the graph from the non-pattern rules:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">Expanding rules relies on two helper methods:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">expand_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rule</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_rule</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fill_in</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The first helper finds rules:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">find_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;%.</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and the second adds links and recipes to the graph:</p>
<div class="code-sample lang-py" title="pattern_final.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">fill_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="n">stem</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;recipes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;recipes&quot;</span><span class="p">]</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="n">stem</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">depends</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We&rsquo;re finally ready to test:</p>
<div class="code-sample lang-sh" title="pattern_final.sh">
<div class="highlight"><pre><span></span><code>python pattern_final.py pattern_rules.yml pattern_times.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern_final.out">
<div class="highlight"><pre><span></span><code>4: START
- right.out (4):
  - update left.out from left.in
- left.out (5):
  - update left.out from left.in
6: END
</code></pre></div>
</div>
<h2 id="builder-discuss">Section 8.7: Discussion</h2>
<p>Our design uses the <span class="ix-entry" ix-key="Template Method pattern;design pattern!Template Method" markdown="1">Template Method</span> pattern:
a method in a parent class defines the overall order of operations,
while child classes implement those operations without changing the flow of control.
We have added a lot of steps to our original template method,
which makes it a bit of a stretch to claim that the overall operation hasn&rsquo;t changed.
Knowing what we know now,
we could go back and modify the original <code>SkeletonBuilder.build</code> method
to include those extra steps and provide do-nothing implementations.</p>
<p>The root of the problem is that we didn&rsquo;t anticipate all the steps that would be involved
when we wrote our template method.
As we said earlier,
we typically have to refactor our base code
the first two or three times we try to extend it.
If it never settles down,
then Template Method is probably the wrong pattern for our situation.
Realizing this isn&rsquo;t a failure in initial design:
we always learn about our problem as we try to capture it in code,
and if we know enough to anticipate 100% of the issues that are going to come up,
it&rsquo;s time to put what we&rsquo;ve learned in a library for future use.</p>
<h2 id="builder-summary">Section 8.8: Summary</h2>
<figure id="builder-concept-map">
  <img src="./builder_concept_map.svg" alt="Concept map for build manager"/>
  <figcaption markdown="1">Figure 8.4: Concepts for build manager.</figcaption>
</figure>

<h2 id="builder-exercises">Section 8.9: Exercises</h2>
<h3 class="exercise">Reporting</h3>
<ol>
<li>
<p>Modify the build manager so that it expands all pattern rules
    and prints out a fully-expanded YAML build file.</p>
</li>
<li>
<p>Test your extension by having the build manager read and execute
    the file it just created.</p>
</li>
</ol>
<h3 class="exercise">Handle failure</h3>
<ol>
<li>
<p>Modify the build manager so that if a recipe fails,
    other targets that don&rsquo;t depend on it are still built.</p>
</li>
<li>
<p>Write tests to check that this change works correctly.</p>
</li>
</ol>
<h3 class="exercise">Dry run</h3>
<ol>
<li>
<p>Modify the build manager so that it can show what recipes it would execute
    without actually executing them.
    (Doing this is called a <a class="gl-ref" href="../glossary/#dry_run" markdown="1">dry run</a>.)</p>
</li>
<li>
<p>Write tests to make sure that dry runs don&rsquo;t change any files.</p>
</li>
</ol>
<h3 class="exercise">Merge files</h3>
<ol>
<li>
<p>Modify the build manager so that it can read multiple build files
    and execute their combined rules.</p>
</li>
<li>
<p>What does your solution do if two or more files specify rules
    for the same target?
    What does the <em>existing</em> code do?</p>
</li>
</ol>
<h3 class="exercise">Specific targets</h3>
<p>Modify the build manager so that users can specify
which targets they want to update.
The build manager should only execute recipes needed to update those targets.</p>
<h3 class="exercise">Phony targets</h3>
<p>A <a class="gl-ref" href="../glossary/#phony_target" markdown="1">phony target</a> is one that doesn&rsquo;t create or modify a file.
Programmers often put phony targets in build files
to do tasks like executing tests in a reproducible way.
Modify the build manager so that
users can specify and run phony targets.</p>
<h3 class="exercise">Conditional execution</h3>
<p>Modify the build manager so that:</p>
<ol>
<li>
<p>The user can pass <code>name=true</code> and <code>name=false</code> arguments on the command-line
    to define variables.</p>
</li>
<li>
<p>Rules can contain an <code>if: variable</code> field.</p>
</li>
<li>
<p>Those rules are only executed if the variable is defined and true.</p>
</li>
</ol>
<p>Write tests to check that this works correctly.</p>
<h3 class="exercise">Define filesets</h3>
<p>Modify the build manager so that users can define sets of files:</p>
<div class="highlight"><pre><span></span><code>fileset:
  name: everything
  contains:
    - X
    - Y
    - Z
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @everything
</code></pre></div>
<h3 class="exercise">Globbing</h3>
<p>Modify the build manager so that it can dynamically construct a set of files:</p>
<div class="highlight"><pre><span></span><code>glob:
  name: allAvailableInputs
  pattern: &quot;./*.in&quot;
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @allAvailableInputs
</code></pre></div>
<h3 class="exercise">Use hashes</h3>
<ol>
<li>
<p>Write a program called <code>build_init.py</code> that calculates a hash
    for every file mentioned in the build configuration
    and stores the hash along with the file&rsquo;s name in <code>build_hash.json</code>.</p>
</li>
<li>
<p>Modify the build manager to compare the current hashes of files
    with those stored in <code>build_hash.json</code>
    to determine what is out of date,
    and to update <code>build_hash.json</code> each time it runs.</p>
</li>
</ol>
          
        </main>
      </div>
    </div>
  </body>
</html>
