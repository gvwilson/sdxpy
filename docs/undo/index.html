<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>Software Design by Example &middot; Undo and Redo</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


  </head>
  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.routledge.com/Software-Design-by-Example-A-Tool-Based-Introduction-with-Python/Wilson/p/book/9781032725215"><img src="../sdxpy-cover.png" alt="Book cover" class="bookcover" /></a>
  
</p>

<div class="screen-reader-only">
  <a href="#printable">Skip to content</a>
</div>

<ol class="toc-chapters"><li><a href="../intro/">Introduction</a></li><li><a href="../oop/">Objects and Classes</a></li><li><a href="../dup/">Finding Duplicate Files</a></li><li><a href="../glob/">Matching Patterns</a></li><li><a href="../parse/">Parsing Text</a></li><li><a href="../test/">Running Tests</a></li><li><a href="../interp/">An Interpreter</a></li><li><a href="../func/">Functions and Closures</a></li><li><a href="../protocols/">Protocols</a></li><li><a href="../archive/">A File Archiver</a></li><li><a href="../check/">An HTML Validator</a></li><li><a href="../template/">A Template Expander</a></li><li><a href="../lint/">A Code Linter</a></li><li><a href="../layout/">Page Layout</a></li><li><a href="../perf/">Performance Profiling</a></li><li><a href="../persist/">Object Persistence</a></li><li><a href="../binary/">Binary Data</a></li><li><a href="../db/">A Database</a></li><li><a href="../build/">A Build Manager</a></li><li><a href="../pack/">A Package Manager</a></li><li><a href="../ftp/">Transferring Files</a></li><li><a href="../http/">Serving Web Pages</a></li><li><a href="../viewer/">A File Viewer</a></li><li><a href="../undo/">Undo and Redo</a></li><li><a href="../vm/">A Virtual Machine</a></li><li><a href="../debugger/">A Debugger</a></li><li><a href="../observe/">Observers</a></li><li><a href="../docgen/">Generating Documentation</a></li><li><a href="../search/">Search</a></li><li><a href="../compress/">File Compression</a></li><li><a href="../cache/">A File Cache</a></li><li><a href="../query/">A Query Builder</a></li><li><a href="../concur/">Concurrency</a></li><li><a href="../finale/">Conclusion</a></li></ol>
<ol class="toc-appendices"><li><a href="../bib/">Bibliography</a></li><li><a href="../bonus/">Bonus Material</a></li><li><a href="../syllabus/">Syllabus</a></li><li><a href="../license/">License</a></li><li><a href="../conduct/">Code of Conduct</a></li><li><a href="../contrib/">Contributing</a></li><li><a href="../glossary/">Glossary</a></li><li><a href="../colophon/">Colophon</a></li><li><a href="../contents/">Index</a></li></ol>


<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


<p><a href="https://github.com/gvwilson/sdxpy">GitHub repository</a></p>

      </div>
      <div id="printable" class="contents bordered">
	<main>
	  <div class="row notex">
  <div class="col-12 center">
    
      <h1>Undo and Redo</h1>
    
  </div>
</div>

	  
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../viewer/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../vm/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


	  <ul class="keypoints">
<li>Replace user interface components with mock objects to simplify testing.</li>
<li>Record actions and state to check behavior these mock objects.</li>
<li>Use objects to represent actions to record history and enable undo.</li>
<li>Recording state is easier but more expensive than recording changes.</li>
</ul>
	  <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#abstract_base_class" markdown="1">abstract base class</a>, <a class="gl-ref" href="../glossary/#command_pattern" markdown="1">Command pattern</a>, <a class="gl-ref" href="../glossary/#headless" markdown="1">headless application</a>
</p>
	  <p>Viewing text files is useful,
but we&rsquo;d like to be able to edit them as well.
This chapter therefore modifies the file viewer of <a href="../viewer/">Chapter&nbsp;23</a>
so that we can add and delete text.
And since people make mistakes,
we will also implement undo,
which will introduce another commonly-used design pattern.</p>
<h2 id="undo-start">Getting Started</h2>
<p>Our file viewer has four classes:</p>
<ul>
<li>
<p>A <code>Window</code> can draw lines and report its size.</p>
</li>
<li>
<p>A <code>Buffer</code> stores lines of text,
    keeps track of a <span class="ix-entry" ix-key="viewport" markdown="1">viewport</span>,
    and transforms buffer coordinates to screen coordinates.</p>
</li>
<li>
<p>A <code>Cursor</code> knows its position in
    the <span class="ix-entry" ix-key="buffer (of text)" markdown="1">buffer</span>
    and can move up, down, left, and right.</p>
</li>
<li>
<p>The <code>App</code> makes a window, a buffer, and a cursor,
    then maps keys to actions.</p>
</li>
</ul>
<p>To make unit testing simpler,
we start by adding one more class:
a replacement for the screen object provided by the <a href="https://docs.python.org/3/library/curses.html"><code>curses</code></a> module.
This class stores the current state of the display in a rectangular grid
so that our tests can check it easily.
It also takes a list of keystrokes as input
to simulate interaction with the user:</p>
<div class="language-py" title="headless.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HeadlessScreen</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">keystrokes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="n">keystrokes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_key</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getkey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_key</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;CONTROL_X&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i_key</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">addstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):]</span>
</code></pre></div>
</div>
<p class="continue">GUI applications that don&rsquo;t display anything
are often called <a class="gl-ref" href="../glossary/#headless" markdown="1">headless</a> applications.
Giving our simulated keystrokes to the screen seems odd—it would make more sense
for <code>App</code> to have a method that gets keystrokes—but
it&rsquo;s the simplest way to fit everything in beside
the classes we already have.</p>
<div class="callout">
<h3>Clean Exit</h3>
<p>Notice that when the screen runs out of simulated keystrokes
it produces <code>CONTROL_X</code>,
meaning &ldquo;exit the application&rdquo;.
We need this to break out of the keystroke-processing loop in the application,
and no,
we didn&rsquo;t think of this up front.</p>
</div>
<p>To finish this change,
we also need to define a <code>HeadlessWindow</code>
that takes a desired screen size and passes it to the screen:</p>
<div class="language-py" title="headless.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HeadlessWindow</span><span class="p">(</span><span class="n">Window</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Finally,
our new application class records keystrokes,
the cursor position,
and the screen contents for testing:</p>
<div class="language-py" title="headless.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HeadlessApp</span><span class="p">(</span><span class="n">App</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">display</span><span class="p">()))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">HeadlessWindow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We can now write tests like this:</p>
<div class="language-py" title="test_headless.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_scroll_down</span><span class="p">():</span>
    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;def&quot;</span><span class="p">,</span> <span class="s2">&quot;ghi&quot;</span><span class="p">]</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;KEY_DOWN&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">HeadlessScreen</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">HeadlessApp</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">app</span><span class="p">(</span><span class="n">screen</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">app</span><span class="o">.</span><span class="n">get_log</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;CONTROL_X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;gh&quot;</span><span class="p">])</span>
</code></pre></div>
</div>
<h2 id="undo-indel">Insertion and Deletion</h2>
<p>We are now ready to implement insertion and deletion.
The first step is to add methods to the buffer class
that update a line of text:</p>
<div class="language-py" title="insert_delete.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InsertDeleteBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">()</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]]</span> <span class="o">+</span> <span class="n">char</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">()</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span>
</code></pre></div>
</div>
<p class="continue">Notice that we delete the character <em>under</em> the cursor,
not the one to the left of the cursor:
this is delete-in-place rather than backspace-delete.
Notice also that we have done a little <span class="ix-entry" ix-key="defensive programming" markdown="1">defensive programming</span>
by checking that the coordinates given for the operation make sense.</p>
<p>The window, cursor, and screen don&rsquo;t need to change
to support insertion and deletion,
but the application class needs several updates.
The first is to define the set of characters that can be inserted,
which for our example will be letters and digits,
and to create a buffer of the appropriate kind:</p>
<div class="language-py" title="insert_delete.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InsertDeleteApp</span><span class="p">(</span><span class="n">HeadlessApp</span><span class="p">):</span>
    <span class="n">INSERTABLE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">InsertDeleteBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We also need to create handlers for insertion and deletion:</p>
<div class="language-py" title="insert_delete.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_do_DELETE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_INSERT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">(),</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Finally,
since we don&rsquo;t want to have to add one handler
for each insertable character,
let&rsquo;s write a <code>_get_key</code> method that returns a pair of values.
The first indicates the &ldquo;family&rdquo; of the key,
while the second is the actual key.
If the family is <code>None</code>,
the key is a special key with its own handler;
otherwise,
we look up the handler for the key&rsquo;s family:</p>
<div class="language-py" title="insert_delete.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INSERTABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">family</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">family</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">family</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_log</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We&rsquo;re going to write a lot of tests for this application,
so let&rsquo;s write a <span class="ix-entry" ix-key="helper function" markdown="1">helper function</span>
to create a <span class="ix-entry" ix-key="fixture" markdown="1">fixture</span>,
run the application,
and return it:</p>
<div class="language-py" title="test_insert_delete.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_fixture</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">HeadlessScreen</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">InsertDeleteApp</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">app</span><span class="p">(</span><span class="n">screen</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
</div>
<p>Our tests are now straightforward to set up and check:</p>
<div class="language-py" title="test_insert_delete.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_delete_middle</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">make_fixture</span><span class="p">([</span><span class="s2">&quot;KEY_RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;abc&quot;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">app</span><span class="o">.</span><span class="n">get_log</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;CONTROL_X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;ac_&quot;</span><span class="p">])</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Edge Case</h3>
<p>One of our tests uncovers the fact that
our application crashes if we try to delete a character
when the buffer is empty:</p>
<div class="language-py" title="test_insert_delete.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_delete_when_impossible</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">make_fixture</span><span class="p">([</span><span class="s2">&quot;DELETE&quot;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p class="continue">Our focus is implementing undo,
so we will leave fixing this for an exercise.</p>
</div>
<h2 id="undo-backward">Going Backward</h2>
<p>In order to undo things we have to:</p>
<ol>
<li>
<p>keep track of <em>actions</em> and reverse them, or</p>
</li>
<li>
<p>keep track of <em>state</em> and restore it.</p>
</li>
</ol>
<p>Recording actions can be trickier to implement
but requires less space than saving the entire state of the application
after each change,
so that&rsquo;s what most systems do.
The starting point is to append a record of every action to a log:</p>
<div class="language-py" title="history.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HistoryApp</span><span class="p">(</span><span class="n">InsertDeleteApp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">keystrokes</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">keystrokes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_DELETE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
        <span class="n">char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">char</span><span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">char</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
</code></pre></div>
</div>
<p>But what about undoing cursor movement?
If we add a character,
move to another location,
and then undo,
shouldn&rsquo;t the cursor go back to where it was before deleting the character?
And how are we going to interpret these log records?
Will we need a second dispatch method with its own handlers?</p>
<p>The common solution to these problems is to use
the <a class="gl-ref" href="../glossary/#command_pattern" markdown="1">Command</a> <span class="ix-entry" ix-key="design pattern" markdown="1">design pattern</span>.
This pattern turns verbs into nouns,
i.e.,
each action is represented as an object
with methods to go forward and backward.
Our actions all derive from an <a class="gl-ref" href="../glossary/#abstract_base_class" markdown="1">abstract base class</a>
so that they can be used interchangeably.
That base class is:</p>
<div class="language-py" title="action.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Action</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: do&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: undo&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The <span class="ix-entry" ix-key="child class" markdown="1">child classes</span> for insertion and deletion are:</p>
<div class="language-py" title="action.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Insert</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_char</span> <span class="o">=</span> <span class="n">char</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_char</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="language-py" title="action.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Delete</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">char</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_char</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We could implement one class for each direction of cursor movement,
but instead choose to create a single class:</p>
<div class="pagebreak"></div>

<div class="language-py" title="action.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Move</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="p">)</span>
</code></pre></div>
</div>
<p>This class records the new cursor position as well as the old one
to make debugging easier.
It depends on adding two new methods to <code>Cursor</code>
to move in a particular direction by name
(e.g., &ldquo;right&rdquo; or &ldquo;left&rdquo;)
and to move to a particular location:</p>
<div class="language-py" title="cursor.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">)()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">move_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Our application&rsquo;s <code>_interact</code> method changes too.
Instead of relying on keystroke handler methods to do things,
it expects them to create action objects
(<a class="fig-ref" href="../undo/#undo-verbs">Figure&nbsp;24.1</a>).
These objects are appended to the application&rsquo;s history,
and then asked to do whatever they do:</p>
<div class="language-py" title="action.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">family</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">family</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">family</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">action</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">do</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_log</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
</div>
<figure id="undo-verbs" class="here">
<img src="./verbs.svg" alt="Nouns as verbs in the Command pattern"/>
<figcaption>Figure&nbsp;24.1: Representing actions as objects in the Command design pattern.</figcaption>
</figure>

<p class="continue">Note that we have modified all the handler methods
to take the keystroke as an input argument
so that we don&rsquo;t have to distinguish between
cases where it&rsquo;s needed and cases where it isn&rsquo;t.
This simplifies the code a little
at the expense of introducing unused parameters into
the handlers for special keys like cursor movement.</p>
<p>Finally,
each handler method now builds an object and returns it:</p>
<div class="language-py" title="action.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_do_DELETE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_INSERT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">(),</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_KEY_UP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>With all these changes in place,
our application <em>almost</em> works.
We add an <code>_do_UNDO</code> handler that pops the most recent action from the history
and calls its <code>undo</code> method.
When we test this,
though,
we wind up in an infinite loop because
we are appending the action to the history before doing the action,
so we are essentially undoing our undo forever.
The solution is to modify the base class <code>Action</code> to have a <code>.save</code> method
that tells the application whether or not to save this action.
The default implementation returns <code>True</code>,
but we override it in <code>Undo</code> to return <code>False</code>:</p>
<div class="language-py" title="undoable.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Undo</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">action</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Undo(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div>
</div>
<p>Note that popping the most recent action off the history stack
only works once we modify the application&rsquo;s <code>_interact</code> method
so that it only saves actions that ought to be saved:</p>
<div class="language-py" title="undoable.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UndoableApp</span><span class="p">(</span><span class="n">ActionApp</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">family</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">family</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">family</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">action</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">do</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">save</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_log</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We can now write tests like this to check that we can insert a character,
undo the action,
and get back the screen we originally had:</p>
<div class="language-py" title="test_undoable.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_insert_undo</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">make_fixture</span><span class="p">([</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;UNDO&quot;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">get_screen</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;ab&quot;</span><span class="p">,</span> <span class="s2">&quot;cd&quot;</span><span class="p">]</span>
</code></pre></div>
</div>
<h2 id="undo-summary">Summary</h2>
<p><a class="fig-ref" href="../undo/#undo-concept-map">Figure&nbsp;24.2</a> summarizes the concepts introduced in this chapter.
Real text editors (even simple ones) obviously have many more features,
but we have now seen most of the key ideas.</p>
<figure id="undo-concept-map" class="here">
<img src="./concept_map.svg" alt="Concept map of undo"/>
<figcaption>Figure&nbsp;24.2: Concept map.</figcaption>
</figure>

<h2 id="undo-exercises">Exercises</h2>
<h3 class="exercise">Combining Movement</h3>
<p>Modify the application so that successive movement operations are combined
into a single undo step.</p>
<h3 class="exercise">Forgetting Moves</h3>
<p>Most editors do not save cursor movements in their undo history.
Modify the code in this chapter so that undo only works on
changes to the content being edited.</p>
<h3 class="exercise">Limiting History</h3>
<p>Modify the application so that only the most recent hundred operations can be undone.</p>
<h3 class="exercise">Breaking Lines</h3>
<p>Modify the code so that pressing the Enter key inserts a new line
or breaks the current line in two.
What information do you have to store to make this operation undoable?</p>
<h3 class="exercise">Redoing Operations</h3>
<p>Implement a &ldquo;redo&rdquo; command that re-executes an operation that has been undone.
How does redo differ from undoing an undo?
Does it make sense to redo an action that wasn&rsquo;t done?</p>
<h3 class="exercise">Repeating Operations</h3>
<ol>
<li>
<p>Implement a command to repeat the most recent operation.</p>
</li>
<li>
<p>How should repeated operations be represented in the application&rsquo;s history?</p>
</li>
</ol>
<h3 class="exercise">Saving Operations</h3>
<p>Use the ideas of <a href="../persist/">Chapter&nbsp;16</a> to save operations to a file and reload them
so that users can resume editing sessions.</p>
	</main>
	<footer>
  © 2025 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sdxpy">repository</a>
  &middot;
  <a href="../license/">license</a>
  &middot;
  <a href="mailto:gvwilson@third-bit.com">contact</a>
</footer>

      </div>
    </div>
  </body>
</html>
