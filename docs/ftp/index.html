<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>Software Design by Example &middot; Transferring Files</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


  </head>
  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.routledge.com/Software-Design-by-Example-A-Tool-Based-Introduction-with-Python/Wilson/p/book/9781032725215"><img src="../sdxpy-cover.png" alt="Book cover" class="bookcover" /></a>
  
</p>

<div class="screen-reader-only">
  <a href="#printable">Skip to content</a>
</div>

<ol class="toc-chapters"><li><a href="../intro/">Introduction</a></li><li><a href="../oop/">Objects and Classes</a></li><li><a href="../dup/">Finding Duplicate Files</a></li><li><a href="../glob/">Matching Patterns</a></li><li><a href="../parse/">Parsing Text</a></li><li><a href="../test/">Running Tests</a></li><li><a href="../interp/">An Interpreter</a></li><li><a href="../func/">Functions and Closures</a></li><li><a href="../protocols/">Protocols</a></li><li><a href="../archive/">A File Archiver</a></li><li><a href="../check/">An HTML Validator</a></li><li><a href="../template/">A Template Expander</a></li><li><a href="../lint/">A Code Linter</a></li><li><a href="../layout/">Page Layout</a></li><li><a href="../perf/">Performance Profiling</a></li><li><a href="../persist/">Object Persistence</a></li><li><a href="../binary/">Binary Data</a></li><li><a href="../db/">A Database</a></li><li><a href="../build/">A Build Manager</a></li><li><a href="../pack/">A Package Manager</a></li><li><a href="../ftp/">Transferring Files</a></li><li><a href="../http/">Serving Web Pages</a></li><li><a href="../viewer/">A File Viewer</a></li><li><a href="../undo/">Undo and Redo</a></li><li><a href="../vm/">A Virtual Machine</a></li><li><a href="../debugger/">A Debugger</a></li><li><a href="../observe/">Observers</a></li><li><a href="../docgen/">Generating Documentation</a></li><li><a href="../search/">Search</a></li><li><a href="../compress/">File Compression</a></li><li><a href="../cache/">A File Cache</a></li><li><a href="../query/">A Query Builder</a></li><li><a href="../concur/">Concurrency</a></li><li><a href="../finale/">Conclusion</a></li></ol>
<ol class="toc-appendices"><li><a href="../bib/">Bibliography</a></li><li><a href="../bonus/">Bonus Material</a></li><li><a href="../syllabus/">Syllabus</a></li><li><a href="../license/">License</a></li><li><a href="../conduct/">Code of Conduct</a></li><li><a href="../contrib/">Contributing</a></li><li><a href="../glossary/">Glossary</a></li><li><a href="../colophon/">Colophon</a></li><li><a href="../contents/">Index</a></li></ol>


<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


<p><a href="https://github.com/gvwilson/sdxpy">GitHub repository</a></p>

      </div>
      <div id="printable" class="contents bordered">
	<main>
	  <div class="row notex">
  <div class="col-12 center">
    
      <h1>Transferring Files</h1>
    
  </div>
</div>

	  
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../pack/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../http/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


	  <ul class="keypoints">
<li>Every computer on a network has a unique IP address.</li>
<li>The Domain Name System (DNS) translates human-readable names into IP addresses.</li>
<li>Programs send and receive messages through numbered sockets.</li>
<li>The program that receives a message is responsible for interpreting the bytes in the message.</li>
<li>To test programs that rely on the network, replace the network with a mock object that simulates message transmission and receipt.</li>
</ul>
	  <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#client" markdown="1">client</a>, <a class="gl-ref" href="../glossary/#deadlock" markdown="1">deadlock</a>, <a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System</a>, <a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol</a>, <a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a>, <a class="gl-ref" href="../glossary/#port" markdown="1">port</a>, <a class="gl-ref" href="../glossary/#server" markdown="1">server</a>, <a class="gl-ref" href="../glossary/#socket" markdown="1">socket</a>, <a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol</a>, <a class="gl-ref" href="../glossary/#test_fidelity" markdown="1">test fidelity</a>
</p>
	  <p>The Internet is simpler than most people realize
(as well as being more complex than anyone could possibly comprehend).
Most systems still follow the rules they did 30 years ago;
in particular,
most web servers still handle the same kinds of messages in the same way.</p>
<p>A typical web application is made up of <a class="gl-ref" href="../glossary/#client" markdown="1">clients</a>
and <a class="gl-ref" href="../glossary/#server" markdown="1">servers</a>.
A client program initiates communication by sending a message and waiting for a response;
a server,
on the other hand,
waits for requests and then replies to them.
There are typically many more clients than servers:
for example,
there may be hundreds or thousands of browsers
fetching pages from this book&rsquo;s website right now,
but there is only one server handling those requests.</p>
<p>This chapter shows how to build a simple low-level network program
to move files from one machine to another.
<a href="../http/">Chapter&nbsp;22</a> will extend this to show
how to build programs that communicate using HTTP.
A central concern in both chapters is how to test such programs;
while <em>who</em> sends <em>what</em> messages <em>when</em> changes from application to application,
the testing techniques largely remain the same.</p>
<h2 id="ftp-tcpip">Using TCP/IP</h2>
<p>Almost every program on the web
uses a family of communication standards called
<a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol</a> (IP).
The one that concerns us is the
<a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol</a> (TCP/IP),
which makes communication between computers look like reading and writing files.
Programs using IP communicate through <a class="gl-ref" href="../glossary/#socket" markdown="1">sockets</a>
(<a class="fig-ref" href="../ftp/#ftp-sockets">Figure&nbsp;21.1</a>).
Each socket is one end of a point-to-point communication channel,
just like a phone is one end of a phone call.
A socket consists of an <a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a>
that identifies a particular machine
and a <a class="gl-ref" href="../glossary/#port" markdown="1">port</a> on that machine.</p>
<figure id="ftp-sockets">
<img src="./sockets.svg" alt="Sockets, IP addresses, and DNS"/>
<figcaption>Figure&nbsp;21.1: How sockets, IP addresses, and DNS work together.</figcaption>
</figure>

<p>The IP address consists of four 8-bit numbers,
which are usually written as <code>93.184.216.34</code>;
the <a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System</a> (DNS)
matches these numbers to symbolic names like <code>example.com</code>
that are easier for human beings to remember.
A port is a number in the range 0-65535
that uniquely identifies the socket on the host machine.
(If an IP address is like a company&rsquo;s phone number,
then a port number is like an extension.)
Ports 0-1023 are reserved for well-known TCP/IP applications like web servers;
custom applications should use the remaining ports
(and should allow users to decide <em>which</em> port,
since there&rsquo;s always the chance that two different people will pick 1234 or 6789).</p>
<p>A basic socket client looks like this:</p>
<div class="language-py" title="client_all.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>

<span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;message text&quot;</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client sent </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

<span class="n">received</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
<span class="n">received_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">received</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">received</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes: &#39;</span><span class="si">{</span><span class="n">received_str</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">We call it &ldquo;basic&rdquo; rather than &ldquo;simple&rdquo; because there&rsquo;s a lot going on here.
From top to bottom:</p>
<ol>
<li>We import some modules and define two constants.
    The first, <code>SERVER_ADDRESS</code>,
    consists of a host identifier and a port.
    (The string <code>"localhost"</code> means &ldquo;the current machine&rdquo;.)
    The second,
    <code>CHUNK_SIZE</code>,
    will determine the maximum number of bytes in the messages we send and receive.</li>
<li>We use <code>socket.socket</code> to create a new socket.
    The values <code>AF_INET</code> and <code>SOCK_STREAM</code> specify
    the <span class="ix-entry" ix-key="protocol" markdown="1">protocols</span> we&rsquo;re using;
    we&rsquo;ll always use those in our examples,
    so we won&rsquo;t go into detail about alternatives.</li>
<li>We connect to the server,
    send our message as a bunch of bytes with <code>sock.sendall</code>,
    and print a message saying the data&rsquo;s been sent.</li>
<li>We then read up to a kilobyte from the socket with <code>sock.recv</code>.
    If we were expecting longer messages,
    we&rsquo;d keep reading from the socket until there was no more data.</li>
<li>Finally, we print another message.</li>
</ol>
<div class="pagebreak"></div>

<p>The corresponding server has just as much low-level detail:</p>
<div class="language-py" title="server_raw.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>

<span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handler</span><span class="p">():</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">),</span> <span class="mi">8080</span>
    <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="n">server_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

    <span class="n">server_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection from </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">),</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;got request from </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># [main]</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">handler</span><span class="p">()</span>
<span class="c1"># [/main]</span>
</code></pre></div>
</div>
<p class="continue">This code claims a socket,
listens until it receives a single connection request,
reads up to a kilobyte of data,
prints a message,
and replies to the client.
<a class="fig-ref" href="../ftp/#ftp-interaction">Figure&nbsp;21.2</a> shows the order of operations and messages
when we run the client and server in separate terminal windows.</p>
<figure id="ftp-interaction">
<img src="./interaction.svg" alt="Client-server interaction"/>
<figcaption>Figure&nbsp;21.2: Steps and messages in client-server interaction.</figcaption>
</figure>

<p>There&rsquo;s a <em>lot</em> going on here,
so most people who have to program at this level
use Python&rsquo;s <a href="https://docs.python.org/3/library/socketserver.html"><code>socketserver</code></a> module,
which provides two things:
a class called <code>TCPServer</code> that manages incoming connections
and another class called <code>BaseRequestHandler</code>
that does everything <em>except</em> process the incoming data.
In order to do that,
we derive a class of our own from <code>BaseRequestHandler</code>
that provides a <code>handle</code> method
(<a class="fig-ref" href="../ftp/#ftp-inheritance">Figure&nbsp;21.3</a>).
Every time <code>TCPServer</code> gets a new connection,
it creates a new object of our class
and calls that object&rsquo;s <code>handle</code> method.</p>
<figure id="ftp-inheritance">
<img src="./inheritance.svg" alt="Classes in a TCP server"/>
<figcaption>Figure&nbsp;21.3: Classes used in a basic TCP server.</figcaption>
</figure>

<div class="pagebreak"></div>

<p>Using <code>TCPServer</code> and <code>BaseRequestHandler</code> as starting points,
our server is:</p>
<div class="language-py" title="server_lib.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">socketserver</span>

<span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;got request from </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">,</span> <span class="n">MyHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">These two classes use a different design than what we&rsquo;ve seen before.
Instead of creating one class for programmers to extend,
the <code>socketserver</code> module puts the low-level details in <code>TCPServer</code>,
which can be used as-is,
and asks users to create a plug-in class from <code>BaseRequestHandler</code>
for the server to use.
This approach isn&rsquo;t intrinsically better or worse than
the &ldquo;derive and override&rdquo; approach we&rsquo;ve seen before;
they&rsquo;re just two more tools in a software designer&rsquo;s toolbox.</p>
<h2 id="ftp-chunk">Chunking</h2>
<p>Our latest server reads data exactly once
using <code>self.request.recv(CHUNK_SIZE)</code>
with <code>CHUNK_SIZE</code> set to 1024.
If the client sends more than a kilobyte of data,
our server will ignore it.
This can result in <a class="gl-ref" href="../glossary/#deadlock" markdown="1">deadlock</a>:
the server is trying to send a reply
while the client is trying to send the rest of the message,
and since neither is listening,
neither can move forward.
Increasing the size of the <span class="ix-entry" ix-key="buffer (in memory)" markdown="1">memory buffer</span>
used to store the incoming message
won&rsquo;t make this problem go away:
the client (or a malicious attacker) could always send more data
than we have allowed for.</p>
<p>Instead,
we need to modify the server so that it keeps reading data
until there is nothing left to read.
Each time the <code>handle</code> method shown below goes around the loop,
it tries to read another kilobyte.
If it gets that much,
it appends it to <code>data</code> and tries again.
If it gets less than a kilobyte,
we have reached the end of the transmission
and can return the result:</p>
<div class="pagebreak"></div>

<div class="language-py" title="server_chunk.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FileHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;server about to start receiving&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;...server received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">latest</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CHUNK_SIZE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...server breaking&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;server finished received, about to reply&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
</code></pre></div>
</div>
<p>We can modify the client to send data in chunks as well,
but we handle this a little differently.
Each call to <code>conn.send</code> in the function below
tries to send all of the remaining data.
The value returned by the function call tells us
how many bytes were actually sent.
If that number gets us to the end of the data we&rsquo;re sending,
the function can exit the loop.
If not,
it adds the number of bytes sent to <code>total</code>
so that it knows where to start sending
the next time around:</p>
<div class="language-py" title="client_chunk.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">send_file</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client sending </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">total</span><span class="p">:])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;...client sent </span><span class="si">{</span><span class="n">sent</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">sent</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;...client total now </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total</span>
</code></pre></div>
</div>
<p>While we&rsquo;re here,
we might as well write a function to create a socket:</p>
<div class="language-py" title="client_chunk.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_socket</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conn</span>
</code></pre></div>
</div>
<p class="continue">and another to wait for the acknowledgment from the server:</p>
<div class="language-py" title="client_chunk.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">receive_ack</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="n">received</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">received</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
</code></pre></div>
</div>
<p class="continue">The main program is then:</p>
<div class="language-py" title="client_chunk.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">make_socket</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">send_file</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client main sent </span><span class="si">{</span><span class="n">bytes_sent</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
    <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">receive_ack</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client main received </span><span class="si">{</span><span class="n">bytes_received</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">bytes_sent</span> <span class="o">==</span> <span class="n">bytes_received</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="pagebreak"></div>

<p>When we run the client and server,
the client prints:</p>
<div class="language-out" title="client_chunk.out">
<div class="highlight"><pre><span></span><code>client sending 1236 bytes
...client sent 1236 bytes
...client total now 1236 bytes
client main sent 1236 bytes
client main received 1236 bytes
True
</code></pre></div>
</div>
<p class="continue">and the server prints</p>
<div class="language-out" title="server_chunk.out">
<div class="highlight"><pre><span></span><code>server about to start receiving
...server received 1024 bytes
...server received 212 bytes
...server breaking
server finished received, about to reply
</code></pre></div>
</div>
<h2 id="ftp-test">Testing</h2>
<p>Testing single-process command-line applications is hard enough.
To test a client-server application like the one above,
we have to start the server,
wait for it to be ready,
then run the client,
and then shut down the server if it hasn&rsquo;t shut down by itself.
It&rsquo;s easy to do this interactively,
but automating it is difficult because
there&rsquo;s no way to tell how long to wait before trying to talk to the server
and no easy way to shut the server down.</p>
<p>A partial solution is to use a <span class="ix-entry" ix-key="mock object" markdown="1">mock object</span> (<a href="../protocols/">Chapter&nbsp;9</a>)
in place of a real network connection
so that we can test each part of the application independently.
To start,
let&rsquo;s <span class="ix-entry" ix-key="refactor" markdown="1">refactor</span> our server&rsquo;s <code>handle</code> method
so that it calls <code>self.debug</code> instead of printing directly:</p>
<div class="language-py" title="logging_handler.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LoggingHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;server about to start receiving&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;...server received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">latest</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">BLOCK_SIZE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;...server breaking&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;server finished received, about to reply&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
</code></pre></div>
</div>
<p class="continue">The <code>debug</code> method takes any number of arguments and passes them to <code>print</code>:</p>
<div class="language-py" title="logging_handler.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The <code>handle</code> method in this class relies on
the <code>self.request</code> object created by the framework
to send and receive data.
We can create a testable server by deriving a class from <code>LoggingHandler</code>
that inherits the <code>handle</code> method (which we want to test)
but creates a mock <code>request</code> object
and overrides the <code>debug</code> method so it doesn&rsquo;t print logging messages:</p>
<div class="language-py" title="test_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MockHandler</span><span class="p">(</span><span class="n">LoggingHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">MockRequest</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p class="continue">Notice that we <em>don&rsquo;t</em> call the <span class="ix-entry" ix-key="constructor" markdown="1">constructor</span> of <code>LoggingHandler</code>
in the constructor of <code>MockHandler</code>.
If we did,
we would trigger a call to the constructor of <code>BaseRequestHandler</code>,
which would then be upset because we haven&rsquo;t defined a host or a port.</p>
<p>The class we use to create our mock <code>request</code> object needs three things:</p>
<ol>
<li>
<p>A constructor that records the data we&rsquo;re going to pretend
    to have received over a socket
    and does whatever other setup is needed.</p>
</li>
<li>
<p>A <code>recv</code> method with the same signature as the real object&rsquo;s <code>recv</code> method.</p>
</li>
<li>
<p>A <code>sendall</code> method whose signature matches that of the real thing as well.</p>
</li>
</ol>
<p>The whole class is:</p>
<div class="language-py" title="test_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MockRequest</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sent</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">:</span><span class="n">top</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">top</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sendall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outgoing</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outgoing</span><span class="p">)</span>
</code></pre></div>
</div>
<p>With it, we can now write unit tests like this:</p>
<div class="language-py" title="test_server.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_short</span><span class="p">():</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">MockHandler</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">handle</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_sent</span> <span class="o">==</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)]</span>
</code></pre></div>
</div>
<p>The key to our approach is the notion of <a class="gl-ref" href="../glossary/#test_fidelity" markdown="1">fidelity</a>:
how close is what we test to what we use in production?
In an ideal world they are exactly the same,
but in cases like this it makes sense to sacrifice a little fidelity for testability&rsquo;s sake.</p>
<h2 id="ftp-summary">Summary</h2>
<p><a class="fig-ref" href="../ftp/#ftp-concept-map">Figure&nbsp;21.4</a> summarizes the idea introduces in this chapter.
While understanding how to send data over a network is important,
knowing how to test programs that interact with the outside world
is just as important.</p>
<figure id="ftp-concept-map" class="here">
<img src="./concept_map.svg" alt="File transfer concept map"/>
<figcaption>Figure&nbsp;21.4: File transfer concept map.</figcaption>
</figure>

<h2 id="ftp-exercises">Exercises</h2>
<h3 class="exercise">Chunk Sizes</h3>
<p>What happens if the client tries to send zero bytes to the server?
What happens if it sends exactly <code>CHUNK_SIZE</code> bytes or <code>CHUNK_SIZE+1</code> bytes?</p>
<h3 class="exercise">Efficiency</h3>
<p>Suppose a client sends \( N \) chunks of data to a server.
The current implementation will copy the first chunk \( N-1 \) times,
the second chunk \( N-2 \) times, and so on,
so that the total copying work is \( O(N^2) \).
Modify the server so that it collects chunks in a list
and concatenates them at the end instead.</p>
<h3 class="exercise">Saving and Listing Files</h3>
<ol>
<li>
<p>Modify the <span class="ix-entry" ix-key="protocol" markdown="1">protocol</span> used by this chapter&rsquo;s client and server
    so that the client sends the file&rsquo;s name, a newline, and then the file&rsquo;s contents,
    and the server saves the file under that name.</p>
</li>
<li>
<p>Modify the protocol again so that the client can send the word <code>dir</code>
    followed by a newline and no other data
    and the server will send back a list of the files in its current working directory.</p>
</li>
</ol>
<h3 class="exercise">A Socket Client Class</h3>
<p>Build a <code>socketclient</code> class that works like the <code>socketserver</code> class
but sends data instead of handling requests.
How useful is it in practice?</p>
	</main>
	<footer>
  © 2025 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sdxpy">repository</a>
  &middot;
  <a href="../license/">license</a>
  &middot;
  <a href="mailto:gvwilson@third-bit.com">contact</a>
</footer>

      </div>
    </div>
  </body>
</html>
