<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <title>Software Design in Python: A Pipeline Runner</title>
</head>

  <body>
    <div class="row">
      <div class="column">
        <p>
  <img src="../logo.svg" alt="site logo" width="10%" />
  <a href="../">Software Design in Python</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../tester/">
      A Testing Framework
    </a>
  </li>
  
  <li>
    <a href="../backup/">
      Versioned File Backups
    </a>
  </li>
  
  <li>
    <a href="../interpreter/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../dataframe/">
      A Dataframe
    </a>
  </li>
  
  <li class="todo">
    <a href="../pipeline/">
      <strong>A Pipeline Runner</strong>
    </a>
  </li>
  
  <li>
    <a href="../builder/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../matching/">
      Matching Regular Expressions
    </a>
  </li>
  
  <li>
    <a href="../parser/">
      Parsing Regular Expressions
    </a>
  </li>
  
  <li>
    <a href="../server/">
      A Web Server
    </a>
  </li>
  
  <li class="todo">
    <a href="../filecache/">
      A File Cache
    </a>
  </li>
  
  <li class="todo">
    <a href="../database/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../persistence/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Storage
    </a>
  </li>
  
  <li>
    <a href="../templating/">
      HTML Templating
    </a>
  </li>
  
  <li class="todo">
    <a href="../packman/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li class="todo">
    <a href="../linter/">
      A Style Checker
    </a>
  </li>
  
  <li class="todo">
    <a href="../docgen/">
      A Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../codegen/">
      A Code Generator
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine and Assembler
    </a>
  </li>
  
  <li class="todo">
    <a href="../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../links/">
      Links
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

      </div>
      <div class="column bordered todo">
        <main>
	  
  <h1>Chapter 6: A Pipeline Runner</h1>


          
  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">FIXME</li>
  
  </ul>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


	  
  

  

  
  <p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#decorator" markdown="1">decorator</a>, <a class="gl-ref" href="../glossary/#overlay_configuration" markdown="1">overlay configuration</a>, <a class="gl-ref" href="../glossary/#provenance" markdown="1">provenance</a>
  </p>
  

  

  

  

  

  

  

  

  

  

  


          <p>Data science is all the rage these days.
No one can agree on exactly what it is,
but everyone's definition includes processing large datasets.
Data scientists usually do this with pipelines
that apply several operations to the data one after another.
In order to automate, share, and check their work,
they want the processing steps to be reproducible:
someone else,
somewhere else,
ought to be able to re-run the exact same steps
without consulting the original author.</p>
<p>This chapter builds a small toolkit for running pipelines
that is easy to extend
and that automatically records the <a class="gl-ref" href="../glossary/#provenance" markdown="1">provenance</a>
of each output.
Since this isn't a book about data science,
we will use common text processing operations in our examples.
Please feel free to replace them with complicated mathematics.</p>
<h2 id="pipeline-list">Section 6.1: Pipelines as Lists</h2>
<p>Suppose we have five functions:</p>
<ul>
<li><code>read(filename)</code> reads a CSV file and returns a list of rows,
   each of which is a list of values.</li>
<li><code>head(data, num)</code> returns the first <code>num</code> rows of a dataset.</li>
<li><code>tail(data, num)</code> returns the last <code>num</code> rows.</li>
<li><code>left(data, num)</code> and <code>right(data, num)</code> return
    the first and last <code>num</code> columns of the data respectively.</li>
</ul>
<p>We can combine these functions in two ways.
The first uses nested function calls:</p>
<div class="highlight"><pre><span></span><code><span class="n">left</span><span class="p">(</span><span class="n">tail</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;sample_data.csv&quot;</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<p class="continue">but this quickly becomes hard to read.
(Quick, is the 10 being passed to <code>head</code> or to <code>tail</code>?)
The second uses temporary variables:</p>
<div class="highlight"><pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s2">&quot;sample_data.csv&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">head</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">tail</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">left</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<p class="continue">which is easier to read when there are more than a handful of stages,
but can be error-prone.
(Did you notice that the code above is passing <code>frame</code> to <code>tail</code>
instead of <code>data</code>?)</p>
<p>But a function is just another kind of object,
so we can put it in a list along with its arguments like this:</p>
<div class="code-sample lang-py" title="direct_list.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">functions</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">read</span><span class="p">,</span> <span class="s2">&quot;sample_data.csv&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="n">head</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="p">[</span><span class="n">tail</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="p">]</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">):</span>
    <span class="n">func</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="pipeline-config">Section 6.2: Configuration</h2>
<p>Every function remembers the name it was given when it was defined:</p>
<div class="code-sample lang-py" title="func_name.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">proof</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nb">print</span><span class="p">(</span><span class="n">proof</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_name.out">
<div class="highlight"><pre><span></span><code>proof
</code></pre></div>
</div>
<p class="continue">so we can convert a list of functions into a lookup table:</p>
<div class="code-sample lang-py" title="func_table.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">functions</span> <span class="kn">import</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span>

<span class="k">def</span> <span class="nf">make_table</span><span class="p">(</span><span class="o">*</span><span class="n">functions</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">}</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_table.out">
<div class="highlight"><pre><span></span><code>{&#39;left&#39;: &lt;function left at 0x10f938310&gt;, &#39;right&#39;: &lt;function right at 0x10f9383a0&gt;}
</code></pre></div>
</div>
<p>We should therefore be able to construct a pipeline
from a YAML file like this
without needing a long set of <code>if</code> statements
to match names to functions:</p>
<div class="code-sample lang-yml" title="pipeline_manual.yml">
<div class="highlight"><pre><span></span><code>- name: read
  params:
  - sample_data.csv
- name: head
  params:
  - 10
- name: tail
  params:
  - 5
- name: left
  params:
  - 2
</code></pre></div>
</div>
<p>The code that runs the steps described in this pipeline
creates the lookup table
and then calls each stage with the given parameters:</p>
<div class="code-sample lang-py" title="pipeline_manual.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="o">*</span><span class="n">functions</span><span class="p">):</span>
    <span class="n">functions</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">functions</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>
</div>
<h2 id="pipeline-collect">Section 6.3: Collecting Functions</h2>
<p>Our <code>pipeline</code> function works,
but the call to it isn't any prettier
than the nested function calls we set out to replace:</p>
<div class="code-sample lang-py" title="pipeline_manual.py">
<div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">read</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We could move the line that turns a list of functions into a dictionary
out of <code>pipeline</code>
and require the user to build that lookup table for us,
but there's a cleaner way.
Let's define a <a class="gl-ref" href="../glossary/#decorator" markdown="1">decorator</a>
that adds a function to a lookup table:</p>
<div class="code-sample lang-py" title="decorated.py">
<div class="highlight"><pre><span></span><code><span class="n">EXPORTS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">EXPORTS</span>
    <span class="n">EXPORTS</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">func</span>
</code></pre></div>
</div>
<p class="continue">We can then use this decorator
to mark the functions that we want to make available
to the pipeline:</p>
<div class="code-sample lang-py" title="decorated.py">
<div class="highlight"><pre><span></span><code><span class="nd">@export</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">reader</span><span class="p">)]</span>

<span class="nd">@export</span>
<span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">num</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">and then in our pipeline code
we can import the <code>EXPORTS</code> table
(renaming it to make its purpose a little clearer):</p>
<div class="code-sample lang-py" title="pipeline_decorated.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">decorated</span> <span class="kn">import</span> <span class="n">EXPORTS</span> <span class="k">as</span> <span class="n">functions</span>
</code></pre></div>
</div>
<p class="continue">The call to <code>pipeline</code> is then:</p>
<div class="code-sample lang-py" title="pipeline_decorated.py">
<div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">functions</span><span class="p">)</span>
</code></pre></div>
</div>
<p>If we want to make functions from many files
available to our pipeline,
we'll have to merge their exported dictionaries.
We'll explore this in the exercises.</p>
<h2 id="pipeline-provenance">Section 6.4: Configuration and Provenance</h2>
<p>Our modified pipeline also doesn't allow for any global configuration
(i.e., parameters that are shared between stages)
and doesn't keep a record of what it actually did.
We will tackle these problems together.</p>
<p>First,
we want to be able to pass some global parameters to all stages of the pipeline
as well as local (per-stage) parameters.
When we're done,
our configuration file will like this:</p>
<div class="code-sample lang-yml" title="pipeline_global.yml">
<div class="highlight"><pre><span></span><code>overall:
  debug: true
pipeline:
  - name: read
    params:
    - sample_data.csv
  - name: head
    params:
    - 10
  - name: tail
    params:
    - 5
  - name: left
    params:
    - 2
</code></pre></div>
</div>
<p>We don't want our generic <code>pipeline</code> function
to have to know about the functions it runs,
so let's modify all of the latter to take optional arguments
as shown below:</p>
<div class="code-sample lang-py" title="generic.py">
<div class="highlight"><pre><span></span><code><span class="nd">@export</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">reader</span><span class="p">)]</span>

<span class="nd">@export</span>
<span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">num</span><span class="p">]</span>
</code></pre></div>
</div>
<p>Our revised <code>pipeline</code> function is now:</p>
<div class="code-sample lang-py" title="pipeline_global.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">functions</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
    <span class="n">overall</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overall&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">functions</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">overall</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">overall</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>
</div>
<p>We also want to know what each run of a pipeline actually did.
Let's rewrite the runner to create a list of provenance records:</p>
<div class="code-sample lang-py" title="pipeline_provenance.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">functions</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
    <span class="n">overall</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overall&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">provenance</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">functions</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">overall</span><span class="p">)</span>
        <span class="n">provenance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">provenance</span>
</code></pre></div>
</div>
<p>The <code>run</code> function finds and runs the requested function,
then records its name,
its parameters,
how long it took to execute,
and how big its output was:</p>
<div class="code-sample lang-py" title="pipeline_provenance.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">overall</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">func_name</span><span class="p">,</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span>
    <span class="p">}</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">functions</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">overall</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">overall</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span>

<span class="k">def</span> <span class="nf">data_size</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="k">else</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
</code></pre></div>
</div>
<p>If we run this and dump the provenance record as YAML we get:</p>
<div class="code-sample lang-out" title="pipeline_provenance.out">
<div class="highlight"><pre><span></span><code>- name: read
  params:
  - sample_data.csv
  size:
  - 15
  - 10
  time: 8.511543273925781e-05
- name: head
  params:
  - 10
  size:
  - 10
  - 10
  time: 1.9073486328125e-06
- name: tail
  params:
  - 5
  size:
  - 5
  - 10
  time: 9.5367431640625e-07
- name: left
  params:
  - 2
  size:
  - 5
  - 2
  time: 4.0531158447265625e-06
</code></pre></div>
</div>
<p>Let's come back to configuration.
Right now we have put everything for our pipeline in one self-contained file,
but in real situations our pipelines will probably share a lot of settings.
Many large applicatons allow up to four layers of configuration:</p>
<ol>
<li>
<p>A system-wide configuration file for general settings.</p>
</li>
<li>
<p>A user-specific configuration file for personal preferences.</p>
</li>
<li>
<p>A job-specific file with settings for a particular run.</p>
</li>
<li>
<p>Command-line options to change things that commonly change.</p>
</li>
</ol>
<p>This is sometimes called <a class="gl-ref" href="../glossary/#overlay_configuration" markdown="1">overlay configuration</a>
because each level overrides the ones before it.
It's more complex that our example needs,
but is worth building to see how it's done:</p>
<div class="code-sample lang-py" title="load_config.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="n">ENV_VAR</span> <span class="o">=</span> <span class="s2">&quot;MCCOLE_CONFIG&quot;</span>
<span class="n">HOME</span> <span class="o">=</span> <span class="s2">&quot;HOME&quot;</span>
<span class="n">CONFIG_FILE</span> <span class="o">=</span> <span class="s2">&quot;.mccole&quot;</span>

<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_load_system</span><span class="p">()</span> <span class="o">|</span> <span class="n">load_user</span><span class="p">()</span> <span class="o">|</span> <span class="n">_load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_load_system</span><span class="p">():</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">ENV_VAR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_load_file</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">if</span> <span class="n">var</span> <span class="k">else</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">_load_user</span><span class="p">():</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">HOME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">home</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="n">CONFIG_FILE</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">_load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="pipeline-exercises">Section 6.5: Exercises</h2>
<h3>Merging functions</h3>
<p>Modify the pipeline code so that it can load runnable functions from many different files.
What should you do if two or more files export functions with the same names?</p>
<h3>Error handling</h3>
<p>Our pipeline doesn't catch exceptions or do any other error handling.
Modify it so that it does.</p>
        </main>
      </div>
    </div>
  </body>
</html>
