<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>Software Design by Example &middot; A Build Manager</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>


  </head>
  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.routledge.com/Software-Design-by-Example-A-Tool-Based-Introduction-with-Python/Wilson/p/book/9781032725215"><img src="../sdxpy-cover.png" alt="Book cover" class="bookcover" /></a>
  
</p>

<div class="screen-reader-only">
  <a href="#printable">Skip to content</a>
</div>

<ol class="toc-chapters"><li><a href="../intro/">Introduction</a></li><li><a href="../oop/">Objects and Classes</a></li><li><a href="../dup/">Finding Duplicate Files</a></li><li><a href="../glob/">Matching Patterns</a></li><li><a href="../parse/">Parsing Text</a></li><li><a href="../test/">Running Tests</a></li><li><a href="../interp/">An Interpreter</a></li><li><a href="../func/">Functions and Closures</a></li><li><a href="../protocols/">Protocols</a></li><li><a href="../archive/">A File Archiver</a></li><li><a href="../check/">An HTML Validator</a></li><li><a href="../template/">A Template Expander</a></li><li><a href="../lint/">A Code Linter</a></li><li><a href="../layout/">Page Layout</a></li><li><a href="../perf/">Performance Profiling</a></li><li><a href="../persist/">Object Persistence</a></li><li><a href="../binary/">Binary Data</a></li><li><a href="../db/">A Database</a></li><li><a href="../build/">A Build Manager</a></li><li><a href="../pack/">A Package Manager</a></li><li><a href="../ftp/">Transferring Files</a></li><li><a href="../http/">Serving Web Pages</a></li><li><a href="../viewer/">A File Viewer</a></li><li><a href="../undo/">Undo and Redo</a></li><li><a href="../vm/">A Virtual Machine</a></li><li><a href="../debugger/">A Debugger</a></li><li><a href="../observe/">Observers</a></li><li><a href="../docgen/">Generating Documentation</a></li><li><a href="../cache/">A File Cache</a></li><li><a href="../orm/">Object-Relational Mapper</a></li><li><a href="../concur/">Concurrency</a></li><li><a href="../eventsim/">Discrete Event Simulator</a></li><li><a href="../finale/">Conclusion</a></li></ol>
<ol class="toc-appendices"><li><a href="../bib/">Bibliography</a></li><li><a href="../bonus/">Bonus Material</a></li><li><a href="../syllabus/">Syllabus</a></li><li><a href="../license/">License</a></li><li><a href="../conduct/">Code of Conduct</a></li><li><a href="../contrib/">Contributing</a></li><li><a href="../glossary/">Glossary</a></li><li><a href="../colophon/">Colophon</a></li><li><a href="../contents/">Index</a></li></ol>


<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


<p><a href="https://github.com/gvwilson/sdxpy">GitHub repository</a></p>

      </div>
      <div id="printable" class="contents bordered">
	<main>
	  <div class="row notex">
  <div class="col-12 center">
    
      <h1>A Build Manager</h1>
    
  </div>
</div>

	  
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../db/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../pack/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


	  <ul class="keypoints">
<li>Build managers track dependencies between files and update files that are stale.</li>
<li>Every build rule has a target, some dependencies, and a recipe for updating the target.</li>
<li>Build rules form a directed graph which must not contain cycles.</li>
<li>Pattern rules describe the dependencies and recipes for sets of similar files.</li>
<li>Pattern rules can use automatic variables to specify targets and dependencies in recipes.</li>
</ul>
	  <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#affordance" markdown="1">affordance</a>, <a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a>, <a class="gl-ref" href="../glossary/#build_recipe" markdown="1">build recipe</a>, <a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rule</a>, <a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale (in build)</a>, <a class="gl-ref" href="../glossary/#build_target" markdown="1">target (in build)</a>, <a class="gl-ref" href="../glossary/#circular_dependency" markdown="1">circular dependency</a>, <a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled language</a>, <a class="gl-ref" href="../glossary/#cycle" markdown="1">cycle</a>, <a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a>, <a class="gl-ref" href="../glossary/#dependency" markdown="1">dependency (in build)</a>, <a class="gl-ref" href="../glossary/#dry_run" markdown="1">dry run</a>, <a class="gl-ref" href="../glossary/#link" markdown="1">link (a program)</a>, <a class="gl-ref" href="../glossary/#phony_target" markdown="1">phony target</a>, <a class="gl-ref" href="../glossary/#stable_sort" markdown="1">stable sort</a>, <a class="gl-ref" href="../glossary/#template_method_pattern" markdown="1">Template Method pattern</a>, <a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological order</a>
</p>
	  <p>Suppose that <code>plot.py</code> produces <code>result.svg</code> from <code>collated.csv</code>,
that <code>collated.csv</code> is produced from <code>samples.csv</code> and <code>controls.csv</code> by <code>analyze.py</code>,
and that <code>samples.csv</code> depends on <code>normalize.py</code> and <code>raw.csv</code>.
If <code>raw.csv</code> changes we want to re-run all three programs;
if <code>controls.csv</code> changes,
on the other hand,
we only need to re-run the analysis and plotting programs.
If we try to manage this ourselves we will inevitably make mistakes.
Instead,
we should use a <a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a>
to keep track of which files depend on which
and what actions to take to create or update files.
This chapter shows how a simple build manager works;
along the way,
it introduces some algorithms for working with graphs.</p>
<h2 id="build-concepts">Concepts</h2>
<p>The first build manager,
<a href="https://www.gnu.org/software/make/">Make</a>,
was written by a student intern at Bell Labs in the 1970s.
Many others now exist (such as <a href="https://www.scons.org/">SCons</a> and <a href="https://snakemake.readthedocs.io/">Snakemake</a>),
but they all perform the same basic operations.
If a <a class="gl-ref" href="../glossary/#build_target" markdown="1">target</a> is <a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale</a>
with respect to any of its  <a class="gl-ref" href="../glossary/#dependency" markdown="1">dependencies</a>,
the build manager runs a <a class="gl-ref" href="../glossary/#build_recipe" markdown="1">recipe</a> to refresh it.</p>
<p>The build manager runs recipes in an order that respects dependencies,
and it only runs each recipe once (if at all).
In order for this to be possible,
targets and dependencies must form a <a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a>,
i.e.,
there cannot be a <a class="gl-ref" href="../glossary/#cycle" markdown="1">cycle</a> of links
leading from a <span class="ix-entry" ix-key="node" markdown="1">node</span> back to itself.
The build manager constructs
a <a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological ordering</a> of that <span class="ix-entry" ix-key="graph" markdown="1">graph</span>,
i.e.,
arranges nodes so that each one comes after everything it depends on
and then builds what it needs to in that order
(<a class="fig-ref" href="../build/#build-dependencies">Figure&nbsp;19.1</a>).</p>
<figure id="build-dependencies">
<img src="./dependencies.svg" alt="Dependencies in a four-node graph"/>
<figcaption>Figure&nbsp;19.1: Dependencies and topological order.</figcaption>
</figure>

<div class="callout">
<h3>A Bit of History</h3>
<p>Make was created to manage programs in <a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled languages</a>
like <span class="ix-entry" ix-key="C" markdown="1">C</span> and <span class="ix-entry" ix-key="Java" markdown="1">Java</span>,
which have to be translated into lower-level forms before they can run.
There are usually two stages to the translation:
compiling each source file into some intermediate form,
and then <a class="gl-ref" href="../glossary/#link" markdown="1">linking</a> the compiled modules
to each other and to libraries
to create a runnable program.
If a source file hasn&rsquo;t changed,
we don&rsquo;t need to recompile it before linking.
Skipping unnecessary work in this way can save a lot of time
when we are working with programs that contain thousands or tens of thousands of files.</p>
</div>
<h2 id="build-design">Initial Design</h2>
<p>Our first step is to decide how we are going to represent
<a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rules</a>.
We could invent a special-purpose syntax to fit the problem,
but as we said in <a href="../parse/">Chapter&nbsp;5</a>,
the world has enough data formats.
Instead,
we will represent our recipes as <span class="ix-entry" ix-key="JSON" markdown="1">JSON</span>.
For example,
this file describes two targets <code>A</code> and <code>B</code>
and states that the former depends on the latter:</p>
<div class="language-json" title="double_linear_dep.json">
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;A&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build A&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;B&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build B&quot;</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>As in <a href="../archive/">Chapter&nbsp;10</a>,
we will use <span class="ix-entry" ix-key="successive refinement" markdown="1">successive refinement</span>
to create our first build manager.
Our <code>BuildBase</code> class takes a configuration file as a constructor argument,
loads it,
creates a topological ordering,
and then refreshes each target in order.
For now,
&ldquo;refreshing&rdquo; means &ldquo;prints the update rule&rdquo;;
we will come back and make this more sophisticated later.</p>
<div class="language-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BuildBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topo_sort</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;rule&quot;</span><span class="p">])</span>
</code></pre></div>
</div>
<p>To load a configuration file,
we read in the JSON,
build a set of known targets,
and then verify each rule using a helper method called <code>_check</code>:</p>
<div class="language-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="n">known</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">known</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">To check a rule,
we make sure the dictionary that represents it has the required keys
and that we have a rule for every dependency it mentions.
We also transform the rule&rsquo;s structure a bit to simplify later processing
(<a class="fig-ref" href="../build/#build-diamond">Figure&nbsp;19.2</a>):</p>
<div class="language-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="k">assert</span> <span class="s2">&quot;rule&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing rule for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;depends&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">depends</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">known</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;Unknown depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;rule&quot;</span><span class="p">],</span> <span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="n">depends</span><span class="p">}</span>
</code></pre></div>
</div>
<figure id="build-diamond">
<img src="./diamond.svg" alt="Representing graph"/>
<figcaption>Figure&nbsp;19.2: Representing dependency graph.</figcaption>
</figure>

<div class="callout">
<h3>It&rsquo;s Not Extra Work</h3>
<p>We have to implement the consistency checks for our build rules
because JSON is a generic format
that knows nothing about dependencies, rules, and required keys.
There is a format called <a href="https://json-schema.org/">JSON Schema</a> for specifying these things
and <a href="https://python-jsonschema.readthedocs.io/">a Python module</a> that implements its checks,
but using it here would trade seven lines of code
for 10 minutes of explanation.
We will explore its use in the exercises,
but the most important point is that
whether we write code by hand
or use a library with a bit of configuration,
<em>someone</em> has to write these checks.</p>
</div>
<h2 id="build-sort">Topological Sorting</h2>
<p>The next step is to figure out a safe order in which to build things.
<a class="fig-ref" href="../build/#build-topo-sort">Figure&nbsp;19.3</a> shows how our algorithm works:</p>
<ol>
<li>
<p>We find all the nodes in the dependency graph
    that don&rsquo;t have any outstanding dependencies.</p>
</li>
<li>
<p>We append those to the result
    and then remove them from the dependencies of all the other nodes in the graph.</p>
</li>
<li>
<p>If anything is still in the graph,
    we go back to the first step.</p>
</li>
<li>
<p>If at any point the graph isn&rsquo;t empty but nothing is available,
    we have found a <a class="gl-ref" href="../glossary/#circular_dependency" markdown="1">circular dependency</a>,
    so we report the problem and fail.</p>
</li>
</ol>
<figure id="build-topo-sort">
<img src="./topo_sort.svg" alt="Trace of topological sorting"/>
<figcaption>Figure&nbsp;19.3: Topological Sort.</figcaption>
</figure>

<p>The code that implements this algorithm is:</p>
<div class="language-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_topo_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">config</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">graph</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]}</span>
            <span class="k">assert</span> <span class="n">available</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Circular graph </span><span class="si">{</span><span class="n">graph</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">n</span><span class="p">:</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">available</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>With all of this in place,
we can run our first test:</p>
<div class="language-json" title="double_linear_dep.json">
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;A&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build A&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;B&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build B&quot;</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="language-out" title="double_linear_dep.out">
<div class="highlight"><pre><span></span><code>build B
build A
</code></pre></div>
</div>
<h2 id="build-better">A Better Design</h2>
<p>Our implementation works,
but we can do better:</p>
<ol>
<li>
<p>The configuration might not come directly from a JSON file—for example,
    it might be embedded in a larger file or generated by another program—so
    we should modify the constructor to take a configuration as input.</p>
</li>
<li>
<p>Printing actions to the screen isn&rsquo;t very useful,
    so we should collect them and return an ordered list of
    the commands for the build manager.</p>
</li>
<li>
<p><code>assert</code> isn&rsquo;t a friendly way to handle user errors;
    we should raise <code>ValueError</code> (or a custom exception of our own)
    to indicate a problem.</p>
</li>
<li>
<p>Our topological sort isn&rsquo;t <a class="gl-ref" href="../glossary/#stable_sort" markdown="1">stable</a>,
    i.e.,
    there&rsquo;s no way to predict the order in which two &ldquo;equal&rdquo; nodes
    will be added to the ordering.
    We will explore the reason for this in the exercises,
    but for now,
    we should sort node names when appending to the <code>result</code> list
    so that our tests can know what to check for.</p>
</li>
<li>
<p>We might want to add other keys to rules,
    so we should put that check in a separate method that we can override.</p>
</li>
</ol>
<p>The top level of our better build manager looks like this:</p>
<div class="language-py" title="build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BuildBetter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topo_sort</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">actions</span>

    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;rule&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_must</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The revised configuration code is:</p>
<div class="language-py" title="build_better.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">known</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">known</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_keys</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span>
            <span class="n">depends</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">known</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Unknown depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">depends</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_check_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing rule for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span>
            <span class="s2">&quot;depends&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and the updated topological sorting method is</p>
<div class="language-py" title="build_better.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_topo_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">config</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">graph</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span>
                <span class="n">available</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Circular graph </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">n</span><span class="p">:</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">available</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>We can now test that the code detects circularities in the dependency graph:</p>
<div class="language-py" title="test_build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_circular</span><span class="p">():</span>
    <span class="n">action_A</span> <span class="o">=</span> <span class="s2">&quot;build A&quot;</span>
    <span class="n">action_B</span> <span class="o">=</span> <span class="s2">&quot;build B&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_A</span><span class="p">},</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_B</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Builder</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;should have had exception&quot;</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p class="continue">and that it builds what it&rsquo;s supposed to:</p>
<div class="language-py" title="test_build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_no_dep</span><span class="p">():</span>
    <span class="n">action_A</span> <span class="o">=</span> <span class="s2">&quot;build A&quot;</span>
    <span class="n">action_B</span> <span class="o">=</span> <span class="s2">&quot;build B&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_A</span><span class="p">},</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_B</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="n">Builder</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="n">action_A</span><span class="p">,</span> <span class="n">action_B</span><span class="p">]</span>
</code></pre></div>
</div>
<p>We can also extend it.
For example,
suppose we only want to update targets that are older than their dependencies
(which is, after all, the whole point of a build manager).
If the targets are actual files we can check their <span class="ix-entry" ix-key="timestamp" markdown="1">timestamps</span>,
but for testing purposes
we would like to specify pretended times in the configuration:</p>
<div class="language-py" title="test_build_time.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_diamond_dep</span><span class="p">():</span>
    <span class="n">action_A</span> <span class="o">=</span> <span class="s2">&quot;build A&quot;</span>
    <span class="n">action_B</span> <span class="o">=</span> <span class="s2">&quot;build B&quot;</span>
    <span class="n">action_C</span> <span class="o">=</span> <span class="s2">&quot;build C&quot;</span>
    <span class="n">action_D</span> <span class="o">=</span> <span class="s2">&quot;build D&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_A</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_B</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_C</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_D</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="n">Builder</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="n">action_B</span><span class="p">,</span> <span class="n">action_A</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">Starting from the class we have written so far,
we need to override three methods:</p>
<div class="language-py" title="build_time.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BuildTime</span><span class="p">(</span><span class="n">BuildBetter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_check_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_check_keys</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span><span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;No time for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_update</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;rule&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<div class="callout">
<h3>How We Actually Did It</h3>
<p>Our final design uses
the <a class="gl-ref" href="../glossary/#template_method_pattern" markdown="1">Template Method</a> pattern:
a method in a <span class="ix-entry" ix-key="parent class" markdown="1">parent class</span> defines the <span class="ix-entry" ix-key="control flow" markdown="1">control flow</span>,
while <span class="ix-entry" ix-key="child class" markdown="1">child classes</span> implement those operations.
We didn&rsquo;t know in advance exactly
how to divide our code into methods;
instead,
as we were creating a class that loaded and used timestamps,
we reorganized the parent class
to create the <a class="gl-ref" href="../glossary/#affordance" markdown="1">affordances</a> we needed.
Software design almost always works this way:
the first two or three times we try to extend something,
we discover changes that would make those tasks easier.
We should do less of this as time goes by:
if we are still doing large-scale <span class="ix-entry" ix-key="refactor" markdown="1">refactoring</span>
the tenth time we use something,
we should rethink our entire design.</p>
</div>
<h2 id="build-summary">Summary</h2>
<p><a class="fig-ref" href="../build/#build-concept-map">Figure&nbsp;19.4</a> summarizes the ideas introduced in this chapter.
Note that the small bubble labelled &ldquo;graph algorithm&rdquo; could be expanded
to a shelf full of books.</p>
<figure id="build-concept-map" class="here">
<img src="./concept_map.svg" alt="Concept map of build manager"/>
<figcaption>Figure&nbsp;19.4: Concept map.</figcaption>
</figure>

<h2 id="build-exercises">Exercises</h2>
<h3 class="exercise">Stable Sorting</h3>
<p>Recent versions of Python guarantee that
the entries in a <code>dict</code> preserve the order in which they were added,
but do not make any such guarantee for sets.
Explain why this makes it hard to test things that use sets.</p>
<h3 class="exercise">Checking Schema</h3>
<p>Rewrite the configuration validator to use <a href="https://json-schema.org/">JSON Schema</a>
via the associated <a href="https://python-jsonschema.readthedocs.io/">Python module</a>.</p>
<h3 class="exercise">Handling Failure</h3>
<ol>
<li>
<p>Modify the build manager so that a configuration file can specify
    whether its rule should succeed or fail.
    (This isn&rsquo;t particularly useful in real life,
    but it helps with testing.)</p>
</li>
<li>
<p>Modify it so that if a rule fails,
    other buildable targets are still built
    (but anything that depends directly or indirectly on the target whose rule failed
    is <em>not</em> built).</p>
</li>
<li>
<p>Write tests to check that this change works correctly.</p>
</li>
</ol>
<h3 class="exercise">Merging Files</h3>
<ol>
<li>
<p>Modify the build manager so that it can read multiple build files
    and execute their combined rules.</p>
</li>
<li>
<p>What does your solution do if two or more files specify rules
    for the same target?</p>
</li>
</ol>
<h3 class="exercise">Using Hashes</h3>
<ol>
<li>
<p>Write a program called <code>build_init.py</code> that calculates a hash
    for every file mentioned in the build configuration
    and stores the hash along with the file&rsquo;s name in <code>build_hash.json</code>.</p>
</li>
<li>
<p>Modify the build manager to compare the current hashes of files
    with those stored in <code>build_hash.json</code>
    to determine what is out of date,
    and to update <code>build_hash.json</code> each time it runs.</p>
</li>
</ol>
<h3 class="exercise">Dry Run</h3>
<p>A <a class="gl-ref" href="../glossary/#dry_run" markdown="1">dry run</a> of a build shows the rules that would be executed
but doesn&rsquo;t actually execute them.
Modify the build system in this chapter so that it can do dry runs.</p>
<h3 class="exercise">Phony Targets</h3>
<p>A <a class="gl-ref" href="../glossary/#phony_target" markdown="1">phony target</a> is one that doesn&rsquo;t correspond to a file.
Developers often put phony targets in build files
to give themselves an easy way to re-run tests,
check code style,
and so on.
Modify the build system in this target so that
users can mark targets as phony.</p>
<h3 class="exercise">Multiple Build Files</h3>
<ol>
<li>
<p>Modify the tool built in this chapter so that
    one build file can import definitions and dependencies from another.</p>
</li>
<li>
<p>How does your system prevent
    <span class="ix-entry" ix-key="circular dependency" markdown="1">circular dependencies</span>?</p>
</li>
</ol>
	</main>
	<footer>
  © 2024 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sdxpy">repository</a>
  &middot;
  <a href="../license/">license</a>
  &middot;
  <a href="mailto:gvwilson@third-bit.com">contact</a>
</footer>

      </div>
    </div>
  </body>
</html>
