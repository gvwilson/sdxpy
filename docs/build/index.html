<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="repo" content="https://github.com/gvwilson/sdxpy">
  <meta name="build_date" content="2023-09-03">
  <meta name="template" content="default">
  <meta name="major" content="build">
  <meta name="has_slides" content="true">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design by Example: A Build Manager</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design by Example</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../intro/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Objects and Classes
    </a>
  </li>
  
  <li>
    <a href="../dup/">
      Finding Duplicate Files
    </a>
  </li>
  
  <li>
    <a href="../glob/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parse/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../test/">
      Running Tests
    </a>
  </li>
  
  <li>
    <a href="../interp/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../func/">
      Functions and Closures
    </a>
  </li>
  
  <li>
    <a href="../protocols/">
      Protocols
    </a>
  </li>
  
  <li>
    <a href="../archive/">
      A File Archiver
    </a>
  </li>
  
  <li>
    <a href="../check/">
      An HTML Validator
    </a>
  </li>
  
  <li>
    <a href="../template/">
      A Template Expander
    </a>
  </li>
  
  <li>
    <a href="../lint/">
      A Code Linter
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../perf/">
      Performance Profiling
    </a>
  </li>
  
  <li>
    <a href="../persist/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../db/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../build/">
      <strong>A Build Manager</strong>
    </a>
  </li>
  
  <li>
    <a href="../pack/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../ftp/">
      Transferring Files
    </a>
  </li>
  
  <li>
    <a href="../http/">
      Serving Web Pages
    </a>
  </li>
  
  <li>
    <a href="../viewer/">
      A File Viewer
    </a>
  </li>
  
  <li>
    <a href="../undo/">
      Undo and Redo
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../finale/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bib/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../bonus/">
      Bonus Material
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contrib/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 19: A Build Manager</h1>


          
<div class="draft notex">
  <p class="draft">
    DRAFT 2023-09-03
  </p>
  <p>
    revised 2023-08-10<br>
    Please use section heading links to submit feedback
    or go to <a href="https://github.com/gvwilson/sdxpy">https://github.com/gvwilson/sdxpy</a>.
  </p>
</div>


	  
<div class="chapterinfo">

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">Build managers track dependencies between files and update files that are stale.</li>
  
  <li markdown="1">Every build rule has a target, some dependencies, and a recipe for updating the target.</li>
  
  <li markdown="1">Build rules form a directed graph which must not contain cycles.</li>
  
  <li markdown="1">Pattern rules describe the dependencies and recipes for sets of similar files.</li>
  
  <li markdown="1">Pattern rules can use automatic variables to specify targets and dependencies in recipes.</li>
  
  </ul>
  

  

  

  

  

  

  

  



<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#gl:affordance" markdown="1">affordance</a>, <a class="gl-ref" href="../glossary/#gl:build_manager" markdown="1">build manager</a>, <a class="gl-ref" href="../glossary/#gl:build_recipe" markdown="1">build recipe</a>, <a class="gl-ref" href="../glossary/#gl:build_rule" markdown="1">build rule</a>, <a class="gl-ref" href="../glossary/#gl:circular_dependency" markdown="1">circular dependency</a>, <a class="gl-ref" href="../glossary/#gl:compiled_language" markdown="1">compiled language</a>, <a class="gl-ref" href="../glossary/#gl:cycle" markdown="1">cycle</a>, <a class="gl-ref" href="../glossary/#gl:dependency" markdown="1">dependency (in build)</a>, <a class="gl-ref" href="../glossary/#gl:dag" markdown="1">directed acyclic graph</a>, <a class="gl-ref" href="../glossary/#gl:dry_run" markdown="1">dry run</a>, <a class="gl-ref" href="../glossary/#gl:link" markdown="1">link (a program)</a>, <a class="gl-ref" href="../glossary/#gl:phony_target" markdown="1">phony target</a>, <a class="gl-ref" href="../glossary/#gl:stable_sort" markdown="1">stable sort</a>, <a class="gl-ref" href="../glossary/#gl:build_stale" markdown="1">stale (in build)</a>, <a class="gl-ref" href="../glossary/#gl:build_target" markdown="1">target (in build)</a>, <a class="gl-ref" href="../glossary/#gl:template_method_pattern" markdown="1">Template Method pattern</a>, <a class="gl-ref" href="../glossary/#gl:topological_order" markdown="1">topological order</a>
</p>


</div>


          <div class="page-toc"></div>
          <p>Suppose that <code>plot.py</code> produces <code>result.svg</code> from <code>collated.csv</code>,
that <code>collated.csv</code> is produced from <code>samples.csv</code> and <code>controls.csv</code> by <code>analyze.py</code>,
and that <code>samples.csv</code> depends on <code>normalize.py</code> and <code>raw.csv</code>.
If <code>raw.csv</code> changes we want to re-run all three programs;
if <code>controls.csv</code> changes,
on the other hand,
we only need to re-run the analysis and plotting programs.
If we try to keep track of this ourselves we will inevitably make mistakes;
instead,
we should use a <a class="gl-ref" href="../glossary/#gl:build_manager" title="A program that keeps track of how files depend on one another and runs commands to update any files that are out-of-date. Build managers were invented to compile only those parts of programs that had changed, but are now often used to implement workflows in which plots depend on results files, which in turn depend on raw data files or configuration files." markdown="1">build manager</a>
to keep track of which files depend on which
and what actions to take to create or update files.
This chapter shows how a simple build manager works,
and along the way introduces some algorithms for working with graphs.</p>
<h2 id="build-concepts">Section 19.1: Concepts</h2>
<p>The first build manager,
<a href="https://www.gnu.org/software/make/">Make</a>,
was written by a student intern at Bell Labs in the 1970s.
Many others now exist (such as <a href="https://www.scons.org/">SCons</a> and <a href="https://snakemake.readthedocs.io/">Snakemake</a>),
but all perform the same basic operations.
If a <a class="gl-ref" href="../glossary/#gl:build_target" title="The file(s) that a build rule will update if they are out-of-date compared to their dependencies." markdown="1">target</a> is <a class="gl-ref" href="../glossary/#gl:build_stale" title="To be out-of-date compared to a prerequisite. A build manager finds and updates things that are stale." markdown="1">stale</a>
with respect to any of its  <a class="gl-ref" href="../glossary/#gl:dependency" title="Something that a build target depends on." markdown="1">dependencies</a>,
the build manager runs a <a class="gl-ref" href="../glossary/#gl:build_recipe" title="The part of a build rule that describes how to update something that has fallen out-of-date." markdown="1">recipe</a> to refresh it.</p>
<p>The build manager runs recipes in an order that respects dependencies,
and it only runs each recipe once (if at all).
In order for this to be possible,
targets and dependencies must form a <a class="gl-ref" href="../glossary/#gl:dag" title="A directed graph which does not contain any cycles (i.e., it is not possible to reach a node from itself by following edges)." markdown="1">directed acyclic graph</a>,
i.e.,
there cannot be a <a class="gl-ref" href="../glossary/#gl:cycle" title="A path through a directed graph that leads from a node back to itself." markdown="1">cycle</a> of links
leading from a <span class="ix-entry" ix-key="node" markdown="1">node</span> back to itself.
The build manager constructs
a <a class="gl-ref" href="../glossary/#gl:topological_order" title="Any ordering of the nodes in a graph that respects the direction of its edges, i.e., if there is an edge from node A to node B, A comes before B in the ordering. There may be many topological orderings of a particular graph." markdown="1">topological ordering</a> of that <span class="ix-entry" ix-key="graph" markdown="1">graph</span>,
i.e.,
arranges nodes so that each one comes after everything it depends on,
and then builds what it needs to in that order
(<a class="fig-ref" href="../build/#build-dependencies">Figure 19.1</a>).</p>
<figure id="build-dependencies">
<img src="./dependencies.svg" alt="Dependencies in a four-node graph"/>
<figcaption markdown="1">Figure 19.1: Dependencies and topological order</figcaption>
</figure>

<div class="callout">
<h3>A Bit of History</h3>
<p>Make was created to manage programs in <a class="gl-ref" href="../glossary/#gl:compiled_language" title="Originally, a language such as C or Fortran that is translated into machine instructions for execution. Languages such as Java are also compiled before execution, but into bytecode instead of machine instructions, while interpreted languages like JavaScript are compiled to byte code on the fly." markdown="1">compiled languages</a>
like <span class="ix-entry" ix-key="C" markdown="1">C</span> and <span class="ix-entry" ix-key="Java" markdown="1">Java</span>,
which have to be translated into lower-level forms before they can run.
There are usually two stages to the translation:
compiling each source file into some intermediate form,
and then <a class="gl-ref" href="../glossary/#gl:link" title="To combine separately compiled modules into a single runnable program." markdown="1">linking</a> the compiled modules
to each other and to libraries
to create a runnable program.
If a source file hasn&rsquo;t changed,
we don&rsquo;t need to recompile it before linking.
Skipping unnecessary work in this way can save a lot of time
when we are working with programs that contains thousands or tens of thousands of files.</p>
</div>
<h2 id="build-design">Section 19.2: Initial Design</h2>
<p>Our first step is to decide how we are going to represent
<a class="gl-ref" href="../glossary/#gl:build_rule" title="A specification for a build manager that describes how some files depend on others and what to do if those files are out-of-date." markdown="1">build rules</a>.
We could invent a special-purpose syntax to fit the problem,
but as we said in <a class="x-ref" href="../parse/">Chapter 5</a>,
the world has enough data formats.
Instead,
we will represent our recipes as <span class="ix-entry" ix-key="JSON" markdown="1">JSON</span>.
For example,
this file describes two targets <code>A</code> and <code>B</code>
and states that the former depends on the latter:</p>
<div class="code-sample lang-json" title="double_linear_dep.json">
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;A&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build A&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;B&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build B&quot;</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>As in <a class="x-ref" href="../archive/">Chapter 10</a>,
we will use <span class="ix-entry" ix-key="successive refinement" markdown="1">successive refinement</span>
to create our first build manager.
Our <code>BuildBase</code> class takes a configuration file as a constructor argument,
loads it,
creates a topological ordering,
and then refreshes each target in order.
For now,
&ldquo;refreshing&rdquo; means &ldquo;prints the update rule&rdquo;;
we will come back and make this more sophisticated later.</p>
<div class="code-sample lang-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BuildBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topo_sort</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;rule&quot;</span><span class="p">])</span>
</code></pre></div>
</div>
<p>To load a configuration file,
we read in the JSON,
build a set of known targets,
and then verify each rule using a helper method called <code>_check</code>:</p>
<div class="code-sample lang-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="n">known</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">known</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">To check a rule,
we make sure the dictionary that represents it has the required keys
and that we have a rule for every dependency it mentions.
We also transform the rule&rsquo;s structure a bit to simplify later processing:</p>
<div class="code-sample lang-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
    <span class="k">assert</span> <span class="s2">&quot;rule&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing rule for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;depends&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">depends</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">depends</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">known</span><span class="p">),</span> \
        <span class="sa">f</span><span class="s2">&quot;Unknown depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;rule&quot;</span><span class="p">],</span> <span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="n">depends</span><span class="p">}</span>
</code></pre></div>
</div>
<figure id="build-diamond">
<img src="./diamond.svg" alt="Representing graph"/>
<figcaption markdown="1">Figure 19.2: Representing dependency graph</figcaption>
</figure>

<div class="callout">
<h3>It&rsquo;s Not Extra Work</h3>
<p>We have to implement the consistency checks for our build rules
because JSON is a generic format
that knows nothing about dependencies, rules, and required keys.
There is a format called <a href="https://json-schema.org/">JSON Schema</a> for specifying these things
and <a href="https://python-jsonschema.readthedocs.io/">a Python module</a> that implements its checks,
but using it here would trade seven lines of code
for ten minutes of explanation.
We will explore its use in the exercises,
but the most important point is that
whether we write code by hand
or use a library with a bit of configuration,
<em>someone</em> has to write these checks.</p>
</div>
<h2 id="build-sort">Section 19.3: Topological Sorting</h2>
<p>The next step is to figure out a safe order in which to build things.
<a class="fig-ref" href="../build/#build-topo-sort">Figure 19.3</a> shows how our algorithm works:</p>
<ol>
<li>
<p>We find all the nodes in the dependency graph
    that don&rsquo;t have any outstanding dependencies.</p>
</li>
<li>
<p>We append those to the result
    and then remove them from the dependencies of all the other nodes in the graph.</p>
</li>
<li>
<p>If anything is still in the graph,
    we go back to the first step.</p>
</li>
<li>
<p>If at any point the graph isn&rsquo;t empty but nothing is available,
    we have found a <a class="gl-ref" href="../glossary/#gl:circular_dependency" title="A situation in which a build target depends on itself either directly or indirectly, i.e., a situation in which the DAG of dependencies contains a cycle." markdown="1">circular dependency</a>,
    so we report the problem and fail.</p>
</li>
</ol>
<figure id="build-topo-sort">
<img src="./topo_sort.svg" alt="Trace of topological sorting"/>
<figcaption markdown="1">Figure 19.3: Topological sort</figcaption>
</figure>

<p>The code that implements this algorithm is:</p>
<div class="code-sample lang-py" title="build_simple.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_topo_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">config</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]}</span>
        <span class="k">assert</span> <span class="n">available</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Circular graph </span><span class="si">{</span><span class="n">graph</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">n</span><span class="p">:</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">available</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>With all of this in place,
we can run our first test:</p>
<div class="code-sample lang-json" title="double_linear_dep.json">
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;A&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build A&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;B&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;depends&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nt">&quot;rule&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build B&quot;</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="double_linear_dep.out">
<div class="highlight"><pre><span></span><code>build B
build A
</code></pre></div>
</div>
<h2 id="build-better">Section 19.4: A Better Design</h2>
<p>Our implementation works,
but we can do better:</p>
<ol>
<li>
<p>The configuration might not come directly from a JSON file—for example,
    it might be embedded in a larger file or generated by another program—so
    we should modify the constructor to take a configuration as input.</p>
</li>
<li>
<p>Printing actions to the screen isn&rsquo;t very useful,
    so we should collect them and return an ordered list of
    the commands for the build manager.</p>
</li>
<li>
<p><code>assert</code> isn&rsquo;t a friendly way to handle user errors;
    we should raise <code>ValueError</code> (or a custom exception of our own)
    to indicate a problem.</p>
</li>
<li>
<p>Our topological sort isn&rsquo;t <a class="gl-ref" href="../glossary/#gl:stable_sort" title="A sorting algorithm that preserves the original order of items that are considered equal." markdown="1">stable</a>,
    i.e.,
    there&rsquo;s no way to predict the order in which two &ldquo;equal&rdquo; nodes
    will be added to the ordering.
    We will explore the reason for this in the exercises,
    but for now,
    we should sort node names when appending to the <code>result</code> list
    so that our tests can know what to check for.</p>
</li>
<li>
<p>We might want to add other keys to rules,
    so we should put that check in a separate method that we can override.</p>
</li>
</ol>
<p>The top level of our better build manager looks like this:</p>
<div class="code-sample lang-py" title="build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BuildBetter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topo_sort</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">actions</span>

    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;rule&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_must</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">The revised configuration code is:</p>
<div class="code-sample lang-py" title="build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">known</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">known</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_keys</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
    <span class="n">depends</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span>
        <span class="n">depends</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">known</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Unknown depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">depends</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">_check_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing rule for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span>
        <span class="s2">&quot;depends&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing depends for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and the updated topological sorting method is</p>
<div class="code-sample lang-py" title="build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_topo_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">config</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must</span><span class="p">(</span>
            <span class="n">available</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Circular graph </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">n</span><span class="p">:</span> <span class="n">graph</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">available</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>We can now test that the code detects circularities in the dependency graph:</p>
<div class="code-sample lang-py" title="test_build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_circular</span><span class="p">():</span>
    <span class="n">action_A</span> <span class="o">=</span> <span class="s2">&quot;build A&quot;</span>
    <span class="n">action_B</span> <span class="o">=</span> <span class="s2">&quot;build B&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_A</span><span class="p">},</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_B</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Builder</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;should have had exception&quot;</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p class="continue">and that it builds what it&rsquo;s supposed to:</p>
<div class="code-sample lang-py" title="test_build_better.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_no_dep</span><span class="p">():</span>
    <span class="n">action_A</span> <span class="o">=</span> <span class="s2">&quot;build A&quot;</span>
    <span class="n">action_B</span> <span class="o">=</span> <span class="s2">&quot;build B&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_A</span><span class="p">},</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_B</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="n">Builder</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="n">action_A</span><span class="p">,</span> <span class="n">action_B</span><span class="p">]</span>
</code></pre></div>
</div>
<p>We can also extend it.
For example,
suppose we only want to update targets that are older than their dependencies
(which is, after all, the whole point of a build manager).
If the targets are files,
we could their <span class="ix-entry" ix-key="timestamp" markdown="1">timestamps</span>,
but for testing purposes
we would like to specify pretended times in the configuration:</p>
<div class="code-sample lang-py" title="test_build_time.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_diamond_dep</span><span class="p">():</span>
    <span class="n">action_A</span> <span class="o">=</span> <span class="s2">&quot;build A&quot;</span>
    <span class="n">action_B</span> <span class="o">=</span> <span class="s2">&quot;build B&quot;</span>
    <span class="n">action_C</span> <span class="o">=</span> <span class="s2">&quot;build C&quot;</span>
    <span class="n">action_D</span> <span class="o">=</span> <span class="s2">&quot;build D&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_A</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_B</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_C</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">action_D</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="n">Builder</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="n">action_B</span><span class="p">,</span> <span class="n">action_A</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">Starting from the class we have written so far,
we need to override three methods:</p>
<div class="code-sample lang-py" title="build_time.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BuildTime</span><span class="p">(</span><span class="n">BuildBetter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_check_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_check_keys</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require</span><span class="p">(</span><span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;No time for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_update</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;rule&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;depends&quot;</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<div class="callout">
<h3>How We Actually Did It</h3>
<p>Our final design uses
the <a class="gl-ref" href="../glossary/#gl:template_method_pattern" title="A design pattern in which a parent class defines an overall sequence of operations by calling abstract methods that child classes must then implement. Each child class then behaves in the same general way, but implements the steps differently." markdown="1">Template Method</a> pattern:
a method in a <span class="ix-entry" ix-key="parent class" markdown="1">parent class</span> defines the overall order of operations,
while <span class="ix-entry" ix-key="child class" markdown="1">child class</span> implement those operations
without changing the <span class="ix-entry" ix-key="control flow" markdown="1">control flow</span>.
As you might suspect,
we didn&rsquo;t know in advance exactly
how to divide our code into methods.
Instead,
as we were trying to create a class that loaded and used timestamps,
we did a bit of reorganizing in the parent class
to give ourselves the <a class="gl-ref" href="../glossary/#gl:affordance" title="An action that a thing can do: for example, a door can be opened or a document can be printed. Good user interfaces make affordances easy to discover." markdown="1">affordances</a> we needed.
Software design almost always works this way:
the first two or three times we try to use or extend something,
we discover changes that would make those tasks easier.
We should do less of this as time goes by;
putting it another way,
if we are still doing large-scale <span class="ix-entry" ix-key="refactor" markdown="1">refactoring</span>
the tenth or dozenth time we try to use something,
we probably need to rethink our entire design.</p>
</div>
<h2 id="build-summary">Section 19.5: Summary</h2>
<figure id="build-concept-map" class="here">
<img src="./concept_map.svg" alt="Concept map of build manager"/>
<figcaption markdown="1">Figure 19.4: Concept map</figcaption>
</figure>

<h2 id="build-exercises">Section 19.6: Exercises</h2>
<h3 class="exercise">Stable Sorting</h3>
<p>Recent versions of Python guarantee that
the entries in a <code>dict</code> preserve the order in which they were added,
but doesn&rsquo;t make any such guarantee for sets.
Explain why this makes it hard to test things that use sets.</p>
<h3 class="exercise">Checking Schema</h3>
<p>Rewrite the configuration validator to use <a href="https://json-schema.org/">JSON Schema</a>
via the associated <a href="https://python-jsonschema.readthedocs.io/">Python module</a>.</p>
<h3 class="exercise">Handling Failure</h3>
<ol>
<li>
<p>Modify the build manager so that a configuration file can specify
    whether its rule should succeed or fail.
    (This isn&rsquo;t particularly useful in real life,
    but helps with testing.)</p>
</li>
<li>
<p>Modify it so that if a rule fails,
    other buildable targets are still built
    (but anything that depends directly or indirectly on the target whose rule failed
    is <em>not</em> built).</p>
</li>
<li>
<p>Write tests to check that this change works correctly.</p>
</li>
</ol>
<h3 class="exercise">Merging Files</h3>
<ol>
<li>
<p>Modify the build manager so that it can read multiple build files
    and execute their combined rules.</p>
</li>
<li>
<p>What does your solution do if two or more files specify rules
    for the same target?</p>
</li>
</ol>
<h3 class="exercise">Using Hashes</h3>
<ol>
<li>
<p>Write a program called <code>build_init.py</code> that calculates a hash
    for every file mentioned in the build configuration
    and stores the hash along with the file&rsquo;s name in <code>build_hash.json</code>.</p>
</li>
<li>
<p>Modify the build manager to compare the current hashes of files
    with those stored in <code>build_hash.json</code>
    to determine what is out of date,
    and to update <code>build_hash.json</code> each time it runs.</p>
</li>
</ol>
<h3 class="exercise">Dry Run</h3>
<p>A <a class="gl-ref" href="../glossary/#gl:dry_run" title="An execution of a program that doesn&#x27;t change anything." markdown="1">dry run</a> of a build shows the rules that would be executed
but doesn&rsquo;t actually execute them.
Modify the build system in this chapter so that it can do dry runs.</p>
<h3 class="exercise">Phony Targets</h3>
<p>A <a class="gl-ref" href="../glossary/#gl:phony_target" title="A build recipe that doesn&#x27;t update any files. Phony targets are typically used to make tasks such as running tests reproducible." markdown="1">phony target</a> is one that doesn&rsquo;t correspond to a file.
Developers often put phony targets in build files
to give themselves an easy way to re-run tests,
check code style,
and so on.
Modify the build system in this target so that
users can mark targets as phony.</p>
<h3 class="exercise">Multiple Build Files</h3>
<ol>
<li>
<p>Modify the tool built in this chapter so that
    one build file can import definitions and dependencies from another.</p>
</li>
<li>
<p>How does your system prevent
    <span class="ix-entry" ix-key="circular dependency" markdown="1">circular dependencies</span>?</p>
</li>
</ol>
        </main>
      </div>
    </div>
  </body>
</html>
