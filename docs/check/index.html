<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>Software Design by Example &middot; An HTML Validator</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>


  </head>
  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.routledge.com/Software-Design-by-Example-A-Tool-Based-Introduction-with-Python/Wilson/p/book/9781032725215"><img src="../sdxpy-cover.png" alt="Book cover" class="bookcover" /></a>
  
</p>

<div class="screen-reader-only">
  <a href="#printable">Skip to content</a>
</div>

<ol class="toc-chapters"><li><a href="../intro/">Introduction</a></li><li><a href="../oop/">Objects and Classes</a></li><li><a href="../dup/">Finding Duplicate Files</a></li><li><a href="../glob/">Matching Patterns</a></li><li><a href="../parse/">Parsing Text</a></li><li><a href="../test/">Running Tests</a></li><li><a href="../interp/">An Interpreter</a></li><li><a href="../func/">Functions and Closures</a></li><li><a href="../protocols/">Protocols</a></li><li><a href="../archive/">A File Archiver</a></li><li><a href="../check/">An HTML Validator</a></li><li><a href="../template/">A Template Expander</a></li><li><a href="../lint/">A Code Linter</a></li><li><a href="../layout/">Page Layout</a></li><li><a href="../perf/">Performance Profiling</a></li><li><a href="../persist/">Object Persistence</a></li><li><a href="../binary/">Binary Data</a></li><li><a href="../db/">A Database</a></li><li><a href="../build/">A Build Manager</a></li><li><a href="../pack/">A Package Manager</a></li><li><a href="../ftp/">Transferring Files</a></li><li><a href="../http/">Serving Web Pages</a></li><li><a href="../viewer/">A File Viewer</a></li><li><a href="../undo/">Undo and Redo</a></li><li><a href="../vm/">A Virtual Machine</a></li><li><a href="../debugger/">A Debugger</a></li><li><a href="../finale/">Conclusion</a></li></ol>
<ol class="toc-appendices"><li><a href="../bib/">Bibliography</a></li><li><a href="../bonus/">Bonus Material</a></li><li><a href="../syllabus/">Syllabus</a></li><li><a href="../license/">License</a></li><li><a href="../conduct/">Code of Conduct</a></li><li><a href="../contrib/">Contributing</a></li><li><a href="../glossary/">Glossary</a></li><li><a href="../colophon/">Colophon</a></li><li><a href="../contents/">Index</a></li></ol>


<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


<p><a href="https://github.com/gvwilson/sdxpy">GitHub repository</a></p>

      </div>
      <div id="printable" class="contents bordered">
	<main>
	  <div class="row notex">
  <div class="col-12 center">
    
      <h1>An HTML Validator</h1>
    
  </div>
</div>

	  
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../archive/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../template/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


	  <ul class="keypoints">
<li>HTML consists of text and of elements represented by tags with attributes.</li>
<li>HTML is represented in memory as a Document Object Model (DOM) tree.</li>
<li>Trees are usually processed using recursion.</li>
<li>The Visitor design pattern is often used to perform an action for each member of a data structure.</li>
<li>We can summarize and check the structure of an HTML page by visiting each node and recording what we find there.</li>
</ul>
	  <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#attribute" markdown="1">attribute</a>, <a class="gl-ref" href="../glossary/#child_tree" markdown="1">child (in a tree)</a>, <a class="gl-ref" href="../glossary/#dom" markdown="1">DOM</a>, <a class="gl-ref" href="../glossary/#dom_tree" markdown="1">DOM tree</a>, <a class="gl-ref" href="../glossary/#element" markdown="1">element (in HTML)</a>, <a class="gl-ref" href="../glossary/#html" markdown="1">HTML</a>, <a class="gl-ref" href="../glossary/#node" markdown="1">node</a>, <a class="gl-ref" href="../glossary/#tag" markdown="1">tag (in HTML)</a>, <a class="gl-ref" href="../glossary/#tag_closing" markdown="1">closing tag</a>, <a class="gl-ref" href="../glossary/#tag_opening" markdown="1">opening tag</a>, <a class="gl-ref" href="../glossary/#tag_self_closing" markdown="1">self-closing tag</a>, <a class="gl-ref" href="../glossary/#tree" markdown="1">tree</a>, <a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor pattern</a>
</p>
	  <p>Suppose we want to generate web pages to show the results of data analyses.
We want to check that these pages all have the same structure
so that people can find things in them,
and that they meet accessibility standards
so that <em>everyone</em> can find things in them.
This chapter builds a small tool to do this checking,
which introduces ideas we will use in building a page generator (<a href="../template/">Chapter&nbsp;12</a>)
and another to check the structure and style of our code (<a href="../lint/">Chapter&nbsp;13</a>).</p>
<h2 id="check-htmldom">HTML and the DOM</h2>
<p>An <a class="gl-ref" href="../glossary/#html" markdown="1">HTML</a> document is made up of <a class="gl-ref" href="../glossary/#element" markdown="1">elements</a> and text.
(It can actually contain other things, but we&rsquo;ll ignore those for now.)
Elements are represented using <a class="gl-ref" href="../glossary/#tag" markdown="1">tags</a> enclosed in <code>&lt;</code> and <code>&gt;</code>.
An <a class="gl-ref" href="../glossary/#tag_opening" markdown="1">opening tag</a> like <code>&lt;p&gt;</code> starts an element,
while a <a class="gl-ref" href="../glossary/#tag_closing" markdown="1">closing tag</a> like <code>&lt;/p&gt;</code> ends it.
If the element is empty,
we can use a <a class="gl-ref" href="../glossary/#tag_self_closing" markdown="1">self-closing tag</a> like <code>&lt;br/&gt;</code>
to save some typing.
Tags must be properly nested,
i.e.,
they must be closed in the reverse of the order in which they were opened.
This rule means that things like <code>&lt;a&gt;&lt;b&gt;&lt;/a&gt;&lt;/b&gt;</code> are not allowed;
it also means that
a document&rsquo;s elements form a <a class="gl-ref" href="../glossary/#tree" markdown="1">tree</a> of <a class="gl-ref" href="../glossary/#node" markdown="1">nodes</a> and text
like the one shown in <a class="fig-ref" href="../check/#check-dom-tree">Figure&nbsp;11.1</a>.</p>
<p>This figure also shows that
opening and self-closing tags can have <a class="gl-ref" href="../glossary/#attribute" markdown="1">attributes</a>,
which are written as <code>key="value"</code>.
For example,
if we want to put an image in an HTML page,
we specify the image file&rsquo;s name using the <code>src</code> attribute of the <code>img</code> tag:</p>
<div class="language-ht" title="ex_banner.ht">
<div class="highlight"><pre><span></span><code>&lt;img src=&quot;banner.png&quot; /&gt;
</code></pre></div>
</div>
<figure id="check-dom-tree">
<img src="./dom_tree.svg" alt="DOM tree"/>
<figcaption>Figure&nbsp;11.1: Representing HTML elements as a DOM tree.</figcaption>
</figure>

<p>The objects that represent the nodes and text in an HTML tree
are called the Document Object Model or <a class="gl-ref" href="../glossary/#dom" markdown="1">DOM</a>.
Hundreds of tools have been written to convert HTML text to DOM;
our favorite is a Python module called <a href="https://beautiful-soup-4.readthedocs.io/">Beautiful Soup</a>,
which can handle messy real-world documents
as well as those that conform to every rule of the standard.</p>
<p>Beautiful Soup&rsquo;s DOM has two main classes:
<code>NavigableString</code> for text and <code>Tag</code> for elements.
To parse a document,
we import what we need and call <code>BeautifulSoup</code> with
the text to be <span class="ix-entry" ix-key="parser" markdown="1">parsed</span>
and a string specifying exactly what kind of parsing we want to do.
(In practice, this is almost always <code>"html.parser"</code>.)</p>
<div class="language-py" title="parse.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span><span class="p">,</span> <span class="n">NavigableString</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</code></pre></div>
</div>
<p><code>Tag</code> nodes have two properties <code>name</code> and <code>children</code>
to tell us what element the tag represents
and to give us access to the node&rsquo;s <a class="gl-ref" href="../glossary/#child_tree" markdown="1">children</a>,
i.e.,
the nodes below it in the tree.
We can therefore write a short <span class="ix-entry" ix-key="recursion" markdown="1">recursive</span> function
to show us everything in the DOM:</p>
<div class="language-py" title="parse.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">NavigableString</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;string: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">string</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;node: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We can test this function with a short example:</p>
<div class="language-py" title="parse.py">
<div class="highlight"><pre><span></span><code><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;html&gt;</span>
<span class="s2">&lt;body&gt;</span>
<span class="s2">&lt;h1&gt;Title&lt;/h1&gt;</span>
<span class="s2">&lt;p&gt;paragraph&lt;/p&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;&quot;&quot;&quot;</span>
</code></pre></div>
</div>
<div class="language-out" title="parse.out">
<div class="highlight"><pre><span></span><code>node: [document]
node: html
string: &#39;\n&#39;
node: body
string: &#39;\n&#39;
node: h1
string: &#39;Title&#39;
string: &#39;\n&#39;
node: p
string: &#39;paragraph&#39;
string: &#39;\n&#39;
string: &#39;\n&#39;
</code></pre></div>
</div>
<p class="continue">In order to keep everything in one file,
we have written the HTML &ldquo;page&rdquo; as a multiline Python string;
we will do this frequently when writing unit tests
so that the HTML <span class="ix-entry" ix-key="fixture" markdown="1">fixture</span> is right beside the test code.
Notice in the output that the line breaks in the HTML
have been turned into text nodes containing only a newline character.
It&rsquo;s easy to forget about these when writing code that processes pages.</p>
<p>The last bit of the DOM that we need is its representation of attributes.
Each <code>Tag</code> node has a <span class="ix-entry" ix-key="dictionary" markdown="1">dictionary</span> called <code>attrs</code>
that stores the node&rsquo;s attributes.
The values in this dictionary are either strings or lists of strings
depending on whether the attribute has a single value or multiple values:</p>
<div class="language-py" title="attrs.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Tag</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;node: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="language-py" title="attrs.py">
<div class="highlight"><pre><span></span><code><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;html lang=&quot;en&quot;&gt;</span>
<span class="s2">&lt;body class=&quot;outline narrow&quot;&gt;</span>
<span class="s2">&lt;p align=&quot;left&quot; align=&quot;right&quot;&gt;paragraph&lt;/p&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;&quot;&quot;&quot;</span>
</code></pre></div>
</div>
<div class="language-out" title="attrs.out">
<div class="highlight"><pre><span></span><code>node: [document] {}
node: html {&#39;lang&#39;: &#39;en&#39;}
node: body {&#39;class&#39;: [&#39;outline&#39;, &#39;narrow&#39;]}
node: p {&#39;align&#39;: &#39;right&#39;}
</code></pre></div>
</div>
<h2 id="check-visitor-pattern">The Visitor Pattern</h2>
<p>Before building an HTML validator,
let&rsquo;s build something to tell us
which elements appear inside which others in a document.
Our recursive function takes two arguments:
the current node and a dictionary
whose keys are node names and whose values are sets
containing the names of those nodes&rsquo; children.
Each time it encounters a node,
the function adds the names of the child nodes to the appropriate set
and then calls itself once for each child to collect their children:</p>
<div class="language-py" title="contains.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">catalog</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Tag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">catalog</span><span class="p">:</span>
        <span class="n">catalog</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Tag</span><span class="p">):</span>
            <span class="n">catalog</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">recurse</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">catalog</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">catalog</span>
</code></pre></div>
</div>
<p>When we run our function on this page:</p>
<div class="language-html" title="page.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Software Design by Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Main Title<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>introductory paragraph<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>first item<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>second item is <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>emphasized<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<p class="continue">it produces this output
(which we print in sorted order to make things easier to find):</p>
<div class="language-out" title="contains.out">
<div class="highlight"><pre><span></span><code>body: h1, p, ul
em:
h1:
head: title
html: body, head
li: em
p:
title:
ul: li
</code></pre></div>
</div>
<p>At this point we have written several recursive functions
that have almost exactly the same <span class="ix-entry" ix-key="control flow" markdown="1">control flow</span>.
A good rule of software design is that if we have built something three times,
we should make what we&rsquo;ve learned reusable
so that we never have to write it again.
In this case,
we will rewrite our code to use the <a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor</a> <span class="ix-entry" ix-key="design pattern" markdown="1">design pattern</span>.</p>
<p>A visitor is a <span class="ix-entry" ix-key="class" markdown="1">class</span> that knows how to get to each element of a data structure
and call a user-defined <span class="ix-entry" ix-key="method" markdown="1">method</span> when it gets there.
Our visitor will have three methods:
one that it calls when it first encounters a node,
one that it calls when it is finished with that node,
and one that it calls for text (<a class="fig-ref" href="../check/#check-visitor">Figure&nbsp;11.2</a>):</p>
<div class="language-py" title="visitor.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Visitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">NavigableString</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Tag</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tag_enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tag_exit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_tag_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_tag_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span> <span class="k">pass</span>
</code></pre></div>
</div>
<p class="continue">We provide do-nothing implementations of the three action methods
rather than having them <span class="ix-entry" ix-key="raise" markdown="1">raise</span> a <code>NotImplementedError</code>
because a particular use of our <code>Visitor</code> class may not need some of these methods.
For example,
our catalog builder didn&rsquo;t need to do anything when leaving a node or for text nodes,
and we shouldn&rsquo;t require people to implement things they don&rsquo;t need.</p>
<figure id="check-visitor">
<img src="./visitor.svg" alt="Visitor pattern order of operations"/>
<figcaption>Figure&nbsp;11.2: Visitor checking each node in depth-first order.</figcaption>
</figure>

<p>Here&rsquo;s what our catalog builder looks like
when re-implemented on top of our <code>Visitor</code> class:</p>
<div class="language-py" title="catalog.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Catalog</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_tag_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Tag</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="language-py" title="catalog.py">
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

<span class="n">cataloger</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">()</span>
<span class="n">cataloger</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">html</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">cataloger</span><span class="o">.</span><span class="n">catalog</span>

<span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">contents</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>It is only a few lines shorter than the original,
but the more complicated the data structure is,
the more helpful the Visitor pattern becomes.</p>
<h2 id="check-style">Checking Style</h2>
<p>To wrap up our style checker,
let&rsquo;s create a <span class="ix-entry" ix-key="manifest" markdown="1">manifest</span> that specifies
which types of nodes can be children of which others:</p>
<div class="language-yml" title="manifest.yml">
<div class="highlight"><pre><span></span><code>body:
- section
head:
- title
html:
- body
- head
section:
- h1
- p
- ul
ul:
- li
</code></pre></div>
</div>
<p class="continue">We&rsquo;ve chosen to use <span class="ix-entry" ix-key="YAML" markdown="1">YAML</span>
for the manifest
because it&rsquo;s a relatively simple way to write nested rules.
<span class="ix-entry" ix-key="JSON" markdown="1">JSON</span> would have worked just as well,
but as we said in <a href="../parse/">Chapter&nbsp;5</a>,
we shouldn&rsquo;t invent a syntax of our own:
there are already too many in the world.</p>
<p>Our <code>Check</code> class needs a <span class="ix-entry" ix-key="constructor" markdown="1">constructor</span> to set everything up
and a <code>_tag_enter</code> method to handle nodes:</p>
<div class="language-py" title="check.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Check</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manifest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span> <span class="o">=</span> <span class="n">manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problems</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_tag_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="p">{</span><span class="n">child</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span>
                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Tag</span><span class="p">)}</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
</code></pre></div>
</div>
<p>To run this,
we load a manifest and an HTML document,
create a checker,
ask the checker to visit each node,
then print out every problematic parent-child combination it found:</p>
<div class="language-py" title="check.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">read_manifest</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="n">manifest</span> <span class="o">=</span> <span class="n">read_manifest</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

<span class="n">checker</span> <span class="o">=</span> <span class="n">Check</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
<span class="n">checker</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">html</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">checker</span><span class="o">.</span><span class="n">problems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="language-out" title="check.out">
<div class="highlight"><pre><span></span><code>body: h1, p, ul
li: em
</code></pre></div>
</div>
<p>The output tells us that content is supposed to be inside a <code>section</code> element,
not directly inside the <code>body</code>,
and that we&rsquo;re not supposed to <em>emphasize</em> words in lists.
Other users&rsquo; rules may be different,
but we now have the tool we need
to check that any HTML we generate conforms to our intended rules.
More importantly,
we have a general pattern for building recursive code
that we can use in upcoming chapters.</p>
<h2 id="check-summary">Summary</h2>
<p>HTML is probably the most widely used data format in the world today;
<a class="fig-ref" href="../check/#check-concept-map">Figure&nbsp;11.3</a> summarizes how it is represented and processed.</p>
<figure id="check-concept-map" class="here">
<img src="./concept_map.svg" alt="Concept map for checking HTML"/>
<figcaption>Figure&nbsp;11.3: Concept map for checking HTML using the Visitor pattern.</figcaption>
</figure>

<h2 id="check-exercises">Exercises</h2>
<h3 class="exercise">Simplify the Logic</h3>
<ol>
<li>
<p>Trace the operation of <code>Check._tag_enter</code>
    and convince yourself that it does the right thing.</p>
</li>
<li>
<p>Rewrite it to make it easier to understand.</p>
</li>
</ol>
<h3 class="exercise">Detecting Empty Elements</h3>
<p>Write a visitor that builds a list of nodes
that could be written as self-closing tags but aren&rsquo;t,
i.e.,
node that are written as <code>&lt;a&gt;&lt;/a&gt;</code>.
The <code>Tag.sourceline</code> attribute may help you
make your report more readable.</p>
<h3 class="exercise">Eliminating Newlines</h3>
<p>Write a visitor that deletes any text nodes from a document
that only contains newline characters.
Do you need to make any changes to <code>Visitor</code>,
or can you implement this using the class as it is?</p>
<h3 class="exercise">Linearize the Tree</h3>
<p>Write a visitor that returns a flat list containing
all the nodes in a <a class="gl-ref" href="../glossary/#dom_tree" markdown="1">DOM tree</a>
in the order in which they would be traversed.
When you are done,
you should be able to write code like this:</p>
<div class="language-py" title="ex_flatten.py">
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">Flatten</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">html</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</code></pre></div>
</div>
<h3 class="exercise">Reporting Accessibility Violations</h3>
<ol>
<li>
<p>Write a program that reads one or more HTML pages
    and reports images in them that do <em>not</em> have an <code>alt</code> attribute.</p>
</li>
<li>
<p>Extend your program so that it also reports
    any <code>figure</code> elements that do <em>not</em> contain exactly one <code>figcaption</code> element.</p>
</li>
<li>
<p>Extend your program again so that it warns about images with redundant text
    (i.e., images in figures
    whose <code>alt</code> attribute contains the same text
    as the figure&rsquo;s caption).</p>
</li>
</ol>
<h3 class="exercise">Ordering Headings</h3>
<p>Write a program that checks the ordering of headings in a page:</p>
<ol>
<li>
<p>There should be exactly one <code>h1</code> element,
    and it should be the first heading in the page.</p>
</li>
<li>
<p>Heading levels should never increase by more than 1,
    i.e.,
    an <code>h1</code> should only ever be followed by an <code>h2</code>,
    an <code>h2</code> should never be followed directly by an <code>h4</code>,
    and so on.</p>
</li>
</ol>
<h3 class="exercise">Report Full Path</h3>
<p>Modify the checking tool so that it reports
the full path for style violations when it finds a problem,
e.g.,
reports &lsquo;div.div.p<code>(meaning "a paragraph in a div in another div")
instead of just</code>p`.</p>
	</main>
	<footer>
  Â© 2024 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sdxpy">repository</a>
  &middot;
  <a href="../license/">license</a>
</footer>

      </div>
    </div>
  </body>
</html>
