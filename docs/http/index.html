<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>Software Design by Example &middot; Serving Web Pages</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


  </head>
  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.routledge.com/Software-Design-by-Example-A-Tool-Based-Introduction-with-Python/Wilson/p/book/9781032725215"><img src="../sdxpy-cover.png" alt="Book cover" class="bookcover" /></a>
  
</p>

<div class="screen-reader-only">
  <a href="#printable">Skip to content</a>
</div>

<ol class="toc-chapters"><li><a href="../intro/">Introduction</a></li><li><a href="../oop/">Objects and Classes</a></li><li><a href="../dup/">Finding Duplicate Files</a></li><li><a href="../glob/">Matching Patterns</a></li><li><a href="../parse/">Parsing Text</a></li><li><a href="../test/">Running Tests</a></li><li><a href="../interp/">An Interpreter</a></li><li><a href="../func/">Functions and Closures</a></li><li><a href="../protocols/">Protocols</a></li><li><a href="../archive/">A File Archiver</a></li><li><a href="../check/">An HTML Validator</a></li><li><a href="../template/">A Template Expander</a></li><li><a href="../lint/">A Code Linter</a></li><li><a href="../layout/">Page Layout</a></li><li><a href="../perf/">Performance Profiling</a></li><li><a href="../persist/">Object Persistence</a></li><li><a href="../binary/">Binary Data</a></li><li><a href="../db/">A Database</a></li><li><a href="../build/">A Build Manager</a></li><li><a href="../pack/">A Package Manager</a></li><li><a href="../ftp/">Transferring Files</a></li><li><a href="../http/">Serving Web Pages</a></li><li><a href="../viewer/">A File Viewer</a></li><li><a href="../undo/">Undo and Redo</a></li><li><a href="../vm/">A Virtual Machine</a></li><li><a href="../debugger/">A Debugger</a></li><li><a href="../observe/">Observers</a></li><li><a href="../docgen/">Generating Documentation</a></li><li><a href="../compress/">File Compression</a></li><li><a href="../cache/">A File Cache</a></li><li><a href="../orm/">Object-Relational Mapper</a></li><li><a href="../concur/">Concurrency</a></li><li><a href="../finale/">Conclusion</a></li></ol>
<ol class="toc-appendices"><li><a href="../bib/">Bibliography</a></li><li><a href="../bonus/">Bonus Material</a></li><li><a href="../syllabus/">Syllabus</a></li><li><a href="../license/">License</a></li><li><a href="../conduct/">Code of Conduct</a></li><li><a href="../contrib/">Contributing</a></li><li><a href="../glossary/">Glossary</a></li><li><a href="../colophon/">Colophon</a></li><li><a href="../contents/">Index</a></li></ol>


<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


<p><a href="https://github.com/gvwilson/sdxpy">GitHub repository</a></p>

      </div>
      <div id="printable" class="contents bordered">
	<main>
	  <div class="row notex">
  <div class="col-12 center">
    
      <h1>Serving Web Pages</h1>
    
  </div>
</div>

	  
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../ftp/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../viewer/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


	  <ul class="keypoints">
<li>The HyperText Transfer Protocol (HTTP) specifies one way to interact via messages over sockets.</li>
<li>A minimal HTTP request has a method, a URL, and a protocol version.</li>
<li>A complete HTTP request may also have headers and a body.</li>
<li>An HTTP response has a status code, a status phrase, and optionally some headers and a body.</li>
<li>HTTP is a stateless protocol: the application is responsible for remembering things between requests.</li>
</ul>
	  <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#http" markdown="1">HTTP</a>, <a class="gl-ref" href="../glossary/#http_body" markdown="1">body (of HTTP request or response)</a>, <a class="gl-ref" href="../glossary/#http_header" markdown="1">header (of HTTP request or response)</a>, <a class="gl-ref" href="../glossary/#http_method" markdown="1">HTTP method</a>, <a class="gl-ref" href="../glossary/#http_protocol_version" markdown="1">HTTP protocol version</a>, <a class="gl-ref" href="../glossary/#http_request" markdown="1">HTTP request</a>, <a class="gl-ref" href="../glossary/#http_response" markdown="1">HTTP response</a>, <a class="gl-ref" href="../glossary/#http_status_code" markdown="1">HTTP status code</a>, <a class="gl-ref" href="../glossary/#path_resolution" markdown="1">path resolution</a>, <a class="gl-ref" href="../glossary/#query_parameter" markdown="1">query parameter</a>, <a class="gl-ref" href="../glossary/#throw_low_catch_high" markdown="1">throw low, catch high</a>, <a class="gl-ref" href="../glossary/#url" markdown="1">Universal Resource Locator</a>
</p>
	  <p>Copying files from one machine to another is useful (<a href="../ftp/">Chapter&nbsp;21</a>),
but we want to do more.
What we <em>don&rsquo;t</em> want to do is
create a new <span class="ix-entry" ix-key="protocol" markdown="1">protocol</span> for every application,
any more than we create new file formats (<a href="../parse/">Chapter&nbsp;5</a>).</p>
<p>The <a class="gl-ref" href="../glossary/#http" markdown="1">HyperText Transfer Protocol</a> (HTTP)
defines a way for programs to exchange data over the web.
It is deliberately simple:
the <span class="ix-entry" ix-key="client" markdown="1">client</span> sends a <a class="gl-ref" href="../glossary/#http_request" markdown="1">request</a>
specifying what it wants over a <span class="ix-entry" ix-key="socket" markdown="1">socket</span>,
and the <span class="ix-entry" ix-key="server" markdown="1">server</span> sends a <a class="gl-ref" href="../glossary/#http_response" markdown="1">response</a> containing some data.
Servers can construct responses however they want:
they can copy files from disk,
generate <span class="ix-entry" ix-key="HTML" markdown="1">HTML</span> dynamically,
or do anything else a programmer can think of.</p>
<p>This chapter shows how to build a simple web server
that understands the basics of HTTP
and how to test programs of this kind.
What we will build is much simpler than <a href="https://httpd.apache.org/">Apache</a>, <a href="https://nginx.org/">nginx</a>,
or other industrial-strength servers,
but all the key ideas will be there.</p>
<h2 id="http-protocol">Protocol</h2>
<p>An HTTP request is just text:
any program that wants to can create one or parse one.
An absolutely minimal HTTP request has just
the name of a <a class="gl-ref" href="../glossary/#http_method" markdown="1">method</a>,
a <a class="gl-ref" href="../glossary/#url" markdown="1">URL</a>,
and a <a class="gl-ref" href="../glossary/#http_protocol_version" markdown="1">protocol version</a>
on a single line separated by spaces:</p>
<div class="language-txt" title="minimal_http_request.txt">
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
</code></pre></div>
</div>
<p>The HTTP method is almost always either <code>GET</code> (to fetch information)
or <code>POST</code> (to submit form data or upload files).
The URL specifies what the client wants:
it is often a path to a file on disk,
such as <code>/index.html</code>,
but (and this is the crucial part)
it&rsquo;s completely up to the server to decide what to do with it.
The HTTP version is usually &ldquo;HTTP/1.0&rdquo; or &ldquo;HTTP/1.1&rdquo;;
the differences between the two don&rsquo;t matter to us.</p>
<p>Most real requests have a few extra lines called
<a class="gl-ref" href="../glossary/#http_header" markdown="1">headers</a>,
which are key-value pairs like the ones shown below:</p>
<div class="language-txt" title="http_request_headers.txt">
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
Accept: text/html
Accept-Language: en, fr
If-Modified-Since: 16-May-2023
</code></pre></div>
</div>
<p>Unlike the keys in hash tables,
<span class="ix-entry" ix-key="key" markdown="1">keys</span> may appear any number of times in HTTP headers,
so that (for example)
a request can specify that it&rsquo;s willing to accept several types of content.</p>
<p>Finally,
the <a class="gl-ref" href="../glossary/#http_body" markdown="1">body</a> of the request is any extra data associated with it,
such as form data or uploaded files.
There must be a blank line between the last header and the start of the body
to signal the end of the headers,
and if there is a body,
the request must have a header called <code>Content-Length</code>
that tells the server how many bytes are in the body.</p>
<p>An HTTP response is formatted like an HTTP request.
Its first line has the protocol
followed by a <a class="gl-ref" href="../glossary/#http_status_code" markdown="1">status code</a> and a status phrase,
such as &ldquo;200 OK&rdquo; or &ldquo;404 Not Found&rdquo;.
There are then some headers
(including <code>Content-Length</code> if the reply has a body),
a blank line,
and the body:</p>
<div class="language-txt" title="http_response.txt">
<div class="highlight"><pre><span></span><code>HTTP/1.1 200 OK
Date: Thu, 16 June 2023 12:28:53 GMT
Content-Type: text/html
Content-Length: 53

&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Hello, World!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p>Constructing HTTP requests is tedious,
so most people use a library to do the repetitive work.
The most popular one in Python is the <a href="https://requests.readthedocs.io/"><code>requests</code></a> module,
and works like this:</p>
<div class="language-py" title="requests_example.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://third-bit.com/test.html&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;status code:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;content length:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-length&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="language-out" title="requests_example.out">
<div class="highlight"><pre><span></span><code>status code: 200
content length: 103
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Test Page&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;test page&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p><code>request.get</code> sends an HTTP GET request to a server
and returns an object containing the response (<a class="fig-ref" href="../http/#http-lifecycle">Figure&nbsp;22.1</a>).
That object&rsquo;s <code>status_code</code> member is the response&rsquo;s status code;
its <code>content_length</code> member  is the number of bytes in the response data,
and <code>text</code> is the actual data—in this case, an HTML page
that we can analyze or render.
Keep in mind that <code>requests</code> isn&rsquo;t doing anything magical:
it is just formatting some text,
opening a socket connection (<a href="../ftp/">Chapter&nbsp;21</a>),
sending that text through the connection,
and then reading a response.
We will implement some of this ourselves in the exercises.</p>
<figure id="http-lifecycle">
<img src="./http_lifecycle.svg" alt="HTTP request/response lifecycle"/>
<figcaption>Figure&nbsp;22.1: Lifecycle of an HTTP request and response.</figcaption>
</figure>

<h2 id="http-static">Hello, Web</h2>
<p>We&rsquo;re now ready to write a simple HTTP server that will:</p>
<ol>
<li>wait for someone to connect and send an HTTP request;</li>
<li>parse that request;</li>
<li>figure out what to send back; and</li>
<li>reply with an HTML page.</li>
</ol>
<p>Steps 1, 2, and 4 are the same from one application to another,
so the <span class="ix-entry" ix-key="Python standard library" markdown="1">Python standard library</span> has a module called <a href="https://docs.python.org/3/library/http.server.html"><code>http.server</code></a>
to do most of the work.
Here&rsquo;s the entire server:</p>
<div class="language-py" title="basic_server.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>

<span class="n">PAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;&lt;p&gt;test page&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">PAGE</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html; charset=utf-8&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Let&rsquo;s start at the bottom and work our way up.</p>
<ol>
<li><code>server_address</code> specifies the <span class="ix-entry" ix-key="hostname" markdown="1">hostname</span> and <span class="ix-entry" ix-key="port" markdown="1">port</span> of the server.</li>
<li>The <code>HTTPServer</code> class takes care of parsing requests and sending back responses.
    When we construct it,
    we give it the server address and the name of the class we&rsquo;ve written
    that handles requests the way we want—in this case, <code>RequestHandler</code>.</li>
<li>Finally, we call the server&rsquo;s <code>serve_forever</code> method,
    which runs until it crashes or we stop it with Ctrl-C.</li>
</ol>
<p>So what does <code>RequestHandler</code> do?</p>
<ol>
<li>When the server receives a <code>GET</code> request,
    it looks in the request handler for a method called <code>do_GET</code>.
    (If it gets a <code>POST</code>, it looks for <code>do_POST</code> and so on.)</li>
<li><code>do_GET</code> converts the text of the page we want to send back
    from characters to bytes—we&rsquo;ll talk about this below.</li>
<li>It then sends a response code (200),
    a couple of headers to say what the content type is
    and how many bytes the receiver should expect,
    and a blank line (produced by the <code>end_headers</code> method).</li>
<li>Finally, <code>do_GET</code> sends the content of the response
    by calling <code>self.wfile.write</code>.
    <code>self.wfile</code> is something that looks and acts like a write-only file,
    but is actually sending bytes to the socket connection.</li>
</ol>
<p>If we run this program from the command line,
it doesn&rsquo;t display anything:</p>
<div class="language-sh" title="basic_server.sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>basic_http_server.py
</code></pre></div>
</div>
<p class="continue">but if we then go to <code>http://localhost:8080</code> with our browser
we see this:</p>
<div class="language-txt" title="hello_web.txt">
<div class="highlight"><pre><span></span><code>Hello, web!
</code></pre></div>
</div>
<p class="continue">and this in our shell:</p>
<div class="language-out" title="basic_server.out">
<div class="highlight"><pre><span></span><code>127.0.0.1 - - [16/Sep/2022 06:34:59] &quot;GET / HTTP/1.1&quot; 200 -
127.0.0.1 - - [16/Sep/2022 06:35:00] &quot;GET /favicon.ico HTTP/1.1&quot; 200 -
</code></pre></div>
</div>
<p>The first line is straightforward:
since we didn&rsquo;t ask for a particular file,
our browser has asked for &lsquo;/&rsquo; (the root directory of whatever the server is serving).
The second line appears because
our browser automatically sends a second request
for an image file called <code>/favicon.ico</code>,
which it will display as an icon in the address bar if it exists.</p>
<h2 id="http-files">Serving Files</h2>
<p>Serving the same page for every request isn&rsquo;t particularly useful,
so let&rsquo;s rewrite our simple server to return files.
The basic logic looks like this:</p>
<div class="language-py" title="file_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">url_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">full_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> unknown&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We first turn the path in the URL into a local file path
by removing the leading <code>/</code>.
Translating filenames this way is called <a class="gl-ref" href="../glossary/#path_resolution" markdown="1">path resolution</a>,
and in doing it,
we assume that all the files we&rsquo;re supposed to serve
live in or below the directory in which the server is running.
If the resolved path corresponds to a file,
we send it back to the client;
if not,
we generate and send an error message.</p>
<p>It might seem simpler to rewrite <code>do_GET</code> to use <code>if</code>/<code>else</code> instead of <code>try</code>/<code>except</code>,
but doing the latter has an advantage:
we can handle errors that occur inside methods we&rsquo;re calling (like <code>handle_file</code>)
in the same place and in the same way as we handle errors that occur here.
This approach is sometimes called <a class="gl-ref" href="../glossary/#throw_low_catch_high" markdown="1">throw low, catch high</a>,
which means that errors should be flagged in many places
but handled in a few places high up in the code.
The method that handles files is an example of this:</p>
<div class="language-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">given_path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot read </span><span class="si">{</span><span class="n">given_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>If there&rsquo;s an error at any point in the processing cycle,
we send a page with an error message
<em>and</em> an error status code.
The former gives human users something to read,
while the latter gives software a meaningful value in a predictable place:</p>
<div class="language-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">ERROR_PAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The error page is just HTML with some placeholders for the path and message:</p>
<div class="language-py" title="file_server.py">
<div class="highlight"><pre><span></span><code><span class="n">ERROR_PAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">  &lt;head&gt;&lt;title&gt;Error accessing </span><span class="si">{path}</span><span class="s2">&lt;/title&gt;&lt;/head&gt;</span>
<span class="s2">  &lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;Error accessing </span><span class="si">{path}</span><span class="s2">: </span><span class="si">{msg}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">  &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>
</div>
<p class="continue">The code that actually sends the response is similar to what we&rsquo;ve seen before:</p>
<div class="language-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">send_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>
</div>
<p>This server works, but only for a very forgiving definition of &ldquo;works&rdquo;.
We are careful not to show clients the actual paths to files on the server
in our error messages,
but if someone asked for <code>http://localhost:8080/../../passwords.txt</code>,
this server will happily look two levels up from the directory where it&rsquo;s running
and try to return that file.
The server machine&rsquo;s passwords probably aren&rsquo;t stored there,
but with enough <code>..</code>&rsquo;s and some patience,
an attacker could poke around large parts of our filesystem.
We will tackle this in the exercises.</p>
<p>Another problem is that <code>send_content</code> always tells clients that
it is returning an HTML file with the <code>Content-Type</code> header.
It should instead look at the extension on the file&rsquo;s name
and set the content type appropriately,
e.g.,
return <code>image/png</code> for a PNG-formatted image.</p>
<p>One thing the server is doing right is <span class="ix-entry" ix-key="character encoding" markdown="1">character encoding</span>.
The <code>send_content</code> method expects <code>content</code> to be a <code>bytes</code> object,
not a string,
because the HTTP protocol requires the content length to be the number of bytes.
The server reads files in <span class="ix-entry" ix-key="binary mode" markdown="1">binary mode</span>
by using <code>"rb"</code> instead of just <code>"r"</code> when it opens files in <code>handle_file</code>,
converts the internally-generated error page from characters to bytes
using the <span class="ix-entry" ix-key="UTF-8" markdown="1">UTF-8</span> encoding
and specifies <code>charset=utf-8</code> as part of the content type.</p>
<h2 id="http-testing">Testing</h2>
<p>As with the server in <a href="../ftp/">Chapter&nbsp;21</a>,
we can work backward from a test we want to be able to write
to create a testable server.
We would like to create a file,
simulate an HTTP GET request,
and check that the status, headers, and content are correct.
<a class="fig-ref" href="../http/#http-inheritance">Figure&nbsp;22.2</a> shows the final <span class="ix-entry" ix-key="inheritance" markdown="1">inheritance</span> hierarchy:</p>
<ul>
<li>
<p><code>BaseHTTPRequestHandler</code> comes from the <span class="ix-entry" ix-key="Python standard library" markdown="1">Python standard library</span>.</p>
</li>
<li>
<p><code>MockRequestHandler</code> defines replacements for its method.</p>
</li>
<li>
<p><code>ApplicationRequestHandler</code> contains our server&rsquo;s logic.</p>
</li>
<li>
<p><code>RequestHandler</code> combines our application code
    with Python&rsquo;s request handler.</p>
</li>
<li>
<p><code>MockHandler</code> combines it with our mock request handler.</p>
</li>
</ul>
<p>It&rsquo;s a lot of work to test a single GET request,
but we can re-use <code>MockRequestHandler</code> to test
the application-specific code for other servers.
Most libraries don&rsquo;t provide helper classes like this to support testing,
but programmers appreciate those that do.</p>
<figure id="http-inheritance">
<img src="./inheritance.svg" alt="Testing class hierarchy"/>
<figcaption>Figure&nbsp;22.2: Class hierarchy for a testable server.</figcaption>
</figure>

<p><code>MockRequestHandler</code> is just a few lines of code,
though it would be longer if our application relied on
more methods from the library class we&rsquo;re replacing:</p>
<div class="pagebreak"></div>

<div class="language-py" title="mock_handler.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="k">class</span> <span class="nc">MockRequestHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">send_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">end_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p>The application-specific class contains the code we&rsquo;ve already seen:</p>
<div class="language-py" title="testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ApplicationRequestHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">url_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">full_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown object &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ...etc...</span>
</code></pre></div>
</div>
<p><code>MockHandler</code> handles the simulated request
and also stores the values that the client would receive:</p>
<div class="language-py" title="test_testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_existing_path</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;actual&quot;</span>
    <span class="n">content_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content_str</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;/actual.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">content_str</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">MockHandler</span><span class="p">(</span><span class="s2">&quot;/actual.txt&quot;</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">do_GET</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">==</span> \
        <span class="p">[</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">==</span> \
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content_bytes</span><span class="p">))]</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="o">==</span> <span class="n">content_bytes</span>
</code></pre></div>
</div>
<p>The main body of our runnable server
combines the two classes to create what it needs:</p>
<div class="language-py" title="testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span>
            <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span>
            <span class="n">ApplicationRequestHandler</span>
    <span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">serverAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">serverAddress</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">Our tests,
on the other hand,
create a server with mocked methods:</p>
<div class="language-py" title="test_testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MockHandler</span><span class="p">(</span>
        <span class="n">MockRequestHandler</span><span class="p">,</span>
        <span class="n">ApplicationRequestHandler</span>
<span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
</div>
<h2 id="http-summary">Summary</h2>
<p><a class="fig-ref" href="../http/#http-concept-map">Figure&nbsp;22.3</a> summarizes the ideas introduced in this chapter.
Given the impact the World-Wide Web has had,
newcomers are often surprised by how simple of HTTP actually is.</p>
<figure id="http-concept-map" class="here">
<img src="./concept_map.svg" alt="HTTP concept map"/>
<figcaption>Figure&nbsp;22.3: HTTP concept map.</figcaption>
</figure>

<h2 id="http-exercises">Exercises</h2>
<h3 class="exercise">Parsing HTTP Requests</h3>
<p>Write a function that takes a list of lines of text as input
and parses them as if they were an HTTP request.
The result should be a dictionary with the request&rsquo;s method,
URL,
protocol version,
and headers.</p>
<h3 class="exercise">Query Parameters</h3>
<p>A URL can contain <a class="gl-ref" href="../glossary/#query_parameter" markdown="1">query parameters</a>.
Read the documentation for the <a href="https://docs.python.org/3/library/urllib.parse.html"><code>urlparse</code></a> module
and then modify the file server example so that
a URL containing a query parameter <code>bytes=N</code>
(for a positive integer N)
returns the first N bytes of the requested file.</p>
<h3 class="exercise">Better Path Resolution</h3>
<p>Modify the file server so that:</p>
<ol>
<li>
<p>it must be given the absolute path to a directory
    as a command-line argument
    when started; and</p>
</li>
<li>
<p>it only serves files in or below that directory
    (so that paths containing <code>..</code> and other tricks
    can&rsquo;t be used to retrieve arbitrary files).</p>
</li>
</ol>
<h3 class="exercise">Better Content Types</h3>
<p>Read the documentation for the <a href="https://docs.python.org/3/library/mimetypes.html"><code>mimetypes</code></a> module
and then modify the file server to return the correct content type
for files that aren&rsquo;t HTML (such as images).</p>
<h3 class="exercise">Uploading Files</h3>
<p>Modify the file server to handle POST requests.</p>
<ol>
<li>
<p>The URL must specify the name of the file being uploaded.</p>
</li>
<li>
<p>The body of the request must be the bytes of the file.</p>
</li>
<li>
<p>All uploaded files are saved in a single directory,
    i.e.,
    upload paths cannot contain directory components.</p>
</li>
</ol>
<h3 class="exercise">Checking Content Length</h3>
<p>Modify the file server so that:</p>
<ol>
<li>
<p>if the client sends more content than indicated in the <code>Content-Length</code> header,
    the extra bytes are read but ignored; and</p>
</li>
<li>
<p>if the client sends less content,
    the server doesn&rsquo;t wait indefinitely for the missing bytes.</p>
</li>
</ol>
<p>What status code should the server return to the client in each case?</p>
<h3 class="exercise">Directory Listing</h3>
<ol>
<li>
<p>Modify the file server so that
    if the path portion of the URL identifies a directory,
    the server returns a plain text list of the directory&rsquo;s contents.</p>
</li>
<li>
<p>Write tests for this using the <a href="https://pytest-pyfakefs.readthedocs.io/"><code>pyfakefs</code></a> module.</p>
</li>
</ol>
<h3 class="exercise">Dynamic Results</h3>
<p>Modify the file server so that if the client requests the &ldquo;file&rdquo; <code>/time</code>,
the server returns an HTML page that reports the current time on the server&rsquo;s machine.</p>
<h3 class="exercise">Templated Results</h3>
<p>Modify the file server to:</p>
<ol>
<li>
<p>turn the query parameters in the URL into a dictionary;</p>
</li>
<li>
<p>use that dictionary to fill in a template page (<a href="../template/">Chapter&nbsp;12</a>); and</p>
</li>
<li>
<p>return the resulting HTML page to the client.</p>
</li>
</ol>
	</main>
	<footer>
  © 2024 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sdxpy">repository</a>
  &middot;
  <a href="../license/">license</a>
  &middot;
  <a href="mailto:gvwilson@third-bit.com">contact</a>
</footer>

      </div>
    </div>
  </body>
</html>
