<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="repo" content="https://github.com/gvwilson/sdxpy">
  <meta name="build_date" content="2023-07-10">
  <meta name="template" content="default">
  <meta name="major" content="Appendix B">
  
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design by Example: Bonus Material</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design by Example</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../intro/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Objects and Classes
    </a>
  </li>
  
  <li>
    <a href="../dup/">
      Finding Duplicate Files
    </a>
  </li>
  
  <li>
    <a href="../glob/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parse/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../test/">
      Running Tests
    </a>
  </li>
  
  <li>
    <a href="../interp/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../func/">
      Functions and Closures
    </a>
  </li>
  
  <li>
    <a href="../reflect/">
      Reflection
    </a>
  </li>
  
  <li>
    <a href="../archive/">
      A File Archiver
    </a>
  </li>
  
  <li>
    <a href="../check/">
      An HTML Validator
    </a>
  </li>
  
  <li>
    <a href="../template/">
      A Template Expander
    </a>
  </li>
  
  <li>
    <a href="../lint/">
      A Code Linter
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../perf/">
      Performance Profiling
    </a>
  </li>
  
  <li>
    <a href="../persist/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../db/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../build/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../pack/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../ftp/">
      Transferring Files
    </a>
  </li>
  
  <li>
    <a href="../http/">
      Serving Web Pages
    </a>
  </li>
  
  <li>
    <a href="../viewer/">
      A File Viewer
    </a>
  </li>
  
  <li>
    <a href="../undo/">
      Undo and Redo
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../finale/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bib/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../bonus/">
      <strong>Bonus Material</strong>
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../slides/">
      Slides
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contrib/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Appendix B: Bonus Material</h1>


          
<div class="draft notex">
  <p>DRAFT</p>
  <p>
    <em>Please use section heading links to submit feedback.</em>
  </p>
</div>


          
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


          
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>, <a class="gl-ref" href="../glossary/#attention_budget" markdown="1">attention budget</a>, <a class="gl-ref" href="../glossary/#exponent" markdown="1">exponent</a>, <a class="gl-ref" href="../glossary/#mantissa" markdown="1">mantissa</a>, <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>
</p>


          <div class="page-toc"></div>
          <p>Each of the chapters in this book has been designed to fit into an hour (and a bit).
This appendix presents material that extends core ideas
but would bust that <a class="gl-ref" href="../glossary/#attention_budget" title="The amount of time your activity is allowed to require of other people in an organization." markdown="1">attention budget</a>.</p>
<h2 id="bonus-attributes">Section B.1: Using Function Attributes</h2>
<p><em>This material extends <a class="x-ref" href="../test/">Chapter 6</a>.</em></p>
<p>Since functions are objects,
they can have attributes.
The function <code>dir</code> (short for &ldquo;directory&rdquo;) returns a list of those attributes&rsquo; names:</p>
<div class="code-sample lang-py" title="func_dir.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="s2">&quot;Docstring for example.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in example&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">example</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_dir.out">
<div class="highlight"><pre><span></span><code>[&#39;__annotations__&#39;, &#39;__builtins__&#39;, &#39;__call__&#39;, &#39;__class__&#39;, \
&#39;__closure__&#39;, &#39;__code__&#39;, &#39;__defaults__&#39;, &#39;__delattr__&#39;, \
&#39;__dict__&#39;, &#39;__dir__&#39;, &#39;__doc__&#39;, &#39;__eq__&#39;, &#39;__format__&#39;, &#39;__ge__&#39;, \
&#39;__get__&#39;, &#39;__getattribute__&#39;, &#39;__getstate__&#39;, &#39;__globals__&#39;, \
&#39;__gt__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__init_subclass__&#39;, \
&#39;__kwdefaults__&#39;, &#39;__le__&#39;, &#39;__lt__&#39;, &#39;__module__&#39;, &#39;__name__&#39;, \
&#39;__ne__&#39;, &#39;__new__&#39;, &#39;__qualname__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, \
&#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, \
&#39;__subclasshook__&#39;]
</code></pre></div>
</div>
<p>Most programmers never need to use most of these,
but <code>__name__</code> holds the function&rsquo;s original name
and <code>__doc__</code> holds its <span class="ix-entry" ix-key="docstring" markdown="1">docstring</span>:</p>
<div class="code-sample lang-py" title="func_attr.py">
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;docstring:&quot;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;name:&quot;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_attr.out">
<div class="highlight"><pre><span></span><code>docstring: Docstring for example.
name: example
</code></pre></div>
</div>
<p>We can modify our test runner to use this for reporting tests&rsquo; results
using the function&rsquo;s <code>__name__</code> attribute
instead of the key in the <code>globals</code> dictionary:</p>
<div class="code-sample lang-py" title="with_name.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;passed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;had error&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="with_name.out">
<div class="highlight"><pre><span></span><code>test_sign_negative passed
test_sign_positive passed
test_sign_zero failed
test_sign_error had error
</code></pre></div>
</div>
<p>More usefully,
we can say that if a test function&rsquo;s docstring contains the string <code>"test:skip"</code>
then we should skip the test,
while <code>"test:fail"</code> means we expect this test to fail.
Let&rsquo;s rewrite our tests to show this off:</p>
<div class="code-sample lang-py" title="docstring.py">
<div class="highlight"><pre><span></span><code><span class="n">TEST_FAIL</span> <span class="o">=</span> <span class="s2">&quot;test:fail&quot;</span>
<span class="n">TEST_SKIP</span> <span class="o">=</span> <span class="s2">&quot;test:skip&quot;</span>

<span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="s2">&quot;test:skip&quot;</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="s2">&quot;test:fail&quot;</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expect an error.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">and then modify <code>run_tests</code> to look for these strings and act accordingly:</p>
<div class="code-sample lang-py" title="docstring.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">and</span> <span class="n">TEST_SKIP</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skip: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TEST_FAIL</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass (expected failure): </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fail: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">doc</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The output is now:</p>
<div class="code-sample lang-out" title="docstring.out">
<div class="highlight"><pre><span></span><code>skip: test_sign_negative
pass: test_sign_positive
pass (expected failure): test_sign_zero
error: test_sign_error/Expect an error. name &#39;sgn&#39; is not defined
</code></pre></div>
</div>
<p>Instead of (ab)using docstrings like this,
we can add attributes of our own to test functions.
Let&rsquo;s say that if a function has an attribute called <code>skip</code> with the value <code>True</code>
then the function is to be skipped,
while if it has an attribute called <code>fail</code> whose value is <code>True</code>
then the test is expected to fail.
Our tests become:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">test_sign_negative</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">test_sign_zero</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>We can write a helper function called <code>classify</code> to classify tests.
Note that it uses <code>hasattr</code> to check if an attribute is present
before trying to get its value:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;skip&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;fail&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;run&quot;</span>
</code></pre></div>
</div>
<p>Finally,
our test runner becomes:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;skip&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skip: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;fail&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass (expected failure): </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fail: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="bonus-lazy">Section B.2: Lazy Evaluation</h2>
<p><em>This material extends <a class="x-ref" href="../interp/">Chapter 7</a>.</em></p>
<p>One way to evaluate a design is to ask how <span class="ix-entry" ix-key="extensibility" markdown="1">extensible</span> it is.
The answer for our interpreter is now, &ldquo;Pretty easily.&rdquo;
For example,
we can add a <code>comment</code> &ldquo;operation&rdquo; that does nothing and returns <code>None</code>
simply by writing <code>do_comment</code> function:</p>
<div class="code-sample lang-py" title="stmt.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_comment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ignore instructions.</span>
<span class="sd">    [&quot;comment&quot; &quot;text&quot;] =&gt; None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p>An <code>if</code> statement is a bit more complex.
If its first argument is true it evaluates and returns its second argument
(the &ldquo;if&rdquo; branch).
Otherwise,
it evaluates and returns its second argument (the &ldquo;else&rdquo; branch):</p>
<div class="code-sample lang-py" title="stmt.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_if</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a choice: only one sub-expression is evaluated.</span>
<span class="sd">    [&quot;if&quot; C A B] =&gt; A if C else B</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">As we said in <a class="x-ref" href="../func/">Chapter 8</a>,
this is called <span class="ix-entry" ix-key="lazy evaluation" markdown="1">lazy evaluation</span>
to distinguish it from the more usual <span class="ix-entry" ix-key="eager evaluation" markdown="1">eager evaluation</span>
that evaluates everything up front.
<code>do_if</code> only evaluates what it absolutely needs to;
most languages do this so that we can safely write things like:</p>
<div class="code-sample lang-py" title="lazy.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">x</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p class="continue">If the language always evaluated both branches
then the code shown above would fail whenever <code>x</code> was zero,
even though it&rsquo;s supposed to handle that case.
In this case it might seem obvious what the language should do,
but most languages use lazy evaluation for <code>and</code> and <code>or</code> as well
so that expressions like:</p>
<div class="highlight"><pre><span></span><code><span class="n">thing</span> <span class="ow">and</span> <span class="n">thing</span><span class="o">.</span><span class="n">part</span>
</code></pre></div>
<p class="continue">will produce <code>None</code> if <code>thing</code> is <code>None</code>
and <code>reference.part</code> if it isn&rsquo;t.</p>
<h2 id="bonus-inheritance">Section B.3: Tracing Inheritance</h2>
<p><em>This material extends <a class="x-ref" href="../lint/">Chapter 13</a>.</em></p>
<p>For our last example of finding things,
let&rsquo;s build a tool that tells us which methods are defined in which classes.
(We used a tool like this when writing this book
to keep track of examples that evolved step by step.)
Here&rsquo;s a test file that defines four classes,
each of which defines or redefines some methods:</p>
<div class="code-sample lang-py" title="inheritance_example.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">green</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">LeftChild</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">green</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">blue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RightChild</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">blue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">GrandChild</span><span class="p">(</span><span class="n">LeftChild</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">blue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">orange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p>As before,
our class&rsquo;s constructor creates a stack to keep track of where we are.
It also creates a couple of dictionaries to keep track of
how classes inherit from each other
and the methods each class defines:</p>
<div class="code-sample lang-py" title="inheritance.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FindClassesAndMethods</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>
</div>
<p>When we encounter a new class definition,
we push its name on the stack,
record its parents,
and create an empty set to hold its methods:</p>
<div class="code-sample lang-py" title="inheritance.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
    <span class="k">assert</span> <span class="n">class_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">bases</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>
</div>
<p>When we encounter a function definition,
the first thing we do is check the stack.
If it&rsquo;s empty,
we&rsquo;re looking at a top-level function rather than a method,
so there&rsquo;s nothing for us to do.
(We actually should recurse through the function&rsquo;s children,
since it&rsquo;s possible to define classes inside functions,
but we&rsquo;ll leave as an exercise.)
If this function definition is inside a class,
on the other hand,
we add its name to our records:</p>
<div class="code-sample lang-py" title="inheritance.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
    <span class="k">assert</span> <span class="n">method_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Once we&rsquo;re done searching the AST we print out a table
of the classes and methods we&rsquo;ve seen (<a class="tbl-ref" href="../bonus/#linter-inheritance">Table B.1</a>).
We could make this display easier to read—for example,
we could sort the classes from parent to child
and display methods in the order in which they were first defined—but
none of that requires us to inspect the AST.</p>
<div class="table"><table id="linter-inheritance"><caption>Table B.1: Inheritance and methods</caption>
<thead>
<tr>
<th></th>
<th>GrandChild</th>
<th>LeftChild</th>
<th>Parent</th>
<th>RightChild</th>
</tr>
</thead>
<tbody>
<tr>
<td>blue</td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>green</td>
<td></td>
<td>X</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>orange</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>red</td>
<td>X</td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
</tbody>
</table>
</div>
<h2 id="bonus-float">Section B.4: Floating Point Numbers</h2>
<p><em>This material extends <a class="x-ref" href="../binary/">Chapter 17</a>.</em></p>
<p>The rules for floating point numbers make Unicode look simple.
The root of the problem is that
we cannot represent an infinite number of real values
with a finite set of bit patterns.
And no matter what values we represent,
there will be an infinite number of values between each of them that we can&rsquo;t.</p>
<div class="callout">
<h3>Go To the Source</h3>
<p>The explanation that follows is simplified to keep it manageable;
please read <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Goldberg1991">Goldberg1991</a>]</span> for more detail.</p>
</div>
<p>Floating point numbers are represented by a sign,
a <a class="gl-ref" href="../glossary/#mantissa" title="The portion of a floating-point number that defines its specific value." markdown="1">mantissa</a>,
and an <a class="gl-ref" href="../glossary/#exponent" title="The portion of a floating-point number that controls placement of the decimal point." markdown="1">exponent</a>.
In a 32-bit <span class="ix-entry" ix-key="word (of memory)" markdown="1">word</span>
the <span class="ix-entry" ix-key="IEEE 754 standard" markdown="1">IEEE 754</span> standard calls for 1 bit of sign,
23 bits for the mantissa,
and 8 bits for the exponent.
We will illustrate how it works using a much smaller representation:
no sign,
3 bits for the mantissa,
and 2 for the exponent.
<a class="fig-ref" href="../bonus/#bonus-floating-point">Figure B.1</a> shows the values this scheme can represent.</p>
<figure id="bonus-floating-point">
<img src="./floating_point.svg" alt="Representing floating point numbers"/>
<figcaption markdown="1">Figure B.1: Representing floating point numbers.</figcaption>
</figure>

<p>The IEEE standard avoids the redundancy in this representation by shifting things around.
Even with that,
though,
formats like this can&rsquo;t represent a lot of values:
for example,
ours can store 8 and 10 but not 9.
This is exactly like the problem hand calculators have
with fractions like 1/3:
in decimal, we have to round that to 0.3333 or 0.3334.</p>
<p>But if this scheme has no representation for 9
then \( 8+1 \) must be stored as either 8 or 10.
What should \( 8+1+1 \) be?
If we add from the left,
\( (8+1)+1 \( is \( 8+1 \) is 8,
but if we add from the right,
\( 8+(1+1) \) is \( 8+2 \) is 10.
Changing the order of operations makes the difference between right and wrong.</p>
<p>The authors of numerical libraries spend a lot of time worrying about things like this.
In this case
sorting the values and adding them from smallest to largest
gives the best chance of getting the best possible answer.
In other situations,
like inverting a matrix, the rules are much more complicated.</p>
<p>Another observation about our number line is that
while the values are unevenly spaced,
the <em>relative</em> spacing between each set of values stays the same:
the first group is separated by 1,
then the separation becomes 2,
then 4,
and so on.
This observation leads to a couple of useful definitions:</p>
<ul>
<li>
<p>The <a class="gl-ref" href="../glossary/#absolute_error" title="The absolute value of the difference between the observed and the correct value. Absolute error is usually less useful than relative error." markdown="1">absolute error</a> in an approximation
    is the absolute value of the difference
    between the approximation and the actual value.</p>
</li>
<li>
<p>The <a class="gl-ref" href="../glossary/#relative_error" title="The absolute value of the difference between the actual and correct value divided by the correct value. For example, if the actual value is 9 and the correct value is 10, the relative error is 0.1. Relative error is usually more useful than absolute error." markdown="1">relative error</a>
    is the ratio of the absolute error
    to the absolute value we&rsquo;re approximating.</p>
</li>
</ul>
<p>For example,
being off by 1 in approximating 8+1 and 56+1 is the same absolute error,
but the relative error is larger in the first case than in the second.
Relative error is almost always more useful than absolute:
it makes little sense to say that we&rsquo;re off by a hundredth
when the value in question is a billionth.</p>
<p>One implication of this is that
we should never compare floating point numbers with <code>==</code> or <code>!=</code>
because two numbers calculated in different ways
will probably not have exactly the same bits.
It&rsquo;s safe to use <code>&lt;</code>, <code>&gt;=</code>, and other orderings,
though,
since they don&rsquo;t depend on being the same down to the last bit.</p>
<p>If we do want to compare floating point numbers
we can use something like <a href="https://docs.pytest.org/en/4.6.x/reference.html#pytest-approx">the <code>approx</code> class</a> from <a href="https://docs.pytest.org/">pytest</a>
which checks whether two numbers are within some tolerance of each other.
A completely different approach is to use something like
the <a href="https://docs.python.org/3/library/fractions.html">fractions</a> module,
which (as its name suggests) uses numerators and denominators
to avoid some precision issues.
<a href="https://www.textualize.io/blog/posts/7-things-about-terminals">This post</a> describes one clever use of the module.</p>
<h2 id="bonus-exercises">Section B.5: Exercises</h2>
<h3 class="exercise">Roundoff</h3>
<ol>
<li>Write a program that loops over the integers from 1 to 9
    and uses them to create the values 0.9, 0.09, and so on.</li>
<li>Calculate the same values by subtracting 0.1 from 1,
    then subtracting 0.01,
    and so on.</li>
<li>Calculate the absolute and relative differences between corresponding values
    (which should be identical).</li>
<li>Repeat the exercise using the <code>Fraction</code> class
    from the <a href="https://docs.python.org/3/library/fractions.html">fractions</a> module.</li>
</ol>
        </main>
      </div>
    </div>
  </body>
</html>
