<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../../logo.svg">
<link rel="stylesheet" href="../../tango.css" type="text/css">
<link rel="stylesheet" href="../../mccole.css" type="text/css">
<title>Software Design by Example &middot; A File Viewer</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


    <script src="../../slides.js" defer></script>
    <link rel="stylesheet" href="../../slides.css">
  </head>
  <body>
<div class="row notex titleslide">
  <div class="col-4">
    <img src="../../sdxpy-cover.png" alt="book cover" />
  </div>
  <div class="col-8">
    <h1>A File Viewer</h1>
  </div>
</div>
<hr>
<h2>The Problem</h2>
<ul>
<li>
<p>We have been editing a lot of files</p>
</li>
<li>
<p>How can we display a text file in a window?</p>
</li>
<li>
<p>How can we move around in that file?</p>
</li>
<li>
<p>How we can change it will be the topic of <a href="../../undo/">Chapter&nbsp;24</a></p>
</li>
</ul>
<hr />
<h2>Curses</h2>
<div class="language-py" title="first_curses.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">curses</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>
<p>The <a href="https://docs.python.org/3/library/curses.html">curses</a> library handles interaction with a text terminal</p>
</li>
<li>
<p><code>curses.wrapper</code> takes a function of a single argument</p>
</li>
<li>
<p>Does setup, then calls that function with a standard screen</p>
</li>
<li>
<p>This program just gobbles keystrokes: stop it with Ctrl-C</p>
</li>
</ul>
<hr />
<h2>Debugging</h2>
<ul>
<li>
<p>Printing messages or single-stepping with a debugger is tricky</p>
</li>
<li>
<p>Create a simple logging function</p>
</li>
</ul>
<div class="language-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="n">LOG</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">open_log</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">LOG</span>
    <span class="n">LOG</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">LOG</span><span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Debugging</h2>
<div class="language-py" title="logging_curses.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="n">util</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">util</span><span class="o">.</span><span class="n">open_log</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Print representation of characters to file (so that <code>\n</code> shows up)</p>
</li>
<li>
<p>Exit cleanly</p>
</li>
</ul>
<hr />
<h2>Showing Lines</h2>
<div class="language-py" title="show_lines.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">stdscr</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">stdscr</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Screen coordinates put (0, 0) in the upper left</p>
</li>
<li>
<p>And use (y, x) rather than (x, y)</p>
</li>
</ul>
<hr />
<h2>Showing Lines</h2>
<div class="language-py" title="show_lines.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">num_lines</span><span class="p">,</span> <span class="n">logfile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">make_lines</span><span class="p">(</span><span class="n">num_lines</span><span class="p">)</span>
    <span class="n">open_log</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stdscr</span><span class="p">:</span> <span class="n">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Make lines for testing rather than showing file</p>
</li>
<li>
<p>Open the log file</p>
</li>
<li>
<p>Use <code>lambda</code> to make a one-parameter function for <code>curses.wrapper</code></p>
</li>
</ul>
<hr />
<h2>Making Lines</h2>
<div class="language-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">string</span><span class="w"> </span><span class="kn">import</span> <span class="n">ascii_lowercase</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_lines</span><span class="p">(</span><span class="n">num_lines</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">ascii_lowercase</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ascii_lowercase</span><span class="p">)]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<div class="language-out" title="make_lines.out">
<div class="highlight"><pre><span></span><code>a
b0
c01
d012
e0123
</code></pre></div>
</div>
<hr />
<h2>Windowing</h2>
<ul>
<li>
<p>Run program with 100 lines (or anything else larger than screen)</p>
</li>
<li>
<p><code>_curses.error: addwstr() returned ERR</code> because trying to draw outside screen</p>
</li>
<li>
<p>So create a <code>Window</code> class that knows how big the screen is</p>
</li>
</ul>
<div class="language-py" title="use_window.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Window</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">curses</span><span class="o">.</span><span class="n">LINES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="n">curses</span><span class="o">.</span><span class="n">COLS</span><span class="p">])</span>
</code></pre></div>
</div>
<hr />
<h2>Windowing</h2>
<div class="language-py" title="use_window.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">stdscr</span><span class="p">)</span>
    <span class="n">window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Can&rsquo;t create <code>Window</code> before calling <code>curses.wrapper</code> because it needs the screen</p>
</li>
<li>
<p><a class="gl-ref" href="../../glossary/#delayed_construction" markdown="1">Delayed construction</a></p>
</li>
</ul>
<hr />
<!--# class="aside" -->

<h2>Optimization</h2>
<ul>
<li>
<p><code>Window</code> re-draws everything after every keystroke</p>
</li>
<li>
<p>Fast enough that people (usually) won&rsquo;t notice</p>
</li>
<li>
<p>But an obvious target for optimization</p>
</li>
</ul>
<hr />
<h2>Sizing the Window</h2>
<ul>
<li>
<p>Allow users to specify how big the window appears to be</p>
</li>
<li>
<p>Helps with testing</p>
</li>
</ul>
<div class="language-py" title="size_window.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Window</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nrow</span> <span class="o">=</span> <span class="n">curses</span><span class="o">.</span><span class="n">LINES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span> <span class="o">=</span> <span class="n">curses</span><span class="o">.</span><span class="n">COLS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nrow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="n">ROW</span><span class="p">],</span> <span class="n">curses</span><span class="o">.</span><span class="n">LINES</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="n">COL</span><span class="p">],</span> <span class="n">curses</span><span class="o">.</span><span class="n">COLS</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrow</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span><span class="p">])</span>
</code></pre></div>
</div>
<hr />
<h2>Two Dimensions</h2>
<ul>
<li>
<p>Use <code>ROW</code> and <code>COL</code> instead of 0 and 1 (or <code>R</code> and <code>C</code>)</p>
</li>
<li>
<p>Should really create an <a class="gl-ref" href="../../glossary/#enumeration" markdown="1">enumeration</a></p>
</li>
</ul>
<div class="language-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="n">ROW</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">COL</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<div class="language-py" title="cursor_const.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Window</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">[</span><span class="n">ROW</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">[</span><span class="n">COL</span><span class="p">]])</span>
</code></pre></div>
</div>
<hr />
<h2>Moving the Cursor</h2>
<div class="language-py" title="move_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Cursor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<ul>
<li><code>Cursor.pos</code> returns location as tuple so caller can&rsquo;t modify it</li>
</ul>
<hr />
<h2>Moving the Cursor</h2>
<div class="language-py" title="move_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">stdscr</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_UP&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_DOWN&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_LEFT&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">left</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_RIGHT&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
</code></pre></div>
</div>
<ul>
<li>
<p><a class="gl-ref" href="../../glossary/#spread" markdown="1">Spread</a> position into <code>stdscr.move</code></p>
</li>
<li>
<p>Screen&rsquo;s <code>getkey</code> method returns names of cursor keys</p>
</li>
</ul>
<hr />
<h2>Boom</h2>
<ul>
<li>
<p>We can move right or below text</p>
</li>
<li>
<p>And blow up when moving off left of screen or off top with
    <code>_curses.error: wmove() returned ERR</code></p>
</li>
<li>
<p>Do some <a class="gl-ref" href="../../glossary/#refactor" markdown="1">refactoring</a> before fixing this problem</p>
</li>
</ul>
<hr />
<h2>Application Class</h2>
<ul>
<li>
<p>Create an object with a <code>__call__</code> method</p>
</li>
<li>
<p>Fool <code>curses.wrapper</code> into thinking we have given it a function</p>
</li>
</ul>
<div class="language-py" title="main_app.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MainApp</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">=</span> <span class="n">lines</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">screen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">()</span>
</code></pre></div>
</div>
<hr />
<h2>Application Class</h2>
<div class="language-py" title="main_app.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_UP&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_DOWN&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_LEFT&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">left</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_RIGHT&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
                <span class="k">return</span>
</code></pre></div>
</div>
<div class="language-py" title="main_app.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">MainApp</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Dispatching Keystrokes</h2>
<ul>
<li>Find and call key handlers via <a class="gl-ref" href="../../glossary/#dynamic_dispatch" markdown="1">dynamic dispatch</a></li>
</ul>
<div class="language-py" title="dispatch_keys.py">
<div class="highlight"><pre><span></span><code>    <span class="n">TRANSLATE</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;</span><span class="se">\x18</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;CONTROL_X&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRANSLATE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_CONTROL_X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_do_KEY_UP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
</code></pre></div>
</div>
<hr />
<h2>Dispatching Keystrokes</h2>
<div class="language-py" title="dispatch_keys.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DispatchApp</span><span class="p">(</span><span class="n">MainApp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interact</span><span class="p">()</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Use a member variable <code>self._running</code> so that every other method
    <em>doesn&rsquo;t</em> have to return a &ldquo;keep running&rdquo; flag</p>
</li>
<li>
<p>Add <code>TRANSLATE</code> to turn things like Ctrl-X into strings <code>CONTROL_X</code></p>
<ul>
<li>Got the value by looking in our log file</li>
</ul>
</li>
</ul>
<hr />
<!--# class="aside" -->

<h2>Inheritance</h2>
<ul>
<li>
<p><code>DispatchApp</code> is a child of <code>MainApp</code> so that we can recycle initialization</p>
</li>
<li>
<p><code>DispatchApp.__init__</code> <a class="gl-ref" href="../../glossary/#upcall" markdown="1">upcalls</a> to <code>MainApp.__init__</code></p>
</li>
<li>
<p>Probably wouldn&rsquo;t create multiple classes in a real program,
    but simplifies exposition when teaching</p>
</li>
<li>
<p>Had to move some earlier code around when writing later classes
    to make everything work cleanly</p>
</li>
<li>
<p><em>This is normal</em></p>
</li>
</ul>
<hr />
<h2>Managing the Buffer</h2>
<div class="language-py" title="buffer_class.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Buffer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Doesn&rsquo;t do much yet, but will later keep track of viewable region</p>
</li>
<li>
<p>Makes a copy of <code>lines</code> so that other code can&rsquo;t change its internals</p>
</li>
</ul>
<hr />
<h2>Changing the Application</h2>
<div class="language-py" title="buffer_class.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BufferApp</span><span class="p">(</span><span class="n">DispatchApp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_window</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_cursor</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">()</span>
</code></pre></div>
</div>
<hr />
<!--# class="aside" -->

<h2>Factory Methods</h2>
<ul>
<li>
<p>Want to re-use as much of <code>BufferApp</code> as possible</p>
</li>
<li>
<p>If <code>setup</code> calls constructors to create window, buffer, and cursor,
    we have to rewrite it each time</p>
</li>
<li>
<p>Putting constructor calls in <a class="gl-ref" href="../../glossary/#factory_method" markdown="1">factory methods</a>
    allows us to override them one by one</p>
</li>
<li>
<p>Could pass classes into <code>BufferApp</code> constructor…</p>
</li>
<li>
<p>…but later on, these objects will need to reference each other</p>
</li>
<li>
<p>Again, moving things around like this is normal</p>
</li>
</ul>
<hr />
<h2>Clipping</h2>
<div class="language-py" title="clip_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClipCursor</span><span class="p">(</span><span class="n">Cursor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">buffer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">nrow</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Clipping</h2>
<div class="language-py" title="clip_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClipBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ncol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ClipApp</span><span class="p">(</span><span class="n">BufferApp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">ClipBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">ClipCursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Add methods to the buffer</p>
</li>
<li>
<p>Construct different cursor and buffer objects
    without changing anything else in the application</p>
</li>
</ul>
<hr />
<h2>A Bug</h2>
<ul>
<li>Move to end of line and go up to shorter line
    leaves cursor outside the text</li>
</ul>
<div class="language-py" title="clip_fixed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClipCursorFixed</span><span class="p">(</span><span class="n">ClipCursor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">],</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
</div>
<ul>
<li>Good design if there&rsquo;s one obvious place to make a change</li>
</ul>
<hr />
<h2>Viewport</h2>
<ul>
<li>
<p>Can still move below the window because cursor is in buffer space not window space</p>
</li>
<li>
<p>What if the buffer is bigger than the window?</p>
</li>
<li>
<p>Need a <a class="gl-ref" href="../../glossary/#viewport" markdown="1">viewport</a> to track
    the currently-visible portion of the buffer</p>
<ul>
<li>Do vertical here and leave horizontal for exercises</li>
</ul>
</li>
</ul>
<hr />
<h2>Buffer</h2>
<div class="language-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ViewportBuffer</span><span class="p">(</span><span class="n">ClipBuffer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_height</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_height</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_height</span> <span class="o">=</span> <span class="n">height</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_height</span>
</code></pre></div>
</div>
<hr />
<h2>Buffer</h2>
<div class="language-py" title="viewport.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<div class="language-py" title="viewport.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bottom</span><span class="p">())</span> <span class="ow">and</span> \
             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bottom</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<hr />
<h2>Application</h2>
<div class="language-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ViewportApp</span><span class="p">(</span><span class="n">ClipAppFixed</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">ViewportBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">ViewportCursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="n">ROW</span><span class="p">])</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">lines</span><span class="p">())</span>
            <span class="n">screen_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">screen_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interact</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">scroll</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Transform buffer coordinates into screen coordinates</p>
</li>
<li>
<p>This class is where we need separate factory methods</p>
</li>
</ul>
<hr />
<h2>Cursor</h2>
<div class="language-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ViewportCursor</span><span class="p">(</span><span class="n">ClipCursorFixed</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">window</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">left</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="n">COL</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<hr />
<!--# class="summary" -->

<h2>Summary</h2>
<figure id="viewer-concept-map">
<img src="../concept_map.svg" alt="Concept map of file viewer"/>
<figcaption>Concept map.</figcaption>
</figure>
  </body>
</html>
