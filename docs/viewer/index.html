<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="repo" content="https://github.com/gvwilson/sdxpy">
  <meta name="build_date" content="2023-11-19">
  <meta name="template" content="default">
  <meta name="major" content="viewer">
  <meta name="has_slides" content="true">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design by Example: A File Viewer</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design by Example</a>
  
</p>

<div class="screen-reader-only">
  <a href="#printable">Skip to content</a>
</div>

<ol class="toc-chapter">
  
  <li>
    <a href="../intro/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Objects and Classes
    </a>
  </li>
  
  <li>
    <a href="../dup/">
      Finding Duplicate Files
    </a>
  </li>
  
  <li>
    <a href="../glob/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parse/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../test/">
      Running Tests
    </a>
  </li>
  
  <li>
    <a href="../interp/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../func/">
      Functions and Closures
    </a>
  </li>
  
  <li>
    <a href="../protocols/">
      Protocols
    </a>
  </li>
  
  <li>
    <a href="../archive/">
      A File Archiver
    </a>
  </li>
  
  <li>
    <a href="../check/">
      An HTML Validator
    </a>
  </li>
  
  <li>
    <a href="../template/">
      A Template Expander
    </a>
  </li>
  
  <li>
    <a href="../lint/">
      A Code Linter
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../perf/">
      Performance Profiling
    </a>
  </li>
  
  <li>
    <a href="../persist/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../db/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../build/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../pack/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../ftp/">
      Transferring Files
    </a>
  </li>
  
  <li>
    <a href="../http/">
      Serving Web Pages
    </a>
  </li>
  
  <li>
    <a href="../viewer/">
      <strong>A File Viewer</strong>
    </a>
  </li>
  
  <li>
    <a href="../undo/">
      Undo and Redo
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../finale/">
      Conclusion
    </a>
  </li>
  
</ol>

<ol class="toc-appendix">
  
  <li>
    <a href="../bib/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../bonus/">
      Bonus Material
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contrib/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>


<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


<p><a href="https://github.com/gvwilson/sdxpy">GitHub repository</a></p>

      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 23: A File Viewer</h1>


          

	  
<div class="chapterinfo">

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">The curses module manages text terminals in a platform-independent way.</li>
  
  <li markdown="1">Write debugging information to a log file when the screen is not available.</li>
  
  <li markdown="1">We can use a callable object in place of a function to satisfy an API's requirements.</li>
  
  <li markdown="1">Test programs using synthetic data.</li>
  
  <li markdown="1">Using delayed construction and/or factory methods can make code easier to evolve.</li>
  
  <li markdown="1">Refactor code before attempting to add new features.</li>
  
  <li markdown="1">Separate the logic for managing data from the logic for displaying it.</li>
  
  </ul>
  

  

  

  



<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#gl:buffer_text" markdown="1">buffer (of text)</a>, <a class="gl-ref" href="../glossary/#gl:delayed_construction" markdown="1">delayed construction</a>, <a class="gl-ref" href="../glossary/#gl:enumeration" markdown="1">enumeration</a>, <a class="gl-ref" href="../glossary/#gl:factory_method" markdown="1">factory method</a>, <a class="gl-ref" href="../glossary/#gl:log_file" markdown="1">log file</a>, <a class="gl-ref" href="../glossary/#gl:synthetic_data" markdown="1">synthetic data</a>, <a class="gl-ref" href="../glossary/#gl:viewport" markdown="1">viewport</a>
</p>


</div>


          <div class="page-toc"></div>
          <p>Before they need version control tools or interpreters,
programmers need a way to edit text files.
Even simple editors like Notepad and <a href="https://www.nano-editor.org/">Nano</a> do a lot of things:
moving a cursor,
inserting and deleting characters,
and more.
This is too much to fit into one lesson,
so this chapter builds a tool for viewing files,
which <a class="x-ref" href="../undo/">Chapter 24</a> extends to create an editor with undo and redo.
Our example is inspired by <a href="https://wasimlorgat.com/posts/editor.html">this tutorial</a>
written by <a href="https://wasimlorgat.com/">Wasim Lorgat</a>.</p>
<h2 id="viewer-curses">Section 23.1: Curses</h2>
<p>Our starting point is the <a href="https://docs.python.org/3/library/curses.html"><code>curses</code></a> module,
which handles interaction with text terminals on several different operating systems
in a uniform way.
A very simple curses-based program looks like this:</p>
<div class="code-sample lang-py" title="first_curses.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">curses</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div>
</div>
<p><code>curses.wrapper</code> takes a function with a single parameter as input,
does some setup,
and then calls that function with an object
that acts as an interface to the screen.
(It is called <code>stdscr</code>, for &ldquo;standard screen&rdquo;,
by analogy with standard input <code>stdin</code> and standard output <code>stdout</code>.)
Our function <code>main</code> is just an infinite loop that consumes keystrokes
but does nothing with them.
When we run the program,
it clears the screen and waits for the user to interrupt it by typing Ctrl-C.</p>
<p>We&rsquo;d like to see what the user is typing,
but since the program has taken over the screen,
<code>print</code> statements won&rsquo;t be of use.
Running this program inside a single-stepping debugger is challenging
for the same reason,
so for the moment we will cheat and create a <a class="gl-ref" href="../glossary/#gl:log_file" title="A file to which a program writes status or debugging information for later analysis." markdown="1">log file</a>
for the program to write to:</p>
<div class="code-sample lang-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="n">LOG</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">open_log</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">LOG</span>
    <span class="n">LOG</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">LOG</span><span class="p">)</span>
</code></pre></div>
</div>
<p>With this in hand,
we can rewrite our program to take the name of the log file
as its sole command-line argument
and print messages to that file to show the keys that are being pressed.
We can also modify the program so that when the user presses <code>q</code>,
the program exits cleanly:</p>
<div class="code-sample lang-py" title="logging_curses.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="n">util</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">util</span><span class="o">.</span><span class="n">open_log</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">Notice that we print the representation of the characters using <code>repr</code>
so that (for example)
a newline character shows up in the file as <code>'\n'</code>
rather than as a blank line.</p>
<p>We are now ready to actually show some text.
Given a list of strings,
the revised <code>main</code> function below will repeatedly:</p>
<ol>
<li>
<p>clear the screen;</p>
</li>
<li>
<p>display each line of text in the correct location;</p>
</li>
<li>
<p>wait for a keystroke; and</p>
</li>
<li>
<p>exit if the key is a <code>q</code>.</p>
</li>
</ol>
<div class="code-sample lang-py" title="show_lines.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">stdscr</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">stdscr</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
</code></pre></div>
</div>
<p>Two things about this function need to be kept in mind.
First, as explained in <a class="x-ref" href="../layout/">Chapter 14</a>,
screens put (0, 0) in the upper left rather than the lower left,
and increasing values of Y move down rather than up.
To make things even more confusing,
<code>curses</code> uses (row, column) coordinates,
so we have to remember to write (y, x) instead of (x, y).</p>
<p>The other oddity in this function is that
it erases the entire screen each time the user presses a key.
Doing this is unnecessary in most cases—if
the user&rsquo;s action doesn&rsquo;t modify the text being shown,
there&rsquo;s no need to redraw it—but
keeping track of which actions do and don&rsquo;t require re-draw
would require extra code (and extra debugging).
For now,
we&rsquo;ll do the simple, inefficient thing.</p>
<p>Here&rsquo;s how we run our revised <code>main</code> function:</p>
<div class="code-sample lang-py" title="show_lines.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">num_lines</span><span class="p">,</span> <span class="n">logfile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">make_lines</span><span class="p">(</span><span class="n">num_lines</span><span class="p">)</span>
    <span class="n">open_log</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stdscr</span><span class="p">:</span> <span class="n">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
</code></pre></div>
</div>
<p>From top to bottom,
we make a list of strings to display,
open the log file,
and then use <code>lambda</code> to make
an <span class="ix-entry" ix-key="anonymous function" markdown="1">anonymous function</span>
that takes a single screen object as input (which <code>curses.wrapper</code> requires)
and immediately calls <code>main</code> with the two arguments that <em>it</em> requires.</p>
<p>A real text viewer would display the contents of a file,
but for development we will just make up a regular pattern of text:</p>
<div class="code-sample lang-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">ascii_lowercase</span>

<span class="k">def</span> <span class="nf">make_lines</span><span class="p">(</span><span class="n">num_lines</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">ascii_lowercase</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ascii_lowercase</span><span class="p">)]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p class="continue">If we ask for five lines,
the pattern is:</p>
<div class="code-sample lang-out" title="make_lines.out">
<div class="highlight"><pre><span></span><code>a
b0
c01
d012
e0123
</code></pre></div>
</div>
<p class="continue">These lines are a very (very) simple example of <a class="gl-ref" href="../glossary/#gl:synthetic_data" title="Made-up data that has the same significant characteristics as real data, typically created for testing." markdown="1">synthetic data</a>,
i.e.,
data that is made up for testing purposes.
If the viewer doesn&rsquo;t work for this text it probably won&rsquo;t work on actual files,
and the patterns in the synthetic data will help us spot mistakes in the display.</p>
<h2 id="viewer-window">Section 23.2: Windowing</h2>
<p>Our file viewer works,
but only for small examples.
If we ask it to display 100 lines,
or anything else that is larger than our screen,
it falls over with the message
<code>_curses.error: addwstr() returned ERR</code>
because it is trying to draw outside screen.
The solution is to create a <code>Window</code> class
that knows how big the screen is
and only displays lines (or parts of lines) that fit inside it:</p>
<div class="code-sample lang-py" title="use_window.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Window</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">curses</span><span class="o">.</span><span class="n">LINES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="n">curses</span><span class="o">.</span><span class="n">COLS</span><span class="p">])</span>
</code></pre></div>
</div>
<p>Our <code>main</code> function is then:</p>
<div class="code-sample lang-py" title="use_window.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">stdscr</span><span class="p">)</span>
    <span class="n">window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
</code></pre></div>
</div>
<p>Notice that <code>main</code> creates the window object.
We can&rsquo;t create it earlier and pass it into <code>main</code> as we do with <code>lines</code>
because the <span class="ix-entry" ix-key="constructor" markdown="1">constructor</span> for <code>Window</code> needs the screen object,
which doesn&rsquo;t exist until <code>curses.wrapper</code> calls <code>main</code>.
This is an example of <a class="gl-ref" href="../glossary/#gl:delayed_construction" title="The practice of constructing an object after something that needs it has been constructed rather than before." markdown="1">delayed construction</a>,
and is going to constrain the rest of our design
(<a class="fig-ref" href="../viewer/#viewer-delayed">Figure 23.1</a>).</p>
<figure id="viewer-delayed" class="here">
<img src="./delayed.svg" alt="Delayed construction"/>
<figcaption markdown="1">Figure 23.1: Order of operations in delayed construction.</figcaption>
</figure>

<p>Nothing says we have to make our window exactly the same size as
the terminal that is displaying it.
In fact,
testing will be a lot simpler
if we can create windows of arbitrary size
(so long as they aren&rsquo;t <em>larger</em> than the terminal).
This version of <code>Window</code> takes an extra parameter <code>size</code>
which is either <code>None</code> (meaning &ldquo;use the full terminal&rdquo;)
or a (rows, columns) pair specifying the size we want:</p>
<div class="code-sample lang-py" title="size_window.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Window</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nrow</span> <span class="o">=</span> <span class="n">curses</span><span class="o">.</span><span class="n">LINES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span> <span class="o">=</span> <span class="n">curses</span><span class="o">.</span><span class="n">COLS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span> <span class="o">=</span> <span class="n">size</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nrow</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_ncol</span><span class="p">])</span>
</code></pre></div>
</div>
<p>We&rsquo;re going to have a lot of two-dimensional (row, column) coordinates
in this program,
so let&rsquo;s define a pair constants <code>ROW</code> and <code>COL</code>
to be more readable than 0 and 1 or <code>R</code> and <code>C</code>.
(We should really create an <a class="gl-ref" href="../glossary/#gl:enumeration" title="A set of distinct named values defined in a program." markdown="1">enumeration</a>,
but a pair of constants is good enough for now.)</p>
<div class="code-sample lang-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="n">ROW</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">COL</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<div class="code-sample lang-py" title="cursor_const.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Window</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">[</span><span class="n">ROW</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">[</span><span class="n">COL</span><span class="p">]])</span>
</code></pre></div>
</div>
<h2 id="viewer-move">Section 23.3: Moving</h2>
<p>Our program no longer crashes when given large input to display,
but we can&rsquo;t see any of the text outside the window.
To fix that,
we need to teach the application to scroll.
let&rsquo;s create another class to keep track of
the position of a cursor:</p>
<div class="code-sample lang-py" title="move_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Cursor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">The cursor keeps track of its current (row, column) position in a list,
but <code>Cursor.pos</code> returns the location as a separate tuple
so that other code can&rsquo;t modify it.
In general,
nothing outside an object should be able to change
the data structures that object uses to keep track of its state;
otherwise,
it&rsquo;s very easy for the internal state to become inconsistent
in difficult-to-debug ways.</p>
<p>Now that we have a way to keep track of where the cursor is,
we can tell <code>curses</code> to draw the cursor in the right location
each time it renders the screen:</p>
<div class="code-sample lang-py" title="move_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">stdscr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">stdscr</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">stdscr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_UP&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_DOWN&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_LEFT&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">left</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_RIGHT&quot;</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
</code></pre></div>
</div>
<p>As this code shows,
the screen&rsquo;s <code>getkey</code> method returns the names of the arrow keys.
And since <code>stdscr.move</code> takes two arguments
but <code>cursor.pos</code> returns a two-element tuple,
we <span class="ix-entry" ix-key="spread" markdown="1">spread</span> the latter with <code>*</code> to satisfy the former.</p>
<p>When we run this program and start pressing the arrow keys,
the cursor does indeed move.
In fact,
we can move it to the right of the text,
or below the bottom line of the text
if there are fewer lines of text than rows in our window.
What&rsquo;s worse,
if we move the cursor off the left or top edges of the screen
our program crashes with the message
<code>_curses.error: wmove() returned ERR</code>.
And we still can&rsquo;t see all the lines in a long &ldquo;file&rdquo;:
the text doesn&rsquo;t scroll down when we go to the bottom.</p>
<p>We need to constrain the cursor&rsquo;s movement
so that it stays inside the text (not just the window),
while simultaneously moving the text up or down when appropriate.
Before tackling those problems,
we will reorganize the code
to give ourselves a better starting point.</p>
<h2 id="viewer-refactor">Section 23.4: Refactoring</h2>
<p>Our first change is to write a class to represent
the application as a whole;
our program will then create one instance of this class,
which will own the window and cursor.
The trick to making this work is to take advantage of
one of the <span class="ix-entry" ix-key="protocol" markdown="1">protocols</span> introduced in <a class="x-ref" href="../protocols/">Chapter 9</a>:
if an object has a method named <code>__call__</code>,
that method will be invoked when the object is &ldquo;called&rdquo; as if it were a function:</p>
<div class="code-sample lang-py" title="call_example.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Pretend</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">increment</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_increment</span> <span class="o">=</span> <span class="n">increment</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Pretend</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="call_example.out">
<div class="highlight"><pre><span></span><code>13
</code></pre></div>
</div>
<p>Since the <code>MainApp</code> class below defines <code>__call__</code>,
<code>curses.wrapper</code> believes we have given it the single-parameter function it needs:</p>
<div class="code-sample lang-py" title="main_app.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MainApp</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">=</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">screen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">()</span>
</code></pre></div>
</div>
<p>The <code>__call__</code> method calls <code>_setup</code>
to create and store the objects the application needs,
then <code>_run</code> to handle interaction.
The latter is:</p>
<div class="code-sample lang-py" title="main_app.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_UP&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_DOWN&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_LEFT&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">left</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;KEY_RIGHT&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
</code></pre></div>
</div>
<p>Finally,
we pull the startup code into a function <code>start</code>
so that we can use it in future versions of this code:</p>
<div class="code-sample lang-py" title="util.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="n">num_lines</span><span class="p">,</span> <span class="n">logfile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">make_lines</span><span class="p">(</span><span class="n">num_lines</span><span class="p">)</span>
    <span class="n">open_log</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span>
</code></pre></div>
</div>
<p class="continue">and then launch our application like this:</p>
<div class="code-sample lang-py" title="main_app.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">MainApp</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Next,
we refactor <code>_run</code> to handle keystrokes using <span class="ix-entry" ix-key="dynamic dispatch" markdown="1">dynamic dispatch</span>
instead of a long chain of <code>if</code>/<code>elif</code> statement:</p>
<div class="code-sample lang-py" title="dispatch_keys.py">
<div class="highlight"><pre><span></span><code><span class="n">TRANSLATE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;</span><span class="se">\x18</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;CONTROL_X&quot;</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRANSLATE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_do_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)()</span>

<span class="k">def</span> <span class="nf">_do_CONTROL_X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">_do_KEY_UP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="pagebreak"></div>

<p>A little experimentation showed that
while the <code>curses</code> module uses names like <code>"KEY_DOWN"</code> for arrow keys,
it returns actual <span class="ix-entry" ix-key="control code" markdown="1">control codes</span>
for key combinations like Ctrl-X.
The <code>TRANSLATE</code> dictionary turns these into human-readable names
that we can glue together with <code>_do_</code> to make a method name;
we got the hexadecimal value <code>"\x18"</code> by logging keystrokes to a file
and the looking at its contents.
We could probably have found this value in some documentation somewhere
if we had looked hard enough,
but a ten-second experiment seemed simpler.</p>
<p>With <code>_interact</code> in place,
we can re-write <code>_run</code> to be just five lines long:</p>
<div class="code-sample lang-py" title="dispatch_keys.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DispatchApp</span><span class="p">(</span><span class="n">MainApp</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interact</span><span class="p">()</span>
</code></pre></div>
</div>
<p>It now relies on a member variable called <code>_running</code>
to keep the loop going.
We could have had each key handler method return <code>True</code> or <code>False</code>
to signal whether to keep going or not,
but we found out that the hard way that
it&rsquo;s very easy to forget to do this,
since almost every handler method&rsquo;s result is going to be the same.</p>
<div class="callout">
<h3>Inheritance</h3>
<p><code>DispatchApp</code> <span class="ix-entry" ix-key="inheritance" markdown="1">inherits</span> from our first <code>MainApp</code>
so that we can recycle the initialization code we wrote for the latter.
To make this happen,
<code>DispatchApp.__init__</code> <span class="ix-entry" ix-key="upcall" markdown="1">upcalls</span> to <code>MainApp.__init__</code>
using <code>super().__init__</code>.
We probably wouldn&rsquo;t create multiple classes in a real program,
but doing this simplifies exposition when teaching.
In order to make this work cleanly,
we did have to move some code around
as later examples showed us that
we should have divided things up differently in earlier examples.</p>
<p><em>This is normal.</em>
Nobody has perfect foresight;
if we haven&rsquo;t built a particular kind of application several times,
we can&rsquo;t anticipate all of the <span class="ix-entry" ix-key="affordance" markdown="1">affordances</span> we might need,
so going back and refactoring old code to make new code easier to write
is perfectly natural.
If we need to refactor every time we want to add something new,
though,
we should probably rethink our design entirely.</p>
</div>
<p>We now have classes to represent the application, the window, and the cursor,
but we are still storing the text to display as a naked list of lines.
Let&rsquo;s wrap it up in a class:</p>
<div class="code-sample lang-py" title="buffer_class.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Buffer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span>
</code></pre></div>
</div>
<p>This <a class="gl-ref" href="../glossary/#gl:buffer_text" title="A data structure that stores text while it is being viewed or edited." markdown="1">text buffer</a> class doesn&rsquo;t do much yet,
but will later keep track of the viewable region.
Again,
we make a copy of <code>lines</code> rather than using the list the caller gives us
so that other code can&rsquo;t change the buffer&rsquo;s internals.
The corresponding change to the application class is:</p>
<div class="pagebreak"></div>

<div class="code-sample lang-py" title="buffer_class.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BufferApp</span><span class="p">(</span><span class="n">DispatchApp</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span> <span class="o">=</span> <span class="n">screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_window</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_cursor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Factory Methods</h3>
<p>We want to re-use as much of <code>BufferApp</code> as possible
in upcoming versions of our file viewer.
If <code>setup</code> calls the constructors of specific classes
to create the window, buffer, and cursor objects,
we will have to rewrite the entire method
each time we change which classes we want to use
for any of those three things.
Putting constructor calls in <a class="gl-ref" href="../glossary/#gl:factory_method" title="A method whose only job is to construct an object of some type. Factory methods are typically created to make it easier for child classes to construct objects of other types." markdown="1">factory methods</a>
makes the code longer,
but allows us to override them one by one.
We didn&rsquo;t do this when we were first writing these examples;
instead,
as described in the previous callout,
we went back and refactored earlier classes
to make later ones easier.</p>
</div>
<h2 id="viewer-clip">Section 23.5: Clipping</h2>
<p>We are now ready to keep the cursor inside
both the text and the screen.
The <code>ClipCursor</code> class below takes the buffer as a constructor argument
so that it can ask how many rows there are
and how big each one is,
but its <code>up</code>, <code>down</code>, <code>left</code>, and <code>right</code> methods
have exactly the same <span class="ix-entry" ix-key="signature" markdown="1">signatures</span> as
the corresponding methods in the original <code>Cursor</code> class.
As a result,
while we have to change the code that <em>creates</em> a cursor,
we won&rsquo;t have to make any changes to the code that <em>uses</em> the cursor:</p>
<div class="code-sample lang-py" title="clip_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ClipCursor</span><span class="p">(</span><span class="n">Cursor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">buffer</span>

    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">nrow</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<p>The logic in the movement methods in <code>ClipCursor</code> is relatively straightforward.
If the user wants to go up,
don&rsquo;t let the cursor go above line 0.
If the user wants to go down,
on the other hand,
don&rsquo;t let the cursor go below the last line,
and so on.
These methods rely on the buffer being able to report
the number of rows it has
and the number of columns in a particular row,
so we define a new <code>ClipBuffer</code> class that provides those,
and then override the <code>_make_buffer</code> and <code>_make_cursor</code> methods
in the application class
to construct the appropriate objects
<em>without</em> changing the kind of window we are creating:</p>
<div class="code-sample lang-py" title="clip_cursor.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ClipBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">nrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ncol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ClipApp</span><span class="p">(</span><span class="n">BufferApp</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_make_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">ClipBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">ClipCursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
</code></pre></div>
</div>
<p>When we run this program,
we are no longer able to move the cursor outside the window
or outside the displayed text—unless,
that is,
we go to the end of a long line and then move up to a shorter one.
The problem is that <code>up</code> and <code>down</code> only change
the cursor&rsquo;s idea of the row it is on,
and don&rsquo;t check that the column position is still inside the text.
The fix is simple:</p>
<div class="code-sample lang-py" title="clip_fixed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ClipCursorFixed</span><span class="p">(</span><span class="n">ClipCursor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">],</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
</div>
<p class="continue">One sign of a good design is that
there is one (hopefully obvious) place to make a change
in order to fix a bug or add a feature.
By that measure,
we seem to be on the right track.</p>
<h2 id="viewer-continue">Section 23.6: Viewport</h2>
<p>We are finally ready to scroll the text vertically
so that all of the lines can be seen
no matter how small the window is.
(We will leave horizontal scrolling as an exercise.)
A full-featured editor would introduce another class,
often called a <a class="gl-ref" href="../glossary/#gl:viewport" title="A class or other data structure whose purpose is to keep track of what can currently be seen by the user." markdown="1">viewport</a>,
to track the currently-visible portion of the buffer.
To keep things simple,
we will add two member variables to the buffer instead
to keep track of the top-most visible line
and the height of the window:</p>
<div class="code-sample lang-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ViewportBuffer</span><span class="p">(</span><span class="n">ClipBuffer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_height</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_height</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_height</span> <span class="o">=</span> <span class="n">height</span>

    <span class="k">def</span> <span class="nf">_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_height</span>
</code></pre></div>
</div>
<p class="continue">The most important change in the buffer is that
<code>lines</code> returns the visible portion of the text
rather than all of it.
Another change is that the buffer initializes <code>_height</code> to <code>None</code>
and requires someone to set it to a real value later
because the application&rsquo;s <code>_setup</code> method
creates the cursor, buffer, and window independently.
If we were building a single class
rather than layering tutorial classes on top of each other,
we would probably go back and change <code>_setup</code>
to remove the need for this.</p>
<p>Our buffer also gains two more methods.
The first transforms the cursor&rsquo;s position from buffer coordinates
to screen coordinates:</p>
<div class="code-sample lang-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="n">COL</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>The second moves <code>_top</code> up or down when we reach the edge of the display:</p>
<div class="code-sample lang-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
    <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bottom</span><span class="p">())</span> <span class="ow">and</span> \
         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bottom</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>As before,
we derive a new application class to create the right kind of buffer object.
We also override <code>_run</code> to scroll the buffer
after each interaction with the user:</p>
<div class="code-sample lang-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ViewportApp</span><span class="p">(</span><span class="n">ClipAppFixed</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_make_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">ViewportBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">ViewportCursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="n">ROW</span><span class="p">])</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">lines</span><span class="p">())</span>
            <span class="n">screen_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_screen</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">screen_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interact</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">scroll</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
</code></pre></div>
</div>
<p>Notice that the <code>ViewportApp</code> class creates a <code>ViewportCursor</code>.
When we were testing the program,
we discovered that we had introduced a bug:
the cursor could go outside the window again
if the line it was currently on
was wider than the window.
The solution is to add another check to <code>_fix</code>
and to ensure that left and right movement constrain the cursor&rsquo;s position
in the same way as vertical movement:</p>
<div class="code-sample lang-py" title="viewport.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ViewportCursor</span><span class="p">(</span><span class="n">ClipCursorFixed</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">window</span>

    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">left</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">COL</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">ncol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[</span><span class="n">ROW</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="n">COL</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<h2 id="viewer-summary">Section 23.7: Summary</h2>
<figure id="viewer-concept-map" class="here">
<img src="./concept_map.svg" alt="Concept map of file viewer"/>
<figcaption markdown="1">Figure 23.2: Concept map.</figcaption>
</figure>

<h2 id="viewer-exercises">Section 23.8: Exercises</h2>
<h3 class="exercise">Using <code>global</code></h3>
<ol>
<li>
<p>Why does <code>open_log</code> need the line <code>global LOG</code>?
    What happens if it is removed?</p>
</li>
<li>
<p>Why doesn&rsquo;t the <code>log</code> function need this statement?</p>
</li>
</ol>
<h3 class="exercise">Horizontal Scrolling</h3>
<p>Modify the application to scroll horizontally as well as vertically.</p>
<h3 class="exercise">Explain the Bug</h3>
<p>Replace the <code>ViewportCursor</code> class in the final version of the code
with the earlier <code>ClipCursorFixed</code> class,
then explain the bug <code>ViewportCursor</code> was created to fix.</p>
<h3 class="exercise">Line Numbers</h3>
<p>Modify the file viewer to show line numbers on the left side of the text.</p>
<h3 class="exercise">Inheritance</h3>
<p><a class="fig-ref" href="../viewer/#viewer-inheritance">Figure 23.3</a> shows the classes we created in this tutorial.
Summarize the changes in each.</p>
<figure id="viewer-inheritance" class="here">
<img src="./inheritance.svg" alt="Inheritance in lesson"/>
<figcaption markdown="1">Figure 23.3: Class definitions and inheritance in lesson.</figcaption>
</figure>
        </main>
      </div>
    </div>
  </body>
</html>
