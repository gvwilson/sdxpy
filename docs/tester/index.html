<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="slides" content="true">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design in Python: A Testing Framework</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design in Python</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Classes and Objects
    </a>
  </li>
  
  <li>
    <a href="../tester/">
      <strong>A Testing Framework</strong>
    </a>
  </li>
  
  <li>
    <a href="../interpreter/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../backup/">
      Versioned File Backups
    </a>
  </li>
  
  <li>
    <a href="../mock/">
      Mock Objects
    </a>
  </li>
  
  <li>
    <a href="../cache/">
      A File Cache
    </a>
  </li>
  
  <li>
    <a href="../dataframe/">
      A Dataframe
    </a>
  </li>
  
  <li>
    <a href="../persistence/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../builder/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../templating/">
      A Static Site Generator
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../editor/">
      An Editor
    </a>
  </li>
  
  <li>
    <a href="../server/">
      A Web Server
    </a>
  </li>
  
  <li>
    <a href="../packman/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../matching/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parser/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../linter/">
      A Style Checker
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../slides/">
      Slides
    </a>
  </li>
  
  <li>
    <a href="../teaching/">
      Teaching Notes
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 3: A Testing Framework</h1>


          
            
<div class="draft">
  <p>DRAFT</p>
</div>


            
  
  <ul class="syllabus">
  
  <li markdown="1">Functions are objects you can save in data structures or pass to other functions.</li>
  
  <li markdown="1">Python stores local and global variables in dictionary-like structures.</li>
  
  <li markdown="1">A unit test function performs an operation on a fixture and passes, fails, or produces an error.</li>
  
  <li markdown="1">A program can introspect to find functions and other objects at runtime.</li>
  
  </ul>
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


            
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>, <a class="gl-ref" href="../glossary/#actual_result" markdown="1">actual result (of test)</a>, <a class="gl-ref" href="../glossary/#assertion" markdown="1">assertion</a>, <a class="gl-ref" href="../glossary/#defensive_programming" markdown="1">defensive programming</a>, <a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a>, <a class="gl-ref" href="../glossary/#error_test" markdown="1">error (result of test)</a>, <a class="gl-ref" href="../glossary/#expected_result" markdown="1">expected result (of test)</a>, <a class="gl-ref" href="../glossary/#fail_test" markdown="1">failure (result of test)</a>, <a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a>, <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>, <a class="gl-ref" href="../glossary/#pass_test" markdown="1">pass (result of test)</a>, <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>, <a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a>, <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>, <a class="gl-ref" href="../glossary/#stdout" markdown="1">standard output</a>, <a class="gl-ref" href="../glossary/#throw_exception" markdown="1">throw exception</a>, <a class="gl-ref" href="../glossary/#unit_test" markdown="1">unit test</a>
</p>


            <div class="page-toc"></div>
            <p>We&rsquo;re going to write a lot of programs in this book.
To make sure they work correctly,
we&rsquo;re also going to write a lot of <a class="gl-ref" href="../glossary/#unit_test" markdown="1">unit tests</a> <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Aniche2022">Aniche2022</a>]</span>.
Most developers don&rsquo;t enjoy doing this,
so good unit testing tools minimize the effort required.
One way they do this is to find and run tests automatically <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Meszaros2007">Meszaros2007</a>]</span>.
To show how,
this chapter builds a simple unit testing framework.
It also introduces the single most important idea in this book:</p>
<div class="center">
<p><em>Programs are just another kind of data.</em></p>
</div>
<h2 id="tester-funcobj">Section 3.1: Storing and Running Tests</h2>
<p>The first thing we need to understand is that a function is an object.
While the bytes in a string represent characters
and the bytes in an image represent pixels,
the bytes in a function are instructions
(<a class="fig-ref" href="../tester/#tester-func-obj">Figure 3.1</a>).
When Python executes the code below,
it creates an object in memory
that contains the instructions to print a string
and assigns that object to the variable <code>example</code>:</p>
<div class="code-sample lang-py" title="func_obj.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in example&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<figure id="tester-func-obj">
  <img src="./tester_func_obj.svg" alt="Bytes as characters, pixels, or instructions"/>
  <figcaption markdown="1">Figure 3.1: Bytes can be interpreted as text, images, instructions, and more.</figcaption>
</figure>

<p>We can assign the function to another variable:</p>
<div class="code-sample lang-py" title="func_obj.py">
<div class="highlight"><pre><span></span><code><span class="n">alias</span> <span class="o">=</span> <span class="n">example</span>
<span class="n">alias</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_obj.out">
<div class="highlight"><pre><span></span><code>in example
</code></pre></div>
</div>
<p class="continue">or replace the function by assigning a new value
to the original variable:</p>
<div class="code-sample lang-py" title="replacement.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">replacement</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in replacement&quot;</span><span class="p">)</span>

<span class="n">example</span> <span class="o">=</span> <span class="n">replacement</span>
<span class="n">example</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="replacement.out">
<div class="highlight"><pre><span></span><code>in replacement
</code></pre></div>
</div>
<p>We can also store functions in a list just like numbers or strings
(<a class="fig-ref" href="../tester/#tester-func-list">Figure 3.2</a>):</p>
<div class="code-sample lang-py" title="func_list.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">first</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">second</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Second&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">third</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Third&quot;</span><span class="p">)</span>

<span class="n">everything</span> <span class="o">=</span> <span class="p">[</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="p">]</span>
<span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">everything</span><span class="p">:</span>
    <span class="n">func</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_list.out">
<div class="highlight"><pre><span></span><code>First
Second
Third
</code></pre></div>
</div>
<figure id="tester-func-list">
  <img src="./tester_func_list.svg" alt="A list of functions"/>
  <figcaption markdown="1">Figure 3.2: A list of functions.</figcaption>
</figure>

<p class="continue">When we loop over the list <code>everything</code>,
Python assigns each function to the variable <code>func</code> in turn.
We can then call the function as <code>func()</code>
just as we called <code>example</code> using <code>alias()</code>.</p>
<p>Now suppose we have a function we want to test:</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">and some functions that test it
(two of which contain deliberate errors):</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>We can put all the test functions in a list:</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="n">TESTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">test_sign_negative</span><span class="p">,</span>
    <span class="n">test_sign_positive</span><span class="p">,</span>
    <span class="n">test_sign_zero</span><span class="p">,</span>
    <span class="n">test_sign_error</span>
<span class="p">]</span>
</code></pre></div>
</div>
<p>Each test does something to a <a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a>
(such as the number -3)
and uses <a class="gl-ref" href="../glossary/#assertion" markdown="1">assertions</a>
to compare the <a class="gl-ref" href="../glossary/#actual_result" markdown="1">actual result</a>
against the <a class="gl-ref" href="../glossary/#expected_result" markdown="1">expected result</a>.
The outcome of each test is exactly one of:</p>
<ul>
<li>
<p><a class="gl-ref" href="../glossary/#pass_test" markdown="1">Pass</a>:
    the test subject works as expected.</p>
</li>
<li>
<p><a class="gl-ref" href="../glossary/#fail_test" markdown="1">Fail</a>:
    something is wrong with the test subject.</p>
</li>
<li>
<p><a class="gl-ref" href="../glossary/#error_test" markdown="1">Error</a>:
    something is wrong in the test itself,
    which means we don&rsquo;t know if
    the thing we&rsquo;re testing is working properly or not.</p>
</li>
</ul>
<p>To implement this classification scheme
we need to distinguish failing tests from broken ones.
Our rule is that
if a test <a class="gl-ref" href="../glossary/#throw_exception" markdown="1">throws</a> an <code>AssertionError</code>
then one of our checks is reporting a failure,
while any other kind of exception indicates that the test contains an error.</p>
<p>Translating that rules into code gives us the function <code>run_tests</code>
that runs every test in a list
and counts how many outcomes of each kind it sees:</p>
<div class="code-sample lang-py" title="dry_run.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">all_tests</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pass&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">all_tests</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test</span><span class="p">()</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;pass&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;fail&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fail </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="n">TESTS</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">If a test completes without an exception, it passes.
If any of the assertions inside it raises an <code>AssertionError</code> the test fails,
and if it raises any other exception it&rsquo;s an error.</p>
<div class="code-sample lang-out" title="dry_run.out">
<div class="highlight"><pre><span></span><code>pass 2
fail 1
error 1
</code></pre></div>
</div>
<div class="callout">
<h3>Independence</h3>
<p>Our function runs tests in the order they appear in the list.
The tests should not rely on that:
every unit test should work independently
so that an error or failure in an early test
doesn&rsquo;t affect other tests&rsquo; behavior.</p>
</div>
<h2 id="tester-reflection">Section 3.2: Finding Functions</h2>
<p>Making lists of functions is clumsy and error-prone:
sooner or later we&rsquo;ll add a test twice or forget to add it at all.
We&rsquo;d therefore like our test runner to find tests for itself,
which it can do by exploiting the fact that
Python stores variables in a structure similar to a dictionary.</p>
<p>Run the Python interpreter and call the <code>globals</code> function:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; globals()
{
    &#39;__name__&#39;: &#39;__main__&#39;,
    &#39;__doc__&#39;: None,
    &#39;__package__&#39;: None,
    &#39;__loader__&#39;: &lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;,
    &#39;__spec__&#39;: None,
    &#39;__annotations__&#39;: {},
    &#39;__builtins__&#39;: &lt;module &#39;builtins&#39; (built-in)&gt;
}
</code></pre></div>
<p class="continue">As the output shows,
<code>globals</code> is a dictionary containing
all the variables at the top (global) level of the program.
Since we just started the interpreter,
we see the variables that Python defines automatically.
(By convention,
Python uses double underscores for names that mean something special to it.)</p>
<p>What happens when we define a variable of our own?</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; my_variable = 123
&gt;&gt;&gt; globals()
{
    &#39;__name__&#39;: &#39;__main__&#39;,
    &#39;__doc__&#39;: None,
    &#39;__package__&#39;: None,
    &#39;__loader__&#39;: &lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;,
    &#39;__spec__&#39;: None,
    &#39;__annotations__&#39;: {},
    &#39;__builtins__&#39;: &lt;module &#39;builtins&#39; (built-in)&gt;,
    &#39;my_variable&#39;: 123
}
</code></pre></div>
<p class="continue">Sure enough,
<code>my_variable</code> is now in the dictionary.</p>
<div class="callout">
<h3>Local Variables</h3>
<p>Another function called <code>locals</code> returns
all the variables defined in the current (local) <a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a>:</p>
<div class="code-sample lang-py" title="show_locals.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">show_off</span><span class="p">(</span><span class="n">some_parameter</span><span class="p">):</span>
    <span class="n">some_variable</span> <span class="o">=</span> <span class="n">some_parameter</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;local values&quot;</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>

<span class="n">show_off</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="show_locals.out">
<div class="highlight"><pre><span></span><code>local values {&#39;some_parameter&#39;: &#39;hello&#39;, &#39;some_variable&#39;: &#39;hellohello&#39;}
</code></pre></div>
</div>
</div>
<p>If function names are just variables
and a program&rsquo;s variables are stored in a dictionary,
we can loop over that dictionary
to find all the functions whose names start with <code>test_</code>:</p>
<div class="code-sample lang-py" title="find_list_test_funcs.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

<span class="n">find_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="find_list_test_funcs.out">
<div class="highlight"><pre><span></span><code>test_sign_negative &lt;function test_sign_negative at 0x7f77c01f6e60&gt;
test_sign_positive &lt;function test_sign_positive at 0x7f77c01f6ef0&gt;
test_sign_zero &lt;function test_sign_zero at 0x7f77c01f6f80&gt;
test_sign_error &lt;function test_sign_error at 0x7f77c01f7010&gt;
</code></pre></div>
</div>
<p class="continue">Notice that when we print a function,
Python shows us its name and its address in memory.</p>
<p>Having a program find things in itself like this at runtime
is called <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>.
Combining introspection with the pass-fail-error pattern of the previous section
gives us something that finds test functions,
runs them,
and summarizes their results:</p>
<div class="code-sample lang-py" title="find_report_tests.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;passed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;had error&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="find_report_tests.out">
<div class="highlight"><pre><span></span><code>test_sign_negative passed
test_sign_positive passed
test_sign_zero failed
test_sign_error had error
</code></pre></div>
</div>
<div class="callout">
<h3>Calling Conventions</h3>
<p>We actually can&rsquo;t call a function we&rsquo;ve found by introspection unless:</p>
<ol>
<li>
<p>we know its <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>
    (i.e, how many parameters of what type it needs in what order)
    or</p>
</li>
<li>
<p>the function uses <code>*args*</code> or <code>**kwargs</code> to capture &ldquo;extra&rdquo; arguments.</p>
</li>
</ol>
<p>To keep things simple,
most unit testing frameworks require test functions to take no parameters
so that they can be called as <code>test()</code>.</p>
</div>
<h2 id="tester-further">Section 3.3: Going Further</h2>
<p>Since functions are objects,
they can have attributes.
The function <code>dir</code> (short for &ldquo;directory&rdquo;) returns a list of those attributes&rsquo; names:</p>
<div class="code-sample lang-py" title="func_dir.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="s2">&quot;Docstring for example.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in example&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">example</span><span class="p">))</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_dir.out">
<div class="highlight"><pre><span></span><code>[&#39;__annotations__&#39;, &#39;__builtins__&#39;, &#39;__call__&#39;, &#39;__class__&#39;, \
&#39;__closure__&#39;, &#39;__code__&#39;, &#39;__defaults__&#39;, &#39;__delattr__&#39;, &#39;__dict__&#39;, \
&#39;__dir__&#39;, &#39;__doc__&#39;, &#39;__eq__&#39;, &#39;__format__&#39;, &#39;__ge__&#39;, &#39;__get__&#39;, \
&#39;__getattribute__&#39;, &#39;__globals__&#39;, &#39;__gt__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, \
&#39;__init_subclass__&#39;, &#39;__kwdefaults__&#39;, &#39;__le__&#39;, &#39;__lt__&#39;, &#39;__module__&#39;, \
&#39;__name__&#39;, &#39;__ne__&#39;, &#39;__new__&#39;, &#39;__qualname__&#39;, &#39;__reduce__&#39;, \
&#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, \
&#39;__subclasshook__&#39;]
</code></pre></div>
</div>
<p>Most programmers never need to use most of these,
but <code>__name__</code> holds the function&rsquo;s original name
and <code>__doc__</code> holds its <span class="ix-entry" ix-key="docstring" markdown="1"><a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a></span>:</p>
<div class="code-sample lang-py" title="func_attr.py">
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;docstring:&quot;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;name:&quot;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func_attr.out">
<div class="highlight"><pre><span></span><code>docstring: Docstring for example.
name: example
</code></pre></div>
</div>
<p>We can modify our test runner to use this for reporting tests&rsquo; results
using the function&rsquo;s <code>__name__</code> attribute
instead of the key in the <code>globals</code> dictionary:</p>
<div class="code-sample lang-py" title="with_name.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;passed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;had error&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="with_name.out">
<div class="highlight"><pre><span></span><code>test_sign_negative passed
test_sign_positive passed
test_sign_zero failed
test_sign_error had error
</code></pre></div>
</div>
<p>More usefully,
we can say that if a test function&rsquo;s docstring contains the string <code>"test:skip"</code>
then we should skip the test,
while <code>"test:fail"</code> means we expect this test to fail.
Let&rsquo;s rewrite our tests to show this off:</p>
<div class="code-sample lang-py" title="docstring.py">
<div class="highlight"><pre><span></span><code><span class="n">TEST_FAIL</span> <span class="o">=</span> <span class="s2">&quot;test:fail&quot;</span>
<span class="n">TEST_SKIP</span> <span class="o">=</span> <span class="s2">&quot;test:skip&quot;</span>

<span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="s2">&quot;test:skip&quot;</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="s2">&quot;test:fail&quot;</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Expect an error.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">and then modify <code>run_tests</code> to look for these strings and act accordingly:</p>
<div class="code-sample lang-py" title="docstring.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">and</span> <span class="n">TEST_SKIP</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skip: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TEST_FAIL</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass (expected failure): </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fail: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">doc</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The output is now:</p>
<div class="code-sample lang-out" title="docstring.out">
<div class="highlight"><pre><span></span><code>skip: test_sign_negative
pass: test_sign_positive
pass (expected failure): test_sign_zero
error: test_sign_error/Expect an error. name &#39;sgn&#39; is not defined
</code></pre></div>
</div>
<p>Instead of (ab)using docstrings like this,
we can add attributes of our own to test functions.
Let&rsquo;s say that if a function has an attribute called <code>skip</code> with the value <code>True</code>
then the function is to be skipped,
while if it has an attribute called <code>fail</code> whose value is <code>True</code>
then the test is expected to fail.
Our tests become:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">test_sign_negative</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_zero</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">test_sign_zero</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_sign_error</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sgn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>We can write a helper function called <code>classify</code> to classify tests.
Note that it uses <code>hasattr</code> to check if an attribute is present
before trying to get its value:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;skip&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;fail&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;run&quot;</span>
</code></pre></div>
</div>
<p>Finally,
our test runner becomes:</p>
<div class="code-sample lang-py" title="attribute.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;skip&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skip: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;fail&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pass (expected failure): </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fail: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">run_tests</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="tester-files">Section 3.4: Finding Test Files</h2>
<p><a href="https://docs.pytest.org/">pytest</a> and tools like it do one more thing that our testing framework doesn&rsquo;t:
find files that contain tests.
For example,
if we run <code>pytest</code> on the command line,
it finds all the Python files in or below the current directory whose names start with <code>test_</code>
and runs the tests they contain.
In order to do this ourselves,
we need to:</p>
<ol>
<li>find files whose names match a pattern,</li>
<li>load them into memory,</li>
<li>find the test functions they contain, and</li>
<li>run those tests (which we already know how to do).</li>
</ol>
<p>Python&rsquo;s <a href="https://docs.python.org/3/library/glob.html">glob</a> module can do the first step.
If we have this directory structure:</p>
<div class="code-sample lang-sh" title="show_try_glob.sh">
<div class="highlight"><pre><span></span><code>tree --charset ascii sample_dir
</code></pre></div>
</div>
<div class="code-sample lang-out" title="show_try_glob.out">
<div class="highlight"><pre><span></span><code>sample_dir
|-- a.txt
|-- b.txt
`-- subdir
    `-- c.txt

1 directory, 3 files
</code></pre></div>
</div>
<p class="continue">then a single call to <code>glob.glob</code> will find all the files whose names end with <code>.txt</code>:</p>
<div class="code-sample lang-py" title="try_glob.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">root</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.txt&quot;</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="try_glob.sh">
<div class="highlight"><pre><span></span><code>python try_glob.py sample_dir
</code></pre></div>
</div>
<div class="code-sample lang-out" title="try_glob.out">
<div class="highlight"><pre><span></span><code>b.txt
a.txt
sub_dir/c.txt
</code></pre></div>
</div>
<p class="continue">We can use a similar call with a different pattern
to find all the files whose names match a pattern like <code>test_*.py</code>.</p>
<p>Once we have them,
we can use Python&rsquo;s <code>importlib</code> module to load them
in the same way that an <code>import</code> statement would.
Importing a module can be a complex process—for example,
the source might be a zip file containing several modules—so doing an import ourselves
is a three-step process:</p>
<ol>
<li>Build a specification of what we&rsquo;re going to import.</li>
<li>Build a Python module in memory from that spec.</li>
<li>Execute the code in the module,
    which is what actually creates the module&rsquo;s variables, functions, and so on.</li>
</ol>
<p>Here&rsquo;s an example program that takes a path to a Python file
and the name of a variable at the top level of that file,
loads the file,
and displays the variable&rsquo;s value:</p>
<div class="code-sample lang-py" title="import_example.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">variable</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After all that, the value is &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">If the file we want to load is:</p>
<div class="code-sample lang-py" title="test_up.py">
<div class="highlight"><pre><span></span><code><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;testing example&quot;</span>

<span class="k">def</span> <span class="nf">test_succeeds</span><span class="p">():</span>
    <span class="k">assert</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">test_fails</span><span class="p">():</span>
    <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div>
</div>
<p class="continue">we can run our example importer like this:</p>
<div class="code-sample lang-sh" title="import_example.sh">
<div class="highlight"><pre><span></span><code>python import_example.py sample_dir/test_up.py title
</code></pre></div>
</div>
<div class="code-sample lang-out" title="import_example.out">
<div class="highlight"><pre><span></span><code>After all that, the value is &#39;testing example&#39;
</code></pre></div>
</div>
<p>Notice that we use <code>getattr</code> to look up the variable we want.
A module is just another data structure in memory,
but it&rsquo;s not a dictionary,
so we can&rsquo;t use <code>module[name]</code> to get the things it contains.
Instead,
we use <code>getattr</code> (short for &ldquo;get attribute&rdquo;)
to do the equivalent of <code>module.name</code>.</p>
<div class="callout">
<h3>Any Sufficiently Premature Technology</h3>
<p><a href="https://en.wikipedia.org/wiki/Clarke%27s_three_laws">Clarke&rsquo;s Third Law</a> is that
any sufficiently advanced technology is indistinguishable from magic.
The same is true of technologies that we encounter
before we have the background knowledge they depend on.
The three lines that import a Python file as a module
will seem reasonable (and possibly even a little dull)
once we know more about how programming languages work.
Until we do,
the sensible strategy is to copy, paste, and move on.
Even the most experienced programmers do this when working in a new domain:
it&rsquo;s easier to learn things once we have more context,
so setting a problem aside and returning to it later can save a lot of time.</p>
</div>
<h2 id="tester-summary">Section 3.5: Summary</h2>
<figure id="tester-concept-map">
  <img src="./tester_concept_map.svg" alt="Concept map of unit testing tool"/>
  <figcaption markdown="1">Figure 3.3: Unit tester concept map.</figcaption>
</figure>

<h2 id="tester-exercises">Section 3.6: Exercises</h2>
<h3 class="exercise">Why a copy?</h3>
<p>Why does the function <code>globals</code> return a copy of the dictionary
containing the program&rsquo;s global variables?
Why doesn&rsquo;t it return the dictionary itself so that programs can modify it?
Why use a function at all instead of simply using a variable called <code>__globals__</code>?</p>
<h3 class="exercise">Counting results</h3>
<ol>
<li>
<p>Modify the test framework so that it reports which tests passed, failed, or had errors
    and also reports a summary of how many tests produced each result.</p>
</li>
<li>
<p>Write unit tests to check that your answer to part 1 works correctly.</p>
</li>
<li>
<p>Think of another plausible way to interpret part 1
    that <em>wouldn&rsquo;t</em> pass the tests you wrote for part 2.</p>
</li>
</ol>
<h3 class="exercise">Literal strings</h3>
<p>If we have defined a variable with the test-skipping marker,
why can&rsquo;t we use that variable as the docstring for several functions like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">TEST_SKIP</span> <span class="o">=</span> <span class="s2">&quot;test:skip&quot;</span>

<span class="k">def</span> <span class="nf">test_sign_negative</span><span class="p">():</span>
    <span class="n">TEST_SKIP</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_sign_positive</span><span class="p">():</span>
    <span class="n">TEST_SKIP</span>
    <span class="k">assert</span> <span class="n">sign</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
<h3 class="exercise">Failing on purpose</h3>
<p>Putting assertions into code to check that it is behaving correctly
is called <a class="gl-ref" href="../glossary/#defensive_programming" markdown="1">defensive programming</a>;
it&rsquo;s a good practice,
but we should make sure those assertions are failing when they&rsquo;re supposed to,
just as we should test our smoke detectors every once in a while.</p>
<p>Modify the tester so that
if a test function&rsquo;s docstring is <code>"test:assert"</code>,
the test passes if it raises an <code>AssertionError</code>
and fails if it does not.
Tests whose docstring don&rsquo;t contain <code>"test:assert"</code>
should behave as before.</p>
<h3 class="exercise">Timing tests</h3>
<p>Modify the testing tool so that it records how long it takes to run each test.
(The function <code>time.time</code> may be useful.)
Use Python&rsquo;s own <a href="https://docs.pytest.org/">pytest</a> library to test your implementation.</p>
<h3 class="exercise">Approximately equal</h3>
<ol>
<li>
<p>Write a function <code>assert_approx_equal</code>
    that does nothing if two values are within a certain tolerance of each other
    but throws an exception if they are not:</p>
<pre><code>// throws exception
assert_approx_equal(1.0, 2.0, 0.01, "Values are too far apart")

// does not throw
assert_approx_equal(1.0, 2.0, 10.0, "Large margin of error")
</code></pre>
</li>
<li>
<p>Modify the function so that a default tolerance is used if none is specified:</p>
<pre><code>// throws exception
assert_approx_equal(1.0, 2.0, "Values are too far apart")

// does not throw
assert_approx_equal(1.0, 2.0, "Large margin of error", 10.0)
</code></pre>
</li>
<li>
<p>Modify the function again so that it checks the <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>
    instead of the <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>.
    (The relative error is the absolute value of the difference between the actual and expected value,
    divided by the absolute value.)</p>
</li>
</ol>
<h3 class="exercise">Selecting tests</h3>
<p>Modify the testing tool so that if a user provides <code>-s pattern</code> or <code>--select pattern</code>
then it only runs tests that contain the string <code>pattern</code> in their name.</p>
<h3 class="exercise">Setup and teardown</h3>
<p>Testing frameworks often allow programmers to specify a <code>setup</code> function
that is to be run before each test
and a corresponding <code>teardown</code> function
that is to be run after each test.
(<code>setup</code> usually re-creates complicated test fixtures,
while <code>teardown</code> functions are sometimes needed to clean up after tests,
e.g., to close database connections or delete temporary files.)</p>
<p>Modify the testing tool in this chapter so that
if a file of tests contains a function called <code>setup</code>
then the tool calls it exactly once before running each test in the file.
Add a similar way to register a <code>teardown</code> function.</p>
<h3 class="exercise">Parameterized tests</h3>
<p>Modify the testing framework so that
if a test function has an attribute called <code>cases</code>,
the test function is run once for each case.
For example,
if the user writes:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_subtract</span><span class="p">(</span><span class="n">fixture</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">fixture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fixture</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected</span>
<span class="n">test_subtract</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># fixture  expected</span>
    <span class="p">[[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>   <span class="mi">3</span><span class="p">],</span>
    <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>   <span class="o">-</span><span class="mi">3</span><span class="p">],</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>   <span class="mi">0</span><span class="p">]</span>
<span class="p">]</span>
</code></pre></div>
<p class="continue">then the test framework effectively runs:</p>
<div class="highlight"><pre><span></span><code><span class="n">test_subtract</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">test_subtract</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">test_subtract</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>Make sure that all the tests run even if some fail or have errors.</p>
<h3 class="exercise">Capturing output</h3>
<ol>
<li>
<p>Read <a href="https://docs.pytest.org/en/6.2.x/capture.html">the documentation</a>
    that explains how to capture <a class="gl-ref" href="../glossary/#stdout" markdown="1">standard output</a>
    when using <a href="https://docs.pytest.org/">pytest</a>.</p>
</li>
<li>
<p>Modify this chapter&rsquo;s testing tool so that
    users can check what a function prints to standard output
    as part of a unit test.</p>
</li>
</ol>
          
        </main>
      </div>
    </div>
  </body>
</html>
