<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../../logo.svg">
<link rel="stylesheet" href="../../tango.css" type="text/css">
<link rel="stylesheet" href="../../mccole.css" type="text/css">
<title>Software Design by Example &middot; A Database</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


    <script src="../../slides.js" defer></script>
    <link rel="stylesheet" href="../../slides.css">
  </head>
  <body>
<div class="row notex">
  <div class="col-12 center">
    <h1>A Database</h1>
    <p class="subtitle">Software Design by Example</p>
  </div>
</div>
<hr>
<h2>The Problem</h2>
<ul>
<li>
<p>Persisting objects (<a href="../../persist/">Chapter&nbsp;16</a>) lets us save and restore program state</p>
</li>
<li>
<p>But we often want fast lookup <em>without</em> reloading all the data</p>
</li>
<li>
<p>And interoperability across languages</p>
</li>
<li>
<p>Create a simple <a class="gl-ref" href="../../glossary/#log_structured_db" markdown="1">log-structured database</a></p>
</li>
</ul>
<hr />
<h2>Starting Point</h2>
<ul>
<li>
<p>A simple <a class="gl-ref" href="../../glossary/#key_value_store" markdown="1">key-value store</a> that lets us look things up</p>
</li>
<li>
<p>User must provide a function that gets key from record</p>
</li>
</ul>
<div class="language-py" title="interface_original.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Database</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with function to get key.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_func</span> <span class="o">=</span> <span class="n">key_func</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the given record.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return record associated with key or None.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Just a Dictionary</h2>
<ul>
<li>Store in memory using a dictionary</li>
</ul>
<div class="language-py" title="just_dict_original.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">interface_original</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="k">class</span> <span class="nc">JustDict</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_func</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_func</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Lets us start writing tests</li>
</ul>
<hr />
<h2>Experimental Records</h2>
<div class="language-py" title="record_original.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BasicRec</span><span class="p">:</span>
    <span class="n">MAX_NAME_LEN</span> <span class="o">=</span> <span class="mi">6</span>     <span class="c1"># length of name in chars</span>
    <span class="n">TIMESTAMP_LEN</span> <span class="o">=</span> <span class="mi">8</span>    <span class="c1"># length of timestamp in chars</span>
    <span class="n">MAX_READING</span> <span class="o">=</span> <span class="mi">10</span>     <span class="c1"># maximum reading value</span>
    <span class="n">MAX_READING_LEN</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># length of reading in chars</span>
    <span class="n">MAX_READINGS_NUM</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># maximum number of readings</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">BasicRec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">_name</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">readings</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_NAME_LEN</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">readings</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_READINGS_NUM</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">((</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_READING</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">readings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readings</span> <span class="o">=</span> <span class="n">readings</span>

    <span class="c1"># [omit]</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readings</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span><span class="si">}</span><span class="s2">)[</span><span class="si">{</span><span class="n">joined</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_timestamp</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_readings</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_readings</span><span class="p">)</span>
    <span class="c1"># [/omit]</span>
</code></pre></div>
</div>
<hr />
<h2>Test Fixtures</h2>
<ul>
<li>Use the <code>pytest.fixture</code> decorator from <a href="../../func/">Chapter&nbsp;8</a></li>
</ul>
<div class="language-py" title="test_db_original.py">
<div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">db</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">JustDict</span><span class="p">(</span><span class="n">BasicExperiment</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">ex01</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">BasicExperiment</span><span class="p">(</span><span class="s2">&quot;ex01&quot;</span><span class="p">,</span> <span class="mi">12345</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">ex02</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">BasicExperiment</span><span class="p">(</span><span class="s2">&quot;ex02&quot;</span><span class="p">,</span> <span class="mi">67890</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</code></pre></div>
</div>
<hr />
<h2>Tests</h2>
<div class="language-py" title="test_db_original.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_construct</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">db</span>

<span class="k">def</span> <span class="nf">test_get_nothing_from_empty_db</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;something&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">test_add_then_get</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ex01</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ex01</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex01&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ex01</span>

<span class="k">def</span> <span class="nf">test_add_two_then_get_both</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ex01</span><span class="p">,</span> <span class="n">ex02</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ex01</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ex02</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex01&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ex01</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex02&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ex02</span>

<span class="k">def</span> <span class="nf">test_add_then_overwrite</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ex01</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ex01</span><span class="p">)</span>
    <span class="n">ex01</span><span class="o">.</span><span class="n">_timestamp</span> <span class="o">=</span> <span class="mi">67890</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ex01</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ex01&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ex01</span>
</code></pre></div>
</div>
<hr />
<h2>Refactor Interface</h2>
<ul>
<li>
<p>We&rsquo;re going to need other record manipulation functions</p>
</li>
<li>
<p>So save the record class instead of the key function</p>
</li>
</ul>
<div class="language-py" title="interface.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Database</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with data manipulation functions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span> <span class="o">=</span> <span class="n">record_cls</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the given record.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return record associated with key or None.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Refactor Database</h2>
<ul>
<li>Corresponding change to use a <a class="gl-ref" href="../../glossary/#static_method" markdown="1">static method</a>
    of the record class</li>
</ul>
<div class="language-py" title="just_dict_refactored.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">interface</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="k">class</span> <span class="nc">JustDictRefactored</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">record_cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Saving Records</h2>
<ul>
<li>
<p>Records must know how to pack and unpack themselves</p>
</li>
<li>
<p>Start by calculating the size of each</p>
</li>
</ul>
<div class="language-py" title="record.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Experiment</span><span class="p">(</span><span class="n">BasicRec</span><span class="p">):</span>
    <span class="n">RECORD_LEN</span> <span class="o">=</span> <span class="n">BasicRec</span><span class="o">.</span><span class="n">MAX_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span> \
        <span class="o">+</span> <span class="n">BasicRec</span><span class="o">.</span><span class="n">TIMESTAMP_LEN</span> <span class="o">+</span> <span class="mi">1</span> \
        <span class="o">+</span> <span class="p">(</span><span class="n">BasicRec</span><span class="o">.</span><span class="n">MAX_READING_LEN</span> <span class="o">*</span> <span class="n">BasicRec</span><span class="o">.</span><span class="n">MAX_READINGS_NUM</span><span class="p">)</span> \
        <span class="o">+</span> <span class="p">(</span><span class="n">BasicRec</span><span class="o">.</span><span class="n">MAX_READINGS_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Experiment</span><span class="o">.</span><span class="n">RECORD_LEN</span>
</code></pre></div>
</div>
<hr />
<h2>Packing</h2>
<div class="language-py" title="record.py">
<div class="highlight"><pre><span></span><code>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">Experiment</span><span class="p">)</span>
        <span class="n">readings</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">_readings</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="se">\0</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">_timestamp</span><span class="si">}</span><span class="se">\0</span><span class="si">{</span><span class="n">readings</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Experiment</span><span class="o">.</span><span class="n">RECORD_LEN</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">RECORD_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Save as strings with <a class="gl-ref" href="../../glossary/#null_byte" markdown="1">null byte</a> <code>\0</code> between them</p>
</li>
<li>
<p>A real implementation would pack as binary (<a href="../../binary/">Chapter&nbsp;17</a>)</p>
</li>
</ul>
<hr />
<h2>Unpacking</h2>
<div class="language-py" title="record.py">
<div class="highlight"><pre><span></span><code>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">raw</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">readings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">readings</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Note: this doesn&rsquo;t handle strings with null bytes</p>
<ul>
<li>A real implementation would etc.</li>
</ul>
</li>
<li>
<p>Methods for packing and unpacking multiple records are straightforward</p>
</li>
</ul>
<hr />
<h2>A File-Backed Database</h2>
<figure id="db-single-file">
<img src="../single_file.svg" alt="Using a single file"/>
<figcaption>Saving the entire database in a single file.</figcaption>
</figure>

<hr />
<h2>A File-Backed Database</h2>
<div class="language-py" title="file_backed.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FileBacked</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">record_cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Needs two <a class="gl-ref" href="../../glossary/#helper_method" markdown="1">helper methods</a></li>
</ul>
<hr />
<h2>A File-Backed Database</h2>
<div class="language-py" title="file_backed.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">pack_multi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">packed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">unpack_multi</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">r</span><span class="p">):</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">}</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Still saving and loading entire database</p>
</li>
<li>
<p>But look at all the infrastructure we&rsquo;ve built</p>
</li>
</ul>
<hr />
<h2>Saving Blocks</h2>
<ul>
<li>
<p>Save <em>N</em> records per <a class="gl-ref" href="../../glossary/#block_memory" markdown="1">block</a></p>
</li>
<li>
<p>Keep the <a class="gl-ref" href="../../glossary/#index_database" markdown="1">index</a> in memory</p>
</li>
<li>
<p>When writing, only modify one block (smaller and faster)</p>
</li>
<li>
<p>When reading, only load one block (ditto)</p>
</li>
</ul>
<hr />
<h2>Allocating Blocks</h2>
<figure id="db-alloc">
<img src="../alloc.svg" alt="Mapping records to blocks"/>
<figcaption>Mapping records to blocks.</figcaption>
</figure>

<hr />
<h2>Store Blocks in Memory</h2>
<div class="language-py" title="blocked.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Blocked</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
    <span class="n">RECORDS_PER_BLOCK</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Blocked</span><span class="o">.</span><span class="n">RECORDS_PER_BLOCK</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">record_cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">num_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">num_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Adding a Record</h2>
<div class="language-py" title="blocked.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="n">seq_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_seq_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_id</span>
        <span class="n">block_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block_id</span><span class="p">(</span><span class="n">seq_id</span><span class="p">)</span>
        <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span>
        <span class="n">block</span><span class="p">[</span><span class="n">seq_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Get the sequence ID for this record</p>
</li>
<li>
<p>Store the key-to-sequence mapping in the index</p>
</li>
<li>
<p>Find or create the right block</p>
</li>
<li>
<p>Add the record</p>
</li>
</ul>
<hr />
<h2>Getting a Record</h2>
<div class="language-py" title="blocked.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">seq_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">block_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block_id</span><span class="p">(</span><span class="n">seq_id</span><span class="p">)</span>
        <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span><span class="p">[</span><span class="n">seq_id</span><span class="p">]</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Do we even know about this record?</p>
</li>
<li>
<p>Find its current sequence ID</p>
</li>
<li>
<p>Find the corresponding block</p>
</li>
<li>
<p>Get the record</p>
</li>
</ul>
<hr />
<h2>Helper Methods</h2>
<div class="language-py" title="blocked.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_next_seq_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seq_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">seq_id</span>

    <span class="k">def</span> <span class="nf">_get_block_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">seq_id</span> <span class="o">//</span> <span class="n">Blocked</span><span class="o">.</span><span class="n">RECORDS_PER_BLOCK</span>

    <span class="k">def</span> <span class="nf">_get_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_id</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">block_id</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span>
</code></pre></div>
</div>
<hr />
<h2>Persisting Blocks</h2>
<ul>
<li>Use inheritance to do everything described above while saving and loading blocks</li>
</ul>
<div class="language-py" title="blocked_file.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BlockedFile</span><span class="p">(</span><span class="n">Blocked</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_cls</span><span class="p">,</span> <span class="n">db_dir</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">record_cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>
</div>
<hr />
<h2>Saving</h2>
<div class="language-py" title="blocked_file.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="n">seq_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">block_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block_id</span><span class="p">(</span><span class="n">seq_id</span><span class="p">)</span>

        <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">pack_multi</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">packed</span><span class="p">))</span>
</code></pre></div>
</div>
<ul>
<li>Have to pack and save all the records in the block</li>
</ul>
<hr />
<h2>Loading</h2>
<div class="language-py" title="blocked_file.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">seq_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">block_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block_id</span><span class="p">(</span><span class="n">seq_id</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">unpack_multi</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">*</span> <span class="n">block_id</span>
        <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
            <span class="n">block</span><span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
</code></pre></div>
</div>
<ul>
<li>Unpack all the records in the block</li>
</ul>
<hr />
<h2>Why Split Loading?</h2>
<ul>
<li>Need to initialize the in-memory index when restarting the database</li>
</ul>
<div class="language-py" title="blocked_file.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seq_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">block_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_block</span><span class="p">(</span><span class="n">block_id</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_cls</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_id</span>
                <span class="n">seq_id</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<ul>
<li>
<p>Obvious extension: save the index in another file</p>
</li>
<li>
<p>Would have to profile (<a href="../../perf/">Chapter&nbsp;15</a>) to see if this was worthwhile</p>
</li>
</ul>
<hr />
<h2>Next Steps</h2>
<ul>
<li>
<p>Clean up unused files</p>
</li>
<li>
<p><a class="gl-ref" href="../../glossary/#compact" markdown="1">Compact</a> storage periodically</p>
</li>
<li>
<p>Use other data structures for indexing</p>
</li>
</ul>
<hr />
<!--# class="summary" -->

<h2>Summary</h2>
<figure id="db-concept-map">
<img src="../concept_map.svg" alt="Concept map for database"/>
<figcaption>Concept map.</figcaption>
</figure>
  </body>
</html>
