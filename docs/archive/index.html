<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../tango.css" type="text/css">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>Software Design by Example &middot; A File Archiver</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>


  </head>
  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.routledge.com/Software-Design-by-Example-A-Tool-Based-Introduction-with-Python/Wilson/p/book/9781032725215"><img src="../sdxpy-cover.png" alt="Book cover" class="bookcover" /></a>
  
</p>

<div class="screen-reader-only">
  <a href="#printable">Skip to content</a>
</div>

<ol class="toc-chapters"><li><a href="../intro/">Introduction</a></li><li><a href="../oop/">Objects and Classes</a></li><li><a href="../dup/">Finding Duplicate Files</a></li><li><a href="../glob/">Matching Patterns</a></li><li><a href="../parse/">Parsing Text</a></li><li><a href="../test/">Running Tests</a></li><li><a href="../interp/">An Interpreter</a></li><li><a href="../func/">Functions and Closures</a></li><li><a href="../protocols/">Protocols</a></li><li><a href="../archive/">A File Archiver</a></li><li><a href="../check/">An HTML Validator</a></li><li><a href="../template/">A Template Expander</a></li><li><a href="../lint/">A Code Linter</a></li><li><a href="../layout/">Page Layout</a></li><li><a href="../perf/">Performance Profiling</a></li><li><a href="../persist/">Object Persistence</a></li><li><a href="../binary/">Binary Data</a></li><li><a href="../db/">A Database</a></li><li><a href="../build/">A Build Manager</a></li><li><a href="../pack/">A Package Manager</a></li><li><a href="../ftp/">Transferring Files</a></li><li><a href="../http/">Serving Web Pages</a></li><li><a href="../viewer/">A File Viewer</a></li><li><a href="../undo/">Undo and Redo</a></li><li><a href="../vm/">A Virtual Machine</a></li><li><a href="../debugger/">A Debugger</a></li><li><a href="../observe/">Observers</a></li><li><a href="../docgen/">Generating Documentation</a></li><li><a href="../search/">Search</a></li><li><a href="../compress/">File Compression</a></li><li><a href="../cache/">A File Cache</a></li><li><a href="../query/">A Query Builder</a></li><li><a href="../concur/">Concurrency</a></li><li><a href="../finale/">Conclusion</a></li></ol>
<ol class="toc-appendices"><li><a href="../bib/">Bibliography</a></li><li><a href="../bonus/">Bonus Material</a></li><li><a href="../syllabus/">Syllabus</a></li><li><a href="../license/">License</a></li><li><a href="../conduct/">Code of Conduct</a></li><li><a href="../contrib/">Contributing</a></li><li><a href="../glossary/">Glossary</a></li><li><a href="../colophon/">Colophon</a></li><li><a href="../contents/">Index</a></li></ol>


<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


<p><a href="https://github.com/gvwilson/sdxpy">GitHub repository</a></p>

      </div>
      <div id="printable" class="contents bordered">
	<main>
	  <div class="row notex">
  <div class="col-12 center">
    
      <h1>A File Archiver</h1>
    
  </div>
</div>

	  
<nav class="row-always notex">
  <div class="col-1 left">
    <a href="../protocols/" title="previous" class="undecorated">&#8678;</a>
  </div>
  <div class="col-10 center">
    <a href="../" title="home" class="undecorated">&#9737;</a>
  </div>
  <div class="col-1 right">
    <a href="../check/" title="next" class="undecorated">&#8680;</a>
  </div>
</nav>


	  <ul class="keypoints">
<li>Version control tools use hashing to uniquely identify each saved file.</li>
<li>Each snapshot of a set of files is recorded in a manifest.</li>
<li>Using a mock filesystem for testing is safer and faster than using the real thing.</li>
<li>Operations involving multiple files may suffer from race conditions.</li>
<li>Use a base class to specify what a component must be able to do and derive child classes to implement those operations.</li>
</ul>
	  <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#atomic_operation" markdown="1">atomic operation</a>, <a class="gl-ref" href="../glossary/#base_class" markdown="1">base class</a>, <a class="gl-ref" href="../glossary/#data_migration" markdown="1">data migration</a>, <a class="gl-ref" href="../glossary/#file_compression" markdown="1">compression (of file)</a>, <a class="gl-ref" href="../glossary/#file_locking" markdown="1">file locking</a>, <a class="gl-ref" href="../glossary/#helper_function" markdown="1">helper function</a>, <a class="gl-ref" href="../glossary/#manifest" markdown="1">manifest</a>, <a class="gl-ref" href="../glossary/#race_condition" markdown="1">race condition</a>, <a class="gl-ref" href="../glossary/#successive_refinement" markdown="1">successive refinement</a>, <a class="gl-ref" href="../glossary/#timestamp" markdown="1">timestamp</a>, <a class="gl-ref" href="../glossary/#toctou" markdown="1">time of check - time of use</a>, <a class="gl-ref" href="../glossary/#top_down_design" markdown="1">top-down design</a>, <a class="gl-ref" href="../glossary/#utc" markdown="1">Coordinated Universal Time</a>, <a class="gl-ref" href="../glossary/#version_control_system" markdown="1">version control system</a>
</p>
	  <p>We&rsquo;ve written almost a thousand lines of Python so far.
We could recreate it if we had to,
but we&rsquo;d rather not have to.
We&rsquo;d also like to be able to see what we&rsquo;ve changed
and to collaborate with other people.</p>
<p>A <a class="gl-ref" href="../glossary/#version_control_system" markdown="1">version control system</a>
like <span class="ix-entry" ix-key="Git" markdown="1"><a href="https://git-scm.com/">Git</a></span>
solves all of these problems at once.
It keeps track of changes to files
so that we can see what we&rsquo;ve changed,
recover old versions,
and merge our changes with those made by other people.</p>
<p>The core of a modern version control tool
is a way to archive files that:</p>
<ol>
<li>
<p>records which versions of which files existed at the same time,
    so that we can go back to a consistent previous state,
    and</p>
</li>
<li>
<p>stores any particular version of a file only once,
    so that we don&rsquo;t waste disk space.</p>
</li>
</ol>
<p>This chapter builds a tool that does both tasks.
It won&rsquo;t create and merge branches;
if you would like to see how that works,
please see <span class="ix-entry" ix-key="Cook, Mary Rose" markdown="1"><a href="https://maryrosecook.com/">Mary Rose Cook&rsquo;s</a></span> <a href="http://gitlet.maryrosecook.com/">Gitlet</a>
or <span class="ix-entry" ix-key="Polge, Thibault" markdown="1">Thibault Polge&rsquo;s</span> <a href="https://wyag.thb.lt/">Write yourself a Git</a>.</p>
<h2 id="archive-files">Saving Files</h2>
<p>Many files only change occasionally after they&rsquo;re created, or not at all.
It would be wasteful for a version control system to make copies
each time the user saved a snapshot of a project,
so instead we will copy each unique file to something like <code>abcd1234.bck</code>,
where <code>abcd1234</code> is the hash of the file&rsquo;s contents (<a href="../dup/">Chapter&nbsp;3</a>).
We will then record the filenames and hash keys in each snapshot:
The hash keys tell us which unique files existed at the time of the snapshot,
while the filenames tell us what the file&rsquo;s contents were named when the snapshot was made.
To restore a particular snapshot,
we will copy the <code>.bck</code> files back to their original locations
(<a class="fig-ref" href="../archive/#archive-storage">Figure&nbsp;10.1</a>).</p>
<figure id="archive-storage">
<img src="./storage.svg" alt="Backup file storage"/>
<figcaption>Figure&nbsp;10.1: Organization of backup file storage.</figcaption>
</figure>

<p>The first step is to find all the files in or below a given directory
that we need to save.
As described in <a href="../glob/">Chapter&nbsp;4</a>,
Python&rsquo;s <a href="https://docs.python.org/3/library/glob.html"><code>glob</code></a> module can do this for us.
Let&rsquo;s use this to create a table of files and hashes:</p>
<div class="language-py" title="hash_all.py">
<div class="highlight"><pre><span></span><code><span class="n">HASH_LEN</span> <span class="o">=</span> <span class="mi">16</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hash_all</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.*&quot;</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">hash_code</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="n">HASH_LEN</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">hash_code</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>Notice that we&rsquo;re truncating the <span class="ix-entry" ix-key="hash code" markdown="1">hash code</span> of each file
to just 16 <span class="ix-entry" ix-key="hexadecimal" markdown="1">hexadecimal</span> digits.
This greatly increases the odds of <span class="ix-entry" ix-key="collision (in hashing)" markdown="1">collision</span>,
so real version control systems don&rsquo;t do this,
but it makes our program&rsquo;s output easier to show on screen.
For example,
if our test directory looks like this:</p>
<div class="language-out" title="sample_dir.out">
<div class="highlight"><pre><span></span><code>sample_dir
|-- a.txt
|-- b.txt
`-- sub_dir
    `-- c.txt

1 directory, 3 files
</code></pre></div>
</div>
<p class="continue">then our program&rsquo;s output is:</p>
<div class="language-sh" title="hash_all.sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>hash_all.py<span class="w"> </span>sample_dir
</code></pre></div>
</div>
<div class="language-out" title="hash_all.out">
<div class="highlight"><pre><span></span><code>filename,hash
b.txt,3cf9a1a81f6bdeaf
a.txt,17e682f060b5f8e4
sub_dir/c.txt,5695d82a086b6779
</code></pre></div>
</div>
<h2 id="archive-test">Testing</h2>
<p>Before we go any further
we need to figure out how we&rsquo;re going to test our code.
The obvious approach is to create directories and sub-directories
containing some files we can use as <span class="ix-entry" ix-key="fixture" markdown="1">fixtures</span>.
However,
we are going to change or delete those files
as we back things up and restore them.
To make sure early tests don&rsquo;t contaminate later ones,
we would have to recreate those files and directories after each test.</p>
<p>As discussed in <a href="../protocols/">Chapter&nbsp;9</a>,
a better approach is to use a <span class="ix-entry" ix-key="mock object" markdown="1">mock object</span>
instead of the real filesystem.
The <a href="https://pytest-pyfakefs.readthedocs.io/"><code>pyfakefs</code></a> module replaces key functions like <code>open</code>
with functions that behave the same way
but act on &ldquo;files&rdquo; stored in memory
(<a class="fig-ref" href="../archive/#archive-mock-fs">Figure&nbsp;10.2</a>).
Using it prevents our tests from accidentally disturbing the filesystem;
it also makes tests much faster
since in-memory operations are thousands of times faster than ones that touch the disk.</p>
<figure id="archive-mock-fs">
<img src="./mock_fs.svg" alt="Mock filesystem"/>
<figcaption>Figure&nbsp;10.2: Using a mock filesystem to simplify testing.</figcaption>
</figure>

<p>If we <code>import pyfakefs</code>,
we automatically get a fixture called <code>fs</code>
that we can use to create files.
We tell <a href="https://docs.pytest.org/">pytest</a> we want to use this fixture
by passing it as an argument to our testing function:</p>
<div class="language-py" title="test_mock_fs.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_simple_example</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="s2">&quot;This file contains one sentence.&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;alpha.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;alpha.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;alpha.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">==</span> <span class="n">sentence</span>
</code></pre></div>
</div>
<p>We can use <code>fs</code> to create more complicated fixtures of our own
with multiple directories and files:</p>
<div class="language-py" title="test_mock_tree.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">our_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">&quot;aaa&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;b.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">&quot;bbb&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;sub_dir/c.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">&quot;ccc&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_nested_example</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;b.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;sub_dir/c.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_deletion_example</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">and then test that <code>hash_all</code> finds all the files:</p>
<div class="language-py" title="test_hash_all.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">hash_all</span><span class="w"> </span><span class="kn">import</span> <span class="n">hash_all</span><span class="p">,</span> <span class="n">HASH_LEN</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">our_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">&quot;aaa&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;b.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">&quot;bbb&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;sub_dir/c.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">&quot;ccc&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_hashing</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;b.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_dir/c.txt&quot;</span><span class="p">}</span>
    <span class="k">assert</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span> <span class="o">==</span> <span class="n">expected</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">HASH_LEN</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>

<span class="c1"># [change]</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_change</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">original</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">original</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;a.txt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;this is new content for a.txt&quot;</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">changed</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;a.txt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">original</span> <span class="o">!=</span> <span class="n">changed</span>
<span class="c1"># [/change]</span>
</code></pre></div>
</div>
<p class="continue">and that hashes change when files change:</p>
<div class="language-py" title="test_hash_all.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_change</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">original</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">original</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;a.txt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;this is new content for a.txt&quot;</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">changed</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;a.txt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">original</span> <span class="o">!=</span> <span class="n">changed</span>
</code></pre></div>
</div>
<h2 id="archive-track">Tracking Backups</h2>
<p>The second part of our backup tool
keeps track of which files have and haven&rsquo;t been backed up already.
It stores backups in a directory that contains files like <code>abcd1234.bck</code>
(the hash followed by <code>.bck</code>)
and creates a <a class="gl-ref" href="../glossary/#manifest" markdown="1">manifest</a>
that describes the content of each snapshot.
A real system would support remote storage as well
so that losing one hard drive wouldn&rsquo;t mean losing all our work,
so we need to design our system with multiple back ends in mind.</p>
<p>For now,
we will store manifests in <span class="ix-entry" ix-key="CSV" markdown="1">CSV</span> files named <code>ssssssssss.csv</code>,
where <code>ssssssssss</code> is the <a class="gl-ref" href="../glossary/#utc" markdown="1">UTC</a> <a class="gl-ref" href="../glossary/#timestamp" markdown="1">timestamp</a>
of the backup&rsquo;s creation.</p>
<div class="callout">
<h3>Time of Check/Time of Use</h3>
<p>Our naming convention for manifests will fail
if we try to create two or more backups in the same second.
This might seem unlikely,
but many faults and security holes
are the result of programmers assuming things weren&rsquo;t going to happen.</p>
<p>We could try to avoid this problem by using a two-part naming scheme <code>ssssssss-a.csv</code>,
<code>ssssssss-b.csv</code>, and so on,
but this leads to a <a class="gl-ref" href="../glossary/#race_condition" markdown="1">race condition</a>
called <a class="gl-ref" href="../glossary/#toctou" markdown="1">time of check/time of use</a>.
If two users run the backup tool at the same time,
they will both see that there isn&rsquo;t a file (yet) with the current timestamp,
so they will both try to create the first one.
Ensuring that multi-file updates are <a class="gl-ref" href="../glossary/#atomic_operation" markdown="1">atomic operations</a>
(i.e., that they always appear to be a single indivisible step)
is a hard problem;
<a class="gl-ref" href="../glossary/#file_locking" markdown="1">file locking</a> is a common approach,
but complete solutions are out of the scope of this book.</p>
</div>
<p>This function creates a backup—or rather,
it will once we fill in all the functions it depends on:</p>
<div class="language-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">backup</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">backup_dir</span><span class="p">):</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">current_time</span><span class="p">()</span>
    <span class="n">write_manifest</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
    <span class="n">copy_files</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">backup_dir</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">manifest</span>
</code></pre></div>
</div>
<p class="continue">Writing a high-level function first
and then filling in the things it needs
is called <a class="gl-ref" href="../glossary/#successive_refinement" markdown="1">successive refinement</a>
or <a class="gl-ref" href="../glossary/#top_down_design" markdown="1">top-down design</a>.
In practice,
nobody designs code and then implements the design without changes
unless they have solved closely-related problems before <span class="bib-ref">[<a class="bib-ref" href="../bib/#Petre2016">Petre2016</a>]</span>.
Instead,
good programmers jump back and forth between higher and lower levels of design,
adjusting their overall strategy as work on low-level details
reveals problems or opportunities they hadn&rsquo;t foreseen.</p>
<p class="continue">When writing the manifest,
we check that the backup directory exists,
create it if it does not,
and then save the manifest as CSV:</p>
<div class="language-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_manifest</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">manifest</span><span class="p">):</span>
    <span class="n">backup_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">backup_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">backup_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="n">manifest_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">We then copy those files that <em>haven&rsquo;t</em> already been saved:</p>
<div class="language-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy_files</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">backup_dir</span><span class="p">,</span> <span class="n">manifest</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">hash_code</span><span class="p">)</span> <span class="ow">in</span> <span class="n">manifest</span><span class="p">:</span>
        <span class="n">source_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">backup_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">backup_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hash_code</span><span class="si">}</span><span class="s2">.bck&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We have introduced several more race conditions here:
for example,
if two people are creating backups at the same time,
they could both discover that the backup directory doesn&rsquo;t exist
and then both try to create it.
Whoever does so first will succeed,
but whoever comes second will fail.
We will look at ways to fix this in the exercises as well.</p>
<div class="callout">
<h3>What Time Is It?</h3>
<p>Our <code>backup</code> function relies on a <a class="gl-ref" href="../glossary/#helper_function" markdown="1">helper function</a>
called <code>current_time</code>
that does nothing but call <code>time.time</code> from
<span class="ix-entry" ix-key="Python standard library" markdown="1">Python&rsquo;s standard library</span>:</p>
<div class="language-py" title="backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">current_time</span><span class="p">():</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
</div>
<p class="continue">We could call <code>time.time</code> directly,
but wrapping it up like this makes it easier to replace with a mock for testing.</p>
</div>
<p>Let&rsquo;s do one test with real files:</p>
<div class="language-sh" title="test_backup_manual.sh">
<div class="highlight"><pre><span></span><code><span class="nv">BACKUPS</span><span class="o">=</span>/tmp/backups
rm<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$BACKUPS</span>
python<span class="w"> </span>backup.py<span class="w"> </span>sample_dir<span class="w"> </span><span class="nv">$BACKUPS</span>
tree<span class="w"> </span>--charset<span class="w"> </span>ascii<span class="w"> </span><span class="nv">$BACKUPS</span>
</code></pre></div>
</div>
<div class="language-out" title="test_backup_manual.out">
<div class="highlight"><pre><span></span><code>/tmp/backups
|-- 1695482691.csv
|-- 17e682f060b5f8e4.bck
|-- 3cf9a1a81f6bdeaf.bck
`-- 5695d82a086b6779.bck

0 directories, 4 files
</code></pre></div>
</div>
<p>The rest of our tests use a fake filesystem
and a mock replacement for the <code>current_time</code> function
(so that we know what the manifest file will be called).
The setup is:</p>
<div class="language-py" title="test_backup.py">
<div class="highlight"><pre><span></span><code><span class="n">FILES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a.txt&quot;</span><span class="p">:</span> <span class="s2">&quot;aaa&quot;</span><span class="p">,</span> <span class="s2">&quot;b.txt&quot;</span><span class="p">:</span> <span class="s2">&quot;bbb&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_dir/c.txt&quot;</span><span class="p">:</span> <span class="s2">&quot;ccc&quot;</span><span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">our_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="n">FILES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">contents</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">and an example of a single test is:</p>
<div class="language-py" title="test_backup.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_nested_example</span><span class="p">(</span><span class="n">our_fs</span><span class="p">):</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">1234</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;backup.current_time&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">timestamp</span><span class="p">):</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">backup</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/backup&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/backup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">hash_code</span> <span class="ow">in</span> <span class="n">manifest</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/backup&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hash_code</span><span class="si">}</span><span class="s2">.bck&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>
</div>
<h2 id="archive-refactor">Refactoring</h2>
<p>Now that we have a better idea of what we&rsquo;re doing,
we can <span class="ix-entry" ix-key="refactor" markdown="1">refactor</span> to create a <a class="gl-ref" href="../glossary/#base_class" markdown="1">base class</a>
that prescribes the general steps in creating a backup:</p>
<div class="language-py" title="backup_oop.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Archive</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_dir</span> <span class="o">=</span> <span class="n">source_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">hash_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_files</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">manifest</span>
</code></pre></div>
</div>
<p>We can then derive a <span class="ix-entry" ix-key="child class" markdown="1">child class</span>
to archive things locally
and fill in its methods by re-using code from the functions
we have just written.
Once we&rsquo;ve done this,
we can create the specific archiver we want with a single line:</p>
<div class="language-py" title="backup_oop.py">
<div class="highlight"><pre><span></span><code>    <span class="n">archiver</span> <span class="o">=</span> <span class="n">ArchiveLocal</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">backup_dir</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Doing this makes life easier when we want to write archivers
that behave the same way but work differently.
For example,
we could create an archiver that <a class="gl-ref" href="../glossary/#file_compression" markdown="1">compresses</a>
the files it archives
by deriving a new class from <code>ArchiveLocal</code>
and writing a new <code>_copy_files</code> method.
More importantly,
other code can use an archiver <em>without knowing what it&rsquo;s doing</em>.
For example,
the function <code>analyze_and_save</code> reads some data,
analyzes it,
saves the results,
and then creates an archive of those results.
It doesn&rsquo;t know whether the archive is compressing files
or whether they&rsquo;re being saved locally or remotely.</p>
<div class="language-py" title="backup_oop.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_and_save</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">archiver</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">analyze_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">save_everything</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">archiver</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">This example highlights one of the strengths of <span class="ix-entry" ix-key="object-oriented programming" markdown="1">object-oriented programming</span>:
it allows old code to use new code without any changes.</p>
<h2 id="archive-summary">Summary</h2>
<p><a class="fig-ref" href="../archive/#archive-concept-map">Figure&nbsp;10.3</a> summarizes the key ideas in this chapter,
which are the foundation of most modern tools for doing backups and version control.</p>
<figure id="archive-concept-map" class="here">
<img src="./concept_map.svg" alt="Concept map of file backup"/>
<figcaption>Figure&nbsp;10.3: Concept map for hashing-based file backup.</figcaption>
</figure>

<h2 id="archive-exercises">Exercises</h2>
<h3 class="exercise">Sequencing Backups</h3>
<p>Modify the backup program so that manifests are numbered sequentially
as <code>00000001.csv</code>, <code>00000002.csv</code>, and so on
rather than being timestamped.
Why doesn&rsquo;t this solve the time of check/time of use race condition mentioned earlier?</p>
<h3 class="exercise">JSON Manifests</h3>
<ol>
<li>
<p>Modify <code>backup.py</code> so that it can save <span class="ix-entry" ix-key="JSON" markdown="1">JSON</span> manifests as well as CSV manifests
    based on a command-line flag.</p>
</li>
<li>
<p>Write another program called <code>migrate.py</code> that converts a set of manifests
    from CSV to JSON.
    (The program&rsquo;s name comes from the term <a class="gl-ref" href="../glossary/#data_migration" markdown="1">data migration</a>.)</p>
</li>
<li>
<p>Modify <code>backup.py</code> programs so that each manifest stores the user name of the person who created it
    along with file hashes,
    and then modify <code>migrate.py</code> to transform old files into the new format.</p>
</li>
</ol>
<h3 class="exercise">Mock Hashes</h3>
<ol>
<li>
<p>Modify the file backup program
    so that it uses a function called <code>ourHash</code> to hash files.</p>
</li>
<li>
<p>Create a replacement that returns some predictable value,
    such as the first few characters of the data.</p>
</li>
<li>
<p>Rewrite the tests to use this function.
    How did you modify the main program
    so that the tests could control which hashing function is used?</p>
</li>
</ol>
<h3 class="exercise">Comparing Manifests</h3>
<p>Write a program <code>compare-manifests.py</code> that reads two manifest files and reports:</p>
<ul>
<li>
<p>Which files have the same names but different hashes
    (i.e., their contents have changed).</p>
</li>
<li>
<p>Which files have the same hashes but different names
    (i.e., they have been renamed).</p>
</li>
<li>
<p>Which files are in the first hash
    but neither their names nor their hashes are in the second
    (i.e., they have been deleted).</p>
</li>
<li>
<p>Which files are in the second hash
    but neither their names nor their hashes are in the first
    (i.e., they have been added).</p>
</li>
</ul>
<h3 class="exercise">From One State to Another</h3>
<ol>
<li>
<p>Write a program called <code>from_to.py</code> that takes a directory and a manifest file
    as command-line arguments,
    then adds, removes, and/or renames files in the directory
    to restore the state described in the manifest.
    The program should only perform file operations when it needs to,
    e.g.,
    it should not delete a file and re-add it if the contents have not changed.</p>
</li>
<li>
<p>Write some tests for <code>from_to.py</code> using pytest and a mock filesystem.</p>
</li>
</ol>
<h3 class="exercise">File History</h3>
<ol>
<li>
<p>Write a program called <code>file_history.py</code>
    that takes the name of a file as a command-line argument
    and displays the history of that file
    by tracing it back in time through the available manifests.</p>
</li>
<li>
<p>Write tests for your program using pytest and a mock filesystem.</p>
</li>
</ol>
<h3 class="exercise">Pre-commit Hooks</h3>
<p>Modify <code>backup.py</code> to load and run a function called <code>pre_commit</code> from a file called <code>pre_commit.py</code>
stored in the root directory of the files being backed up.
If <code>pre_commit</code> returns <code>True</code>, the backup proceeds;
if it returns <code>False</code> or raises an exception,
no backup is created.</p>
	</main>
	<footer>
  © 2025 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sdxpy">repository</a>
  &middot;
  <a href="../license/">license</a>
  &middot;
  <a href="mailto:gvwilson@third-bit.com">contact</a>
</footer>

      </div>
    </div>
  </body>
</html>
