<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="repo" content="https://github.com/gvwilson/sd4ds">
  <meta name="build_date" content="2023-05-27">
  <meta name="template" content="default">
  <meta name="major" content="Chapter 22">
  <meta name="has_slides" content="true">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design for Data Scientists: A Web Server</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design for Data Scientists</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../intro/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../dup/">
      Finding Duplicate Files
    </a>
  </li>
  
  <li>
    <a href="../glob/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parse/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../test/">
      A Test Runner
    </a>
  </li>
  
  <li>
    <a href="../interp/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../func/">
      Functions and Closures
    </a>
  </li>
  
  <li>
    <a href="../mock/">
      Mock Objects
    </a>
  </li>
  
  <li>
    <a href="../archive/">
      A File Archiver
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Objects and Classes
    </a>
  </li>
  
  <li>
    <a href="../check/">
      An HTML Validator
    </a>
  </li>
  
  <li>
    <a href="../lint/">
      A Code Linter
    </a>
  </li>
  
  <li>
    <a href="../template/">
      A Template Expander
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../perf/">
      Performance Profiling
    </a>
  </li>
  
  <li>
    <a href="../persist/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../db/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../build/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../observe/">
      Observers
    </a>
  </li>
  
  <li>
    <a href="../pack/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../server/">
      <strong>A Web Server</strong>
    </a>
  </li>
  
  <li>
    <a href="../editor/">
      A Text Editor
    </a>
  </li>
  
  <li>
    <a href="../undo/">
      Undo and Redo
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../finale/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bib/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../slides/">
      Slides
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contrib/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sd4ds-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 22: A Web Server</h1>


          
<div class="draft">
  <p>DRAFT</p>
</div>
<div class="center">
  <p>
    <em>Please use section heading links to submit feedback.</em>
  </p>
</div>


          
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">Every computer on a network has a unique IP address.</li>
  
  <li markdown="1">The Domain Name System (DNS) translates human-readable names into IP addresses.</li>
  
  <li markdown="1">The programs on each computer send and receive messages through numbered sockets.</li>
  
  <li markdown="1">The program that receives a message must interpret the bytes in the message.</li>
  
  <li markdown="1">The HyperText Transfer Protocol (HTTP) specifies one way to interact via messages over sockets.</li>
  
  <li markdown="1">A minimal HTTP request has a method, a URL, and a protocol version.</li>
  
  <li markdown="1">A complete HTTP request may also have headers and a body.</li>
  
  <li markdown="1">An HTTP response has a status code, a status phrase, and optionally some headers and a body.</li>
  
  <li markdown="1">HTTP is a stateless protocol: the application is responsible for remembering things between requests.</li>
  
  </ul>
  

  

  


          
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#http_body" markdown="1">body (of HTTP request or response)</a>, <a class="gl-ref" href="../glossary/#client" markdown="1">client</a>, <a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System</a>, <a class="gl-ref" href="../glossary/#http_header" markdown="1">header (of HTTP request or response)</a>, <a class="gl-ref" href="../glossary/#http_method" markdown="1">HTTP method</a>, <a class="gl-ref" href="../glossary/#http_protocol_version" markdown="1">HTTP protocol version</a>, <a class="gl-ref" href="../glossary/#http_request" markdown="1">HTTP request</a>, <a class="gl-ref" href="../glossary/#http_response" markdown="1">HTTP response</a>, <a class="gl-ref" href="../glossary/#http_status_code" markdown="1">HTTP status code</a>, <a class="gl-ref" href="../glossary/#http" markdown="1">HyperText Transfer Protocol</a>, <a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol</a>, <a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a>, <a class="gl-ref" href="../glossary/#path_resolution" markdown="1">path resolution</a>, <a class="gl-ref" href="../glossary/#port" markdown="1">port</a>, <a class="gl-ref" href="../glossary/#query_parameter" markdown="1">query parameter</a>, <a class="gl-ref" href="../glossary/#server" markdown="1">server</a>, <a class="gl-ref" href="../glossary/#socket" markdown="1">socket</a>, <a class="gl-ref" href="../glossary/#test_fidelity" markdown="1">test fidelity</a>, <a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol</a>, <a class="gl-ref" href="../glossary/#url" markdown="1">Universal Resource Locator</a>, <a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a>
</p>


          <div class="page-toc"></div>
          <p>The Internet is simpler than most people realize
(as well as being more complex than anyone could possibly comprehend).
Most systems still follow the rules they did thirty years ago;
in particular,
most web servers still handle the same kinds of messages in the same way.</p>
<h2 id="server-tcpip">Section 22.1: Using TCP/IP</h2>
<p>Pretty much every program on the web
runs on a family of communication standards called
<span class="ix-entry" ix-key="Internet Protocol (IP);IP (Internet Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol (IP)</a></span>.
The one that concerns us is the
<span class="ix-entry" ix-key="Transmission Control Protocol (TCP/IP);TCP/IP (Transmission Control Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol (TCP/IP)</a></span>,
which makes communication between computers look like reading and writing files.</p>
<p>Programs using IP communicate through <span class="ix-entry" ix-key="socket" markdown="1"><a class="gl-ref" href="../glossary/#socket" markdown="1">sockets</a></span>
(<a class="fig-ref" href="../server/#server-sockets">Figure 22.1</a>).
Each socket is one end of a point-to-point communication channel,
just like a phone is one end of a phone call.
A socket consists of an <span class="ix-entry" ix-key="IP address" markdown="1"><a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a></span> that identifies a particular machine
and a <span class="ix-entry" ix-key="port" markdown="1"><a class="gl-ref" href="../glossary/#port" markdown="1">port</a></span> on that machine
The IP address consists of four 8-bit numbers,
which are usually written as <code>93.184.216.34</code>;
the <span class="ix-entry" ix-key="Domain Name System (DNS);DNS (Domain Name System)" markdown="1"><a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System (DNS)</a></span>
matches these numbers to symbolic names like <code>example.com</code>
that are easier for human beings to remember.</p>
<p>A port is a number in the range 0-65535
that uniquely identifies the socket on the host machine.
(If an IP address is like a company&rsquo;s phone number,
then a port number is like an extension.)
Ports 0-1023 are reserved for well-known TCP/IP applications like web servers;
custom applications should use the remaining ports
(and should allow users to decide <em>which</em> port,
since there&rsquo;s always the chance that two different people will pick 1234 or 6789).</p>
<figure id="server-sockets">
<img src="./sockets.svg" alt="Sockets, IP addresses, and DNS"/>
<figcaption markdown="1">Figure 22.1: How sockets, IP addresses, and DNS work together.</figcaption>
</figure>

<p>Most web applications consists of <span class="ix-entry" ix-key="client (web application)" markdown="1"><a class="gl-ref" href="../glossary/#client" markdown="1">clients</a></span>
and <span class="ix-entry" ix-key="server (web application)" markdown="1"><a class="gl-ref" href="../glossary/#server" markdown="1">servers</a></span>.
A client program initiates communication by sending a message and waiting for a response;
a server,
on the other hand,
waits for requests and the replies to them.
There are typically many more clients than servers:
for example,
there may be hundreds or thousands of browsers fetching pages from this book&rsquo;s website right now,
but there is only one server handling those requests.</p>
<p>Here&rsquo;s a simple socket client:</p>
<div class="code-sample lang-py" title="socket_client.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">KILOBYTE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;message text&quot;</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client sent </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

<span class="n">received</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">KILOBYTE</span><span class="p">)</span>
<span class="n">received_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">received</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">received</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes: &#39;</span><span class="si">{</span><span class="n">received_str</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>From top to bottom, this code:</p>
<ol>
<li>Imports some modules and defines some constants.
    The most interesting of these is <code>SERVER_ADDRESS</code> consisting of a host identifier and a port.
    The empty string <code>""</code> for the host means &ldquo;the current machine&rdquo;;
    we could also use the string <code>"localhost"</code>.</li>
<li>We use <code>socket.socket</code> to create a new socket.
    The values <code>AF_INET</code> and <code>SOCK_STREAM</code> specify the protocols we&rsquo;re using;
    we&rsquo;ll always use those in our examples,
    so we won&rsquo;t go into details about them.</li>
<li>We connect to the server…</li>
<li>…send our message as a bunch of bytes with <code>sock.sendall</code>…</li>
<li>…and print a message saying the data&rsquo;s been sent.</li>
<li>We then read up to a kilobyte from the socket with <code>sock.recv</code>.
    If we were expecting longer messages,
    we&rsquo;d keep reading from the socket until there was no more data.</li>
<li>Finally, we print another message.</li>
</ol>
<p>The corresponding server is only a little more complicated:</p>
<div class="code-sample lang-py" title="socket_server.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socketserver</span>

<span class="n">KILOBYTE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle a single request.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">KILOBYTE</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;got request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">,</span> <span class="n">MyHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Python&rsquo;s <code>socketserver</code> library provides two things:
a class called <code>TCPServer</code> that listens for incoming connections
and then manages them for us,
and another class called <code>BaseRequestHandler</code>
that does everything <em>except</em> process the incoming data.
In order to do that,
we derive a class of our own from <code>BaseRequestHandler</code> that provides a <code>handle</code> method.
Every time <code>TCPServer</code> gets a new connection
it creates a new object of our class
and calls that object&rsquo;s <code>handle</code> method.
This method is the inverse of the code that sends request.
It:</p>
<ol>
<li>Reads up to a kilobyte from <code>self.request</code>
    (which is set up automatically for us in the base class <code>BaseRequestHandler</code>).</li>
<li>Prints a diagnostic message.</li>
<li>Use <code>self.request</code> again to send data back to whoever we received the message from.</li>
</ol>
<p>The easiest way to test this is to open two terminal windows side by side.
<a class="tbl-ref" href="../server/#server-transcript">Table 22.1</a> shows the sequence of commands and their output:</p>
<div class="table"><table id="server-transcript"><caption>Table 22.1: Sequence of operations in socket client/server interaction</caption>
<thead>
<tr>
<th>Server</th>
<th>Client</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$ python socket_server.py</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>$ python socket_client.py</code></td>
</tr>
<tr>
<td></td>
<td><code>client sent 12 bytes</code></td>
</tr>
<tr>
<td><code>got request from 127.0.0.1: 12</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>client received 30 bytes: 'got request from 127.0.0.1: 12</code></td>
</tr>
</tbody>
</table>
</div>
<div class="callout">
<h3>Testing Multiprocess Applications</h3>
<p>Testing single-process command-line applications is straightforward:
we just run a single command (either directly or via <span class="ix-entry" ix-key="Make" markdown="1"><a href="https://www.gnu.org/software/make/">Make</a></span>).
To test a client-server application,
on the other hand,
we have to start the server,
wait for it to be ready,
then run the client,
and then shut down the server.
It&rsquo;s easy to do this interactively,
but automating it is difficult,
since there&rsquo;s no way to tell how long to wait before trying to talk to the server,
and no easy way to shut the server down.
We will explore some possible approaches once we have a larger application to test.</p>
</div>
<h2 id="server-http">Section 22.2: HTTP</h2>
<p>The <span class="ix-entry" ix-key="Hypertext Transfer Protocol (HTTP);HTTP (Hypertext Transfer Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#http" markdown="1">Hypertext Transfer Protocol (HTTP)</a></span>
specifies one way programs can exchange data over IP.
HTTP is deliberately simple:
the client sends a <span class="ix-entry" ix-key="HTTP request" markdown="1"><a class="gl-ref" href="../glossary/#http_request" markdown="1">request</a></span>
specifying what it wants over a socket connection,
and the server sends a <span class="ix-entry" ix-key="HTTP response" markdown="1"><a class="gl-ref" href="../glossary/#http_response" markdown="1">response</a></span> containing some data.
That data may be copied from a file on disk,
generated dynamically by a program,
or some mix of the two.</p>
<p>The most important thing about an HTTP request is that it&rsquo;s just text:
any program that wants to can create one or parse one.
An absolutely minimal HTTP request has just
a <a class="gl-ref" href="../glossary/#http_method" markdown="1">method</a>,
a <a class="gl-ref" href="../glossary/#url" markdown="1">URL</a>,
and a <a class="gl-ref" href="../glossary/#http_protocol_version" markdown="1">protocol version</a>
on a single line separated by spaces:</p>
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
</code></pre></div>
<p>The HTTP method is almost always either <code>GET</code> (to fetch information)
or <code>POST</code> (to submit form data or upload files).
The URL specifies what the client wants:
it is often a path to a file on disk,
such as <code>/index.html</code>,
but (and this is the crucial part)
it&rsquo;s completely up to the server to decide what to do with it.
The HTTP version is usually &ldquo;HTTP/1.0&rdquo; or &ldquo;HTTP/1.1&rdquo;;
the differences between the two don&rsquo;t matter to us.</p>
<p>Most real requests have a few extra lines called
<span class="ix-entry" ix-key="HTTP header;header (HTTP)" markdown="1"><a class="gl-ref" href="../glossary/#http_header" markdown="1">headers</a></span>,
which are key value pairs like the three shown below:</p>
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
Accept: text/html
Accept-Language: en, fr
If-Modified-Since: 16-May-2022
</code></pre></div>
<p>Unlike the keys in hash tables,
keys may appear any number of times in HTTP headers,
so that (for example)
a request can specify that it&rsquo;s willing to accept several types of content.</p>
<p>Finally,
the <a class="gl-ref" href="../glossary/#http_body" markdown="1">body</a> of the request is any extra data associated with it,
such as form data or uploaded files.
There must be a blank line between the last header and the start of the body
to signal the end of the headers,
and if there is a body,
the request must have a header called <code>Content-Length</code>
that tells the server how many bytes to read.</p>
<p>An HTTP response is formatted like an HTTP request.
Its first line has the protocol,
a <span class="ix-entry" ix-key="HTTP status code;status code (HTTP)" markdown="1"><a class="gl-ref" href="../glossary/#http_status_code" markdown="1">status code</a></span>
like 200 for &ldquo;OK&rdquo; or 404 for &ldquo;Not Found&rdquo;,
and a status phrase (e.g., the word &ldquo;OK&rdquo;).
There are then some headers,
a blank line,
and the body of the response:</p>
<div class="highlight"><pre><span></span><code>HTTP/1.1 200 OK
Date: Thu, 16 June 2022 12:28:53 GMT
Server: minserve/2.2.14 (Linux)
Last-Modified: Wed, 15 Jun 2022 19:15:56 GMT
Content-Type: text/html
Content-Length: 53

&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Hello, World!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
<p>Constructing HTTP requests is tedious,
so most people use libraries to do most of the work.
The most popular such library in Python is called <a href="https://requests.readthedocs.io/">requests</a>.</p>
<div class="code-sample lang-py" title="requests_example.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://third-bit.com/sdxpy/test.html&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;status code:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;content length:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-length&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="requests_example.out">
<div class="highlight"><pre><span></span><code>status code: 200
content length: 103
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Test Page&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;test page&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<p><code>request.get</code> sends an HTTP GET request to a server
and returns an object containing the response (<a class="fig-ref" href="../server/#server-http-lifecycle">Figure 22.2</a>).
That object&rsquo;s <code>status_code</code> member is the response&rsquo;s status code;
its <code>content_length</code> member  is the number of bytes in the response data,
and <code>text</code> is the actual data—in this case, an HTML page
that we can analyze or render.</p>
<figure id="server-http-lifecycle">
<img src="./http_lifecycle.svg" alt="HTTP request/response lifecycle"/>
<figcaption markdown="1">Figure 22.2: Lifecycle of an HTTP request and response.</figcaption>
</figure>

<h2 id="server-static">Section 22.3: Hello, Web</h2>
<p>We&rsquo;re now ready to write a simple HTTP server that will:</p>
<ol>
<li>wait for someone to connect and send an HTTP request;</li>
<li>parse that request;</li>
<li>figure out what it&rsquo;s asking for;</li>
<li>send back an HTML page.</li>
</ol>
<p>Steps 1, 2, and 4 are the same from one application to another,
so the Python standard library has a module called <code>http.server</code>
that contains tools to do that for us.
Here&rsquo;s the entire server:</p>
<div class="code-sample lang-py" title="basic_server.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>

<span class="c1"># Page to send back.</span>
<span class="n">PAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">  &lt;head&gt;&lt;title&gt;Test Page&lt;/title&gt;&lt;/head&gt;</span>
<span class="s2">  &lt;body&gt;&lt;p&gt;test page&lt;/p&gt;&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">PAGE</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Let&rsquo;s start at the bottom and work our way up.</p>
<ol>
<li>Again, <code>SERVER_ADDRESS</code> specifies the server&rsquo;s host and port.</li>
<li>The <code>HTTPServer</code> class takes care of parsing requests and sending back responses.
    When we construct it,
    we give it the server address and the name of the class we&rsquo;ve written
    that handles requests the way we want—in this case, <code>RequestHandler</code>.</li>
<li>Finally, we call the server&rsquo;s <code>serve_forever</code> method,
    which runs until it crashes or we stop it with Ctrl-C.</li>
</ol>
<p>So what does <code>RequestHandler</code> do?</p>
<ol>
<li>When the server receives a <code>GET</code> request,
    it looks in the request handler for a method called <code>do_GET</code>.
    (If it gets a <code>POST</code>, it looks for <code>do_POST</code> and so on.)</li>
<li><code>do_GET</code> converts the text of the page we want to send back
    from characters to bytes—we&rsquo;ll talk about this below.</li>
<li>It then sends a response code (200),
    a couple of headers to say what the content type is
    and how many bytes the receiver should expect,
    and a blank line (produced by the <code>end_headers</code> method).</li>
<li>Finally, <code>do_GET</code> sends the content of the response
    by calling <code>self.wfile.write</code>.
    <code>self.wfile</code> is something that looks and acts like a write-only file,
    but is actually sending bytes to the socket connection.</li>
</ol>
<p>If we run this program from the command line,
it doesn&rsquo;t display anything:</p>
<div class="code-sample lang-sh" title="basic_server.sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>basic_http_server.py
</code></pre></div>
</div>
<p>If we then go to <code>http://localhost:8080</code> with our browser,
though,
we get this in our browser:</p>
<div class="highlight"><pre><span></span><code>Hello, web!
</code></pre></div>
<p>and this in our shell:</p>
<div class="highlight"><pre><span></span><code>127.0.0.1 - - [16/Sep/2022 06:34:59] &quot;GET / HTTP/1.1&quot; 200 -
127.0.0.1 - - [16/Sep/2022 06:35:00] &quot;GET /favicon.ico HTTP/1.1&quot; 200 -
</code></pre></div>
<p>The first line is straightforward:
since we didn&rsquo;t ask for a particular file,
our browser has asked for &lsquo;/&rsquo; (the root directory of whatever the server is serving).
The second line appears because
our browser automatically sends a second request
for an image file called <code>/favicon.ico</code>,
which it will display as an icon in the address bar if it exists.</p>
<h2 id="server-files">Section 22.4: Serving Files</h2>
<p>Serving the same page for every request isn&rsquo;t particularly useful,
so let&rsquo;s rewrite our simple server to return files.
The basic logic looks like this:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">url_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">full_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown object &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">We first turn the path in the URL into a local file path.
(We assume that all paths are <a class="gl-ref" href="../glossary/#path_resolution" markdown="1">resolved</a>
relative to the directory that the server is running in.)
If that path corresponds to a file, we send it back to the client.
If nothing is there,
or if what&rsquo;s there is not a file,
we send an error message.</p>
<p>It might seem simpler to rewrite <code>do_GET</code> to use <code>if</code>/<code>else</code> instead of <code>try</code>/<code>except</code>,
but the latter has an advantage:
we can handle errors that occur inside methods we&rsquo;re calling (like <code>handle_file</code>)
in the same place and in the same way as we handle errors that occur here.
This approach is sometimes called &ldquo;throw low, catch high&rdquo;,
which means that errors should be flagged in many places
but handled in a few places high up in the code.
The method that handles files is an example of this:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">given_path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">given_path</span><span class="si">}</span><span class="s2">&#39; cannot be read&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>If there&rsquo;s an error at any point in the processing cycle
we send a page with an error message
<em>and</em> an error status code:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">ERROR_PAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The error page is just HTML with some placeholders for the path and message:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code><span class="n">ERROR_PAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">  &lt;head&gt;</span>
<span class="s2">    &lt;title&gt;Error accessing </span><span class="si">{path}</span><span class="s2">&lt;/title&gt;</span>
<span class="s2">  &lt;/head&gt;</span>
<span class="s2">  &lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;Error accessing </span><span class="si">{path}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">    &lt;p&gt;</span><span class="si">{msg}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">  &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>
</div>
<p class="continue">The code that actually sends the response is similar to what we&rsquo;ve seen before:</p>
<div class="code-sample lang-py" title="file_server.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">send_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>
</div>
<p>This server works, but only for a very forgiving definition of &ldquo;works&rdquo;.
We are careful not to show clients the actual paths to files on the server
in our error messages,
but if someone asked for <code>http://localhost:8080/../../passwords.txt</code>,
this server will happily look two levels up from the directory where it&rsquo;s running
and try to return that file.
The server machine&rsquo;s passwords probably aren&rsquo;t stored there,
but with enough <code>..</code>&lsquo;s and some patience,
an attacker could poke around large parts of our filesystem.
We will tackle this security hole in the exercises.</p>
<p>Another problem is that <code>send_content</code> always tells clients that
it is returning an HTML file with the <code>Content-Type</code> header.
It should instead look at the extension on the file&rsquo;s name
and set the content type appropriately,
e.g.,
return <code>image/png</code> for a PNG-formatted image.</p>
<p>One thing the server is doing right is character encoding.
The <code>send_content</code> method expects <code>content</code> to be a <code>bytes</code> object,
not a string,
because the HTTP protocol requires the content length to be the number of bytes.
The server reads files in binary mode
by using <code>"rb"</code> instead of just <code>"r"</code> when it opens files in <code>handle_file</code>,
converts the internally-generated error page from characters to bytes
using the <a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a> encoding,
and specifies <code>charset=utf-8</code> as part of the content type.</p>
<h2 id="server-testing">Section 22.5: Testing</h2>
<p>At this point we really need to figure out how to test the servers we&rsquo;re building.
The key to our approach is the notion of <span class="ix-entry" ix-key="fidelity (in testing)" markdown="1"><a class="gl-ref" href="../glossary/#test_fidelity" markdown="1">fidelity</a></span>:
how close is what we test to what we use in production?
In an ideal world they are exactly the same,
but in cases like this it makes sense to sacrifice a little fidelity for testability&rsquo;s sake.</p>
<p>Let&rsquo;s work backward from a test we want to be able to write.
We would like to create a file,
simulate an HTTP GET request,
and check that the status, headers, and content are correct.
In the code below,
the <code>CombinedHandler</code> class does double duty:
it handles the simulated request,
and also stores the values that the client would receive.</p>
<div class="code-sample lang-py" title="test_testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_existing_path</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;actual&quot;</span>
    <span class="n">content_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content_str</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;/actual.txt&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">content_str</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">CombinedHandler</span><span class="p">(</span><span class="s2">&quot;/actual.txt&quot;</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">do_GET</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content_bytes</span><span class="p">))]</span>
    <span class="k">assert</span> <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="o">==</span> <span class="n">content_bytes</span>
</code></pre></div>
</div>
<p>The class we are testing is called <code>CombinedHandler</code>
because it is derived from two things:
a class that implements our application&rsquo;s <code>do_GET</code>
and another class that provides replacements for
the <code>BaseHTTPRequestHandler</code> properties and methods
that our application actually uses.
The latter is just a few lines long,
though it would be larger if our application used
more of <code>BaseHTTPRequestHandler</code>&lsquo;s functionality:</p>
<div class="code-sample lang-py" title="mock_handler.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="k">class</span> <span class="nc">MockRequestHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">send_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">end_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>
</div>
<p>The application-specific class contains the code we&rsquo;ve already seen:</p>
<div class="code-sample lang-py" title="testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ApplicationRequestHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">url_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">full_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown object &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># ...etc...</span>
</code></pre></div>
</div>
<p class="continue">However,
<code>ApplicationRequestHandler</code> <em>doesn&rsquo;t</em> inherit from <code>BaseHTTPRequestHandler</code>.
Instead,
we create a class that combines the two when we need it:</p>
<div class="code-sample lang-py" title="testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">ApplicationRequestHandler</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">serverAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">serverAddress</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">and create another class for testing that combines
the application-specific class with <code>MockHandler</code>.
This class is the <code>CombinedClass</code> that our test uses:</p>
<div class="code-sample lang-py" title="test_testable_server.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CombinedHandler</span><span class="p">(</span><span class="n">MockRequestHandler</span><span class="p">,</span> <span class="n">ApplicationRequestHandler</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
</div>
<p><a class="fig-ref" href="../server/#server-inheritance">Figure 22.3</a> shows the final inheritance hierarchy.
It&rsquo;s a lot of work to test a GET request for one file,
but we can re-use <code>MockRequestHandler</code> to test
the application-specific code for other servers.
Most libraries don&rsquo;t provide helper classes like this to support testing,
but programmers appreciate those that do.</p>
<figure id="server-inheritance">
<img src="./inheritance.svg" alt="Testing class hierarchy"/>
<figcaption markdown="1">Figure 22.3: Class hierarchy for a testable server.</figcaption>
</figure>

<h2 id="server-summary">Section 22.6: Summary</h2>
<figure id="server-concept-map">
<img src="./concept_map.svg" alt="HTTP server concept map"/>
<figcaption markdown="1">Figure 22.4: HTTP server concept map.</figcaption>
</figure>

<h2 id="server-exercises">Section 22.7: Exercises</h2>
<h3 class="exercise">Reading and writing chunks</h3>
<p>Modify the socket client and socket server so that:</p>
<ol>
<li>
<p>the client reads any amount of data from standard input
    (including none at all)
    and sends it to the server in kilobyte-sized chunks;
    and</p>
</li>
<li>
<p>the server reads any amount of data from the socket
    in chunks of four kilobytes
    and sends a message with a byte count back to the client.</p>
</li>
</ol>
<h3 class="exercise">Parsing HTTP requests</h3>
<p>Write a function that takes a list of lines of text as input
and parses them as if they were an HTTP request.
The result should be a dictionary with the request&rsquo;s method,
URL,
protocol version,
and headers.</p>
<h3 class="exercise">Query parameters</h3>
<p>A URL can contain <span class="ix-entry" ix-key="query parameter" markdown="1"><a class="gl-ref" href="../glossary/#query_parameter" markdown="1">query parameters</a></span>.
Read the documentation for the <a href="https://docs.python.org/3/library/urllib.parse.html">urlparse</a> module
and then modify the file server example so that
a URL containing a query parameter <code>bytes=N</code>
(for a positive integer N)
returns the first N bytes of the requested file.</p>
<h3 class="exercise">Better path resolution</h3>
<p>Modify the file server so that:</p>
<ol>
<li>
<p>it must be given the absolute path to a directory
    as a command-line argument
    when started; and</p>
</li>
<li>
<p>it only serves files in or below that directory
    (so that paths containing <code>..</code> and other tricks
    can&rsquo;t be used to retrieve arbitrary files).</p>
</li>
</ol>
<h3 class="exercise">Better content types</h3>
<p>Read the documentation for the <a href="https://docs.python.org/3/library/mimetypes.html">mimetypes</a> module
and then modify the file server to return the correct content type
for files that aren&rsquo;t HTML (such as images).</p>
<h3 class="exercise">Uploading files</h3>
<p>Modify the file server to handle POST requests.</p>
<ol>
<li>
<p>The URL must specify the name of the file being uploaded.</p>
</li>
<li>
<p>The body of the request must be the bytes of the file.</p>
</li>
<li>
<p>All uploaded files are saved in a single directory,
    i.e.,
    upload paths cannot contain directory components.</p>
</li>
</ol>
<h3 class="exercise">Checking content length</h3>
<p>Modify the file server so that:</p>
<ol>
<li>
<p>if the client sends more content than indicated in the <code>Content-Length</code> header,
    the extra bytes are read but ignored; and</p>
</li>
<li>
<p>if the client sends less content,
    the server doesn&rsquo;t wait indefinitely for the missing bytes.</p>
</li>
</ol>
<p>What status code should the server return to the client in each case?</p>
<h3 class="exercise">Directory listing</h3>
<ol>
<li>
<p>Modify the file server so that
    if the path portion of the URL identifies a directory,
    the server returns a plain text list of the directory&rsquo;s contents.</p>
</li>
<li>
<p>Write tests for this using the <a href="https://pytest-pyfakefs.readthedocs.io/">pyfakefs</a> module.</p>
</li>
</ol>
<h3 class="exercise">Dynamic results</h3>
<p>Modify the file server so that if the client requests the &ldquo;file&rdquo; <code>/time</code>,
the server returns an HTML page that reports the current time on the server&rsquo;s machine.</p>
<h3 class="exercise">Templated results</h3>
<p>Modify the file server to:</p>
<ol>
<li>
<p>turn the query parameter&rsquo;s in the URL into a dictionary;</p>
</li>
<li>
<p>use that dictionary to fill in a template page (<a class="x-ref" href="../template/">Chapter 13</a>); and</p>
</li>
<li>
<p>return the resulting HTML page to the client.</p>
</li>
</ol>
        </main>
      </div>
    </div>
  </body>
</html>
