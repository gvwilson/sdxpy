<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design in Python: An Editor</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design in Python</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../tester/">
      A Testing Framework
    </a>
  </li>
  
  <li>
    <a href="../interpreter/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../backup/">
      Versioned File Backups
    </a>
  </li>
  
  <li>
    <a href="../mock/">
      Mock Objects
    </a>
  </li>
  
  <li>
    <a href="../cache/">
      A File Cache
    </a>
  </li>
  
  <li>
    <a href="../dataframe/">
      A Dataframe
    </a>
  </li>
  
  <li>
    <a href="../persistence/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Storage
    </a>
  </li>
  
  <li>
    <a href="../builder/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../templating/">
      A Static Site Generator
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../editor/">
      <strong>An Editor</strong>
    </a>
  </li>
  
  <li>
    <a href="../server/">
      A Web Server
    </a>
  </li>
  
  <li>
    <a href="../packman/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../matching/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parser/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../linter/">
      A Style Checker
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../slides/">
      Slides
    </a>
  </li>
  
  <li>
    <a href="../teaching/">
      Teaching Notes
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxpy-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 13: An Editor</h1>


          
            
<div class="draft">
  <p>DRAFT</p>
</div>


            
  

  

  

  

  

  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">A terminal UI (TUI) can do most of the things that graphical UIs can do.</li>
  
  <li markdown="1">TUI libraries provide a screen abstraction to encapsulate the details of different platforms' terminal applications.</li>
  
  <li markdown="1">Most terminal applications are built around an event loop that waits for user input and takes appropriate action.</li>
  
  <li markdown="1">When testing user interfaces, we usually assume that the rendering layer is working correctly.</li>
  
  <li markdown="1">A text editor must translate between the coordinate systems of the text and the screen.</li>
  
  <li markdown="1">Using a lookup table to map events to actions simplifies design and testing.</li>
  
  </ul>
  

  

  

  

  

  

  

  


            
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#buffer" markdown="1">buffer</a>, <a class="gl-ref" href="../glossary/#delayed_construction_pattern" markdown="1">Delayed Construction pattern</a>, <a class="gl-ref" href="../glossary/#event_loop" markdown="1">event loop</a>, <a class="gl-ref" href="../glossary/#tui" markdown="1">textual user interface</a>
</p>


            <div class="page-toc"></div>
            <p>Early text editors were line-at-a-time applications like the debugger of <a class="x-ref" href="../debugger/">Chapter 20</a>.
Most people prefer to use full-screen interactive editors,
so this chapters builds a simple one to show how they work.
Our design follows <span class="ix-entry" ix-key="Lorgat, Wasim" markdown="1"><a href="https://wasimlorgat.com/">Wasim Lorgat&rsquo;s</a></span>
<a href="https://wasimlorgat.com/posts/editor.html">tutorial</a> closely,
and borrows a few ideas from <span class="ix-entry" ix-key="Equivias, Cristian" markdown="1">[Cristian Esquivias&rsquo;s</span>
<a href="https://github.com/cesquivias/ted"><code>ted</code> editor</a> as well.</p>
<p>Our starting point is Python&rsquo;s <a href="https://docs.python.org/3/library/curses.html">curses</a> module.
It gives programs access to a library called <code>curses</code>,
which provides a uniform interface to terminal applications on several platforms.
These applications can do much more than most people realize—libraries like <a href="https://www.textualize.io/">Textualize</a>
can create <span class="ix-entry" ix-key="terminal UI (TUI)" markdown="1"><a class="gl-ref" href="../glossary/#tui" markdown="1">terminal UIs</a></span> (TUIs)
that can do most of what a modern browser can do,
but we will keep things simple for now.</p>
<h2 id="editor-keystrokes">Section 13.1: Logging Keystrokes</h2>
<p>Let&rsquo;s started by writing a terminal application
that does nothing except wait for a command to quit:</p>
<div class="code-sample lang-py" title="simplest.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">curses</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">scr</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">scr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="s2">&quot;Qq&quot;</span><span class="p">:</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Our application is in a function called <code>main</code>.
Instead of calling it directly,
we pass it to <code>curses.wrapper</code>,
which initializes the terminal library for us
and then calls our function with an object
that represents the terminal.
<code>main</code> then goes into an <span class="ix-entry" ix-key="event loop" markdown="1"><a class="gl-ref" href="../glossary/#event_loop" markdown="1">event loop</a></span>
that waits for a keystroke
and quits if the key is either &lsquo;Q&rsquo; or &lsquo;q&rsquo;.</p>
<p>When we run this program our terminal window goes blank
and stays that way until we quit.
To convince ourselves that it&rsquo;s actually doing something,
we can modify it to save keystrokes to a file for later inspection:</p>
<div class="code-sample lang-py" title="log_keystrokes.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">curses</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">scr</span><span class="p">,</span> <span class="n">logfile</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">scr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="s2">&quot;Qq&quot;</span><span class="p">:</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</code></pre></div>
</div>
<p>We can then test the program interactively
or send characters to standard input
(making sure to send &lsquo;Q&rsquo; as the last character
so that the application exits):</p>
<div class="code-sample lang-sh" title="log_keystrokes.sh">
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;ABCQ&quot;</span> <span class="p">|</span> python log_keystrokes.py log_keystrokes.out
</code></pre></div>
</div>
<div class="code-sample lang-out" title="log_keystrokes.out">
<div class="highlight"><pre><span></span><code>&#39;A&#39;
&#39;B&#39;
&#39;C&#39;
&#39;Q&#39;
</code></pre></div>
</div>
<div class="callout">
<h3>Taking it on Faith</h3>
<p>Testing interactive applications like this one is harder than testing code libraries.
The problem isn&rsquo;t with input:
as the example above shows,
we can send characters to standard input pretty easily.
The problem is that we have no easy way to check what the application displays in response.
We can check whether it (for example) told the terminal to display the letter &lsquo;A&rsquo;
or (in a more complex application) told the browser window to scroll,
but how can we be sure that it actually did those things?
At some point we must either watch the tests drive the application
(which many programmers do as a last check)
or just trust that the layer below ours is doing the right thing.</p>
</div>
<h2 id="editor-file">Section 13.2: Displaying a File</h2>
<p>As mentioned in <a class="x-ref" href="../layout/">Chapter 12</a>,
a screen&rsquo;s <span class="ix-entry" ix-key="coordinate system" markdown="1">coordinate system</span> is upside down:
for historical reasons,
the Y axis starts at the top and increases going down.
Once we&rsquo;ve come to terms with that quirk,
though,
displaying a file is straightfoward:
we call the screen object&rsquo;s <code>addstr</code> method
with a location and some text:</p>
<div class="code-sample lang-py" title="show_file.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">scr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
    <span class="n">scr</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
        <span class="n">scr</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">scr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="s2">&quot;Qq&quot;</span><span class="p">:</span>
            <span class="k">break</span>
</code></pre></div>
</div>
<p>Once <code>main</code> has displayed
the <span class="ix-entry" ix-key="buffer (text)" markdown="1"><a class="gl-ref" href="../glossary/#buffer" markdown="1">text buffer</a></span> it has been given,
it waits for a command to quit.
The text can come from anywhere—here,
we read it from a file and pass it as an extra argument to <code>curses.wrapper</code>,
which in turn passes it to <code>main</code>:</p>
<div class="code-sample lang-py" title="show_file.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="callout">
<h3>Why is it Called a Buffer?</h3>
<p>The word &ldquo;buffer&rdquo; originally meant something that lessened or absorbed an impact.
In computing,
the word is used for a temporary storage area for data.
The former became the latter because
input and output devices often work in bursts
that can temporarily outrun a computer&rsquo;s processing power.
It&rsquo;s therefore common practice to set aside some memory to hold
input that hasn&rsquo;t been processed yet
or output that hasn&rsquo;t yet been displayed.
The term then became used more generally.</p>
</div>
<p>Our little program can now display text,
but only in small amounts.
If we try to display a thousand lines,
each of which is a thousand characters long,
we get an error:</p>
<div class="code-sample lang-py" title="fail_large.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0123456789&#39;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="fail_large.out">
<div class="highlight"><pre><span></span><code>addwstr() returned ERR
</code></pre></div>
</div>
<p>The problem is that we&rsquo;re trying to write outside the physical window.
The solution is to trim what we&rsquo;re displaying to fit inside the available area.
Let&rsquo;s define a <code>Window</code> class to keep track of the display area:</p>
<div class="code-sample lang-py" title="show_large.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Window</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nrow</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ncol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">=</span> <span class="n">nrow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">ncol</span>
</code></pre></div>
</div>
<p>When the main program starts,
it asks the curses module how many lines and columns are available,
uses those values to initialize a <code>Window</code>,
and then only shows the text that lies inside the window
(<a class="fig-ref" href="../editor/#editor-window">Figure 13.1</a>):</p>
<div class="code-sample lang-py" title="show_large.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">scr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
    <span class="n">win</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">curses</span><span class="o">.</span><span class="n">LINES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curses</span><span class="o">.</span><span class="n">COLS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scr</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buffer</span><span class="p">[:</span><span class="n">win</span><span class="o">.</span><span class="n">nrow</span><span class="p">]):</span>
        <span class="n">scr</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="n">win</span><span class="o">.</span><span class="n">ncol</span><span class="p">])</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">scr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="s2">&quot;Qq&quot;</span><span class="p">:</span>
            <span class="k">break</span>
</code></pre></div>
</div>
<figure id="editor-window">
  <img src="./editor_window.svg" alt="Relationship between window and screen"/>
  <figcaption markdown="1">Figure 13.1: Relationship between window and screen.</figcaption>
</figure>

<p>We don&rsquo;t really need a <code>Window</code> class
if all we want to do is trim some lines of text to fit a window.
However,
a real text editor needs to deal with the user resizing the window
(which we will tackle in the exercises),
scrolling (which we tackle below),
and similar events.
By combining the X and Y dimensions of the rendering area in a class now,
we will save ourselves a lot of rewriting later.</p>
<h2 id="editor-object">Section 13.3: An Editor Object</h2>
<p>If we are representing the window as a class,
it&rsquo;s natural to use one for the editor as well.
However,
<code>curses.wrapper</code> requires a function as a starting point.
We can satisfy that need by creating a class with a <code>__call__</code> method
so that instances of the class can be &ldquo;called&rdquo; as if they were functions.
When we do this,
though,
we must use the <span class="ix-entry" ix-key="Delayed Construction pattern" markdown="1"><a class="gl-ref" href="../glossary/#delayed_construction_pattern" markdown="1">Delayed Construction</a></span> design pattern,
because we won&rsquo;t have all the information we need to build the editor object
at the moment that we need to create it.</p>
<p>Let&rsquo;s start by creating the editor class:</p>
<div class="code-sample lang-py" title="editor_class.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Editor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">scr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">The constructor creates variables to hold the screen (which the curses module gives us)
and the window (which will be an instance of our <code>Window</code> class),
but initializes them both to <code>None</code>.</p>
<p>When the object is &ldquo;called&rdquo;
(i.e., when its <code>__call__</code> method is invoked),
it fills in these variables and then starts to interact with the user.
The setup code is:</p>
<div class="code-sample lang-py" title="editor_class.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span> <span class="o">=</span> <span class="n">scr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">curses</span><span class="o">.</span><span class="n">LINES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curses</span><span class="o">.</span><span class="n">COLS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buffer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">nrow</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">ncol</span><span class="p">])</span>
</code></pre></div>
</div>
<p class="continue">and the interaction is:</p>
<div class="code-sample lang-py" title="editor_class.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="s2">&quot;Qq&quot;</span><span class="p">:</span>
                <span class="k">break</span>
</code></pre></div>
</div>
<p>We could test this by reading in a file,
but let&rsquo;s create 1000×1000 characters instead:</p>
<div class="code-sample lang-py" title="editor_class.py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">editor</span> <span class="o">=</span> <span class="n">Editor</span><span class="p">()</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0123456789&#39;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">curses</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div>
</div>
<p>While we&rsquo;re creating a class,
let&rsquo;s build in a lookup table like the one in <a class="x-ref" href="../interpreter/">Chapter 3</a>
that translates characters to actions:</p>
<div class="code-sample lang-py" title="editor_interact.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">,</span>
            <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span>
        <span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">Each action must be a method with no arguments other than <code>self</code>
so that they can be called interchangeably:</p>
<div class="code-sample lang-py" title="editor_interact.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
</div>
<p class="continue">Finally, we modify the <code>interact</code> method to look up actions and execute them:</p>
<div class="code-sample lang-py" title="editor_interact.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">key</span><span class="p">]()</span>
</code></pre></div>
</div>
<h2 id="editor-move">Section 13.4: Moving Around</h2>
<p>Our editor isn&rsquo;t much of an editor right now:
we can&rsquo;t even move around the text,
much less change it.
As first step toward fixing that,
let&rsquo;s define a <code>Cursor</code> class to keep track of the cursor&rsquo;s current location:</p>
<div class="code-sample lang-py" title="editor_move.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Cursor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>
</code></pre></div>
</div>
<p>The editor&rsquo;s constructor creates a variable to hold a cursor
(but doesn&rsquo;t fill it in yet—that will happen in the <code>setup</code> method).
It also adds entries to the action table for the four arrow keys:</p>
<div class="code-sample lang-py" title="editor_move.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">,</span>
            <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">,</span>
            <span class="s2">&quot;KEY_UP&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="p">,</span>
            <span class="s2">&quot;KEY_DOWN&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">down</span><span class="p">,</span>
            <span class="s2">&quot;KEY_LEFT&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span>
            <span class="s2">&quot;KEY_RIGHT&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span>
        <span class="p">}</span>
</code></pre></div>
</div>
<p>Each time we redraw the screen,
we display the cursor at its current location:</p>
<div class="code-sample lang-py" title="editor_move.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">nrow</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">ncol</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">Finally,
the methods that move the cursor change its X and Y coordinates:</p>
<div class="code-sample lang-py" title="editor_move.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">line_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">col</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>This works—until we are at the end of a long line
and try to move up or down to a shorter one.
When we do that,
our X coordinate is past the end of the line we&rsquo;re on.
The solution is to trim the X coordinate each time we move up or down:</p>
<div class="code-sample lang-py" title="editor_move_fixed.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_col</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_col</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">limit_col</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">but the need for this certainly isn&rsquo;t obvious.
As with most software,
we learn what the program needs from the program as we&rsquo;re writing it.</p>
<p>All right:
we can move around the text,
but only around the portion we initially display
(which is the upper left of the whole thing).
We want users to be able to see all the available content,
which means we need to map locations in the text
to locations on the screen.
Let&rsquo;s enhance the <code>Window</code> class to keep track of the top row it&rsquo;s displaying
so that we can scroll vertically
(we&rsquo;ll leave horizontal scrolling as an exercise):</p>
<div class="code-sample lang-py" title="editor_scroll.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Window</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nrow</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ncol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">=</span> <span class="n">nrow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">ncol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>When we display, we show the rows that are currently visible
(<a class="fig-ref" href="../editor/#editor-scrolling">Figure 13.2</a>):</p>
<div class="code-sample lang-py" title="editor_scroll.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
        <span class="n">visible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">row</span> <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">row</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">nrow</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">visible</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">addstr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">ncol</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">))</span>
</code></pre></div>
</div>
<figure id="editor-scrolling">
  <img src="./editor_scrolling.svg" alt="Scrolling text in a window"/>
  <figcaption markdown="1">Figure 13.2: Scrolling text in the editor window.</figcaption>
</figure>

<p>The <code>translate</code> method turns the cursor&rsquo;s position into a content position:</p>
<div class="code-sample lang-py" title="editor_scroll.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">cur</span><span class="o">.</span><span class="n">col</span>
</code></pre></div>
</div>
<p>Finally, we adjust the screen when moving:</p>
<div class="code-sample lang-py" title="editor_scroll.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_col</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">up</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_col</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Keeping track of the coordinate systems and their relation to each other is hard,
in part because we use the same words for both.
(&ldquo;Wait, do you mean the X coordinate in the text,
the X coordinate on the screen,
or the X coordinate of the cursor?&rdquo;)
Diagrams make all of this a lot easier to understand,
since programmers insist on using data formats that are backward compatible with punch cards,
we can&rsquo;t insert diagrams in source files
the way we can insert them into office documents.
Until we can,
there are always tools like <a href="https://asciiflow.com/">ASCIIFlow</a>.</p>
<h2 id="editor-editing">Section 13.5: Editing</h2>
<p>We are finally ready to actually edit something.
Since we&rsquo;re going to be changing the text,
we create a <code>Buffer</code> class to store it.
This class checks that it&rsquo;s being constructed with a list of strings rather than a single string
(because that was a mistake we made several times when writing the code).
It also uses <code>__len__</code> and <code>__getitem__</code> so that it looks like a list,
which means no existing code needs to change:</p>
<div class="code-sample lang-py" title="editor_buffer.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Buffer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</code></pre></div>
</div>
<p>The only significant change to <code>Editor</code> is to ask the buffer what its bottom line is:</p>
<div class="code-sample lang-py" title="editor_buffer.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">.</span><span class="n">bottom</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">That method in the <code>Buffer</code> class is just one line long:</p>
<div class="code-sample lang-py" title="editor_buffer.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p class="continue">Everything we have built so far just works after these changes,
which is a sign of good design.</p>
<p>Now we can define the set of characters that users are allowed to insert.
For now,
we will stick to visible characters plus space;
we will handle newlines, tabs, and so on in the exercises.
We don&rsquo;t define these character classes ourselves:
instead, we rely on Python&rsquo;s <a href="https://docs.python.org/3/library/string.html">string</a> module.</p>
<div class="code-sample lang-py" title="editor_insert.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">string</span>
<span class="n">INSERTABLE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">printable</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot; &quot;</span><span class="p">}</span>
</code></pre></div>
</div>
<p>We could add an action method for each character,
but for now it&rsquo;s simpler to modify <code>interact</code> to handle two cases separately:</p>
<div class="code-sample lang-py" title="editor_insert.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">getkey</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">key</span><span class="p">]()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">INSERTABLE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Finally,
we can go back to the <code>Buffer</code> class and insert the character:</p>
<div class="code-sample lang-py" title="editor_insert.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">current</span><span class="p">[:</span><span class="n">cur</span><span class="o">.</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="n">cur</span><span class="o">.</span><span class="n">col</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">cur</span><span class="o">.</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
</code></pre></div>
</div>
<p>We are now able to edit a file.</p>
<h2 id="editor-exercises">Section 13.6: Exercises</h2>
<h3 class="exercise">Why subtract one?</h3>
<p>Our programs get the number of lines and columns from the curses module
but then subtract 1 from each
to initialize the <code>Window</code> object.
Why do we need to do this?
What happens if we use the number of lines and columns directly?</p>
<h3 class="exercise">Resizing the window</h3>
<p>The curses module tells a program that the user has resized the window
by giving the program a <code>KEY_RESIZE</code> key.
Modify the editor to handle this.</p>
<h3 class="exercise">Horizontal scrolling</h3>
<p>Modify the editor to support horizontal scrolling as well as vertical scrolling.</p>
<h3 class="exercise">Deleting characters</h3>
<p>Modify the editor so that users can delete characters.
What happens if someone tries to delete a character when the cursor is at the start of the line?</p>
<h3 class="exercise">Saving changes</h3>
<p>Modify the editor so that if it was launched by reading a file,
typing Ctrl-W will write (save) that same file.</p>
<h3 class="exercise">Splitting lines</h3>
<p>Modify the editor so that if the user types Enter in the middle of a line,
the line splits.</p>
<h3 class="exercise">Paging</h3>
<p>Use the curses module to create a tool for paging up and down through files
like the Unix <code>less</code> command.</p>
<h3 class="exercise">Marking locations</h3>
<p>Modify the editor so that Ctrl-X records the current location of the cursor
and Ctrl-J jumps the cursor back to that location.</p>
<h3 class="exercise">Status line</h3>
<p>Add a status line to the bottom of the editor
that shows the name of the file currently being edited
and the XY coordinates of the cursor within the text buffer.</p>
<h3 class="exercise">Justify paragraphs</h3>
<p>Modify the editor so that when the user types Ctrl-U
it justifies the text in the current paragraph.</p>
          
        </main>
      </div>
    </div>
  </body>
</html>
